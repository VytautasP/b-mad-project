# Data Models

This section defines the core domain entities that drive TaskFlow's data architecture. These models represent both the Entity Framework Core entities in C# and corresponding TypeScript interfaces shared between frontend and backend. The design emphasizes **normalized relational modeling** to leverage PostgreSQL's strengths while supporting TaskFlow's key features: recursive task hierarchies (FR5), multi-user assignments (FR8), integrated time tracking (FR10-13), and activity logging (FR22).

**Design Principles:**
- **Single Source of Truth:** Each entity has one canonical representation; relationships maintained via foreign keys with referential integrity
- **Self-Referencing Hierarchy:** Task's ParentTaskId enables unlimited nesting (FR5) with PostgreSQL recursive CTEs (NFR19)
- **Many-to-Many via Join Tables:** TaskAssignee and TaskComment enable multi-user relationships without data duplication
- **Audit Trail Built-In:** CreatedDate, ModifiedDate, CreatedByUserId track changes for activity log (FR22)
- **Type Safety:** Enums for Priority, Status, TaskType prevent invalid states; shared TypeScript interfaces ensure frontend-backend contract alignment

## User

**Purpose:** Represents authenticated users who can create tasks, track time, and collaborate with team members. Handles identity, profile information, and serves as the root entity for user-owned data.

**Key Attributes:**
- `Id`: Guid (Primary Key) - Unique user identifier used throughout system
- `Email`: string (unique, indexed) - Login credential, must be unique across system
- `PasswordHash`: string - bcrypt-hashed password via ASP.NET Core Identity (NFR10)
- `Name`: string - Display name shown in UI, task assignments, comments
- `ProfileImageUrl`: string? (nullable) - Supabase Storage URL for avatar image
- `CreatedDate`: DateTime - Account creation timestamp for analytics
- `ModifiedDate`: DateTime - Last profile update for audit trail

**TypeScript Interface:**
```typescript
export interface User {
  id: string;  // Guid as string in TypeScript
  email: string;
  name: string;
  profileImageUrl?: string;
  createdDate: Date;
  modifiedDate: Date;
}

export interface UserCreateDto {
  email: string;
  password: string;
  name: string;
}

export interface UserUpdateDto {
  name?: string;
  profileImageUrl?: string;
}
```

**Relationships:**
- **One-to-Many with Task:** User creates many tasks (Task.CreatedByUserId foreign key)
- **Many-to-Many with Task via TaskAssignee:** Users assigned to multiple tasks, tasks have multiple assignees
- **One-to-Many with TimeEntry:** User logs many time entries across various tasks
- **One-to-Many with Comment:** User authors many comments on tasks
- **One-to-Many with ActivityLog:** User triggers many activity events

**Design Decisions:**
- Password stored as hash only, never plaintext (NFR10 compliance via ASP.NET Core Identity)
- Email used as username for simplicity (single credential to remember)
- ProfileImageUrl nullable allows users without avatars (default avatar generated by initials in UI)
- CreatedDate/ModifiedDate enable "member since" display and profile change tracking

## Task

**Purpose:** Core entity representing work items with unlimited hierarchical nesting. Supports projects, milestones, and individual tasks through Type enumeration and self-referencing ParentTaskId relationship (FR5).

**Key Attributes:**
- `Id`: Guid (Primary Key) - Unique task identifier for API operations
- `Name`: string (required, max 200 chars) - Task title displayed everywhere
- `Description`: string? (nullable, max 5000 chars) - Rich text task details, markdown supported
- `ParentTaskId`: Guid? (nullable, self-referencing FK) - Enables unlimited nesting (FR5), null = root task
- `CreatedByUserId`: Guid (FK to User) - Task owner, establishes data ownership boundary
- `CreatedDate`: DateTime (indexed) - Task creation timestamp for sorting (FR14)
- `ModifiedDate`: DateTime - Last edit timestamp for activity log (FR22)
- `DueDate`: DateTime? (nullable, indexed) - Optional deadline for Gantt view (FR18-20), filtering (FR15)
- `Priority`: Priority enum (Low/Medium/High/Critical) - Urgency indicator for filtering/sorting (FR3, FR14)
- `Status`: Status enum (ToDo/InProgress/Blocked/Waiting/Done) - Workflow state with specific indicators (FR24)
- `Progress`: int (0-100) - Percentage completion, auto-calculated for parent tasks (FR6)
- `Type`: TaskType enum (Project/Milestone/Task) - Semantic categorization for UI rendering (FR3)
- `IsDeleted`: bool (default false) - Soft delete flag preserves referential integrity
- `TotalLoggedTime`: TimeSpan (computed) - Cached rollup of all TimeEntries for performance (FR13)

**TypeScript Interface:**
```typescript
export enum Priority {
  Low = 0,
  Medium = 1,
  High = 2,
  Critical = 3
}

export enum Status {
  ToDo = 0,
  InProgress = 1,
  Blocked = 2,
  Waiting = 3,
  Done = 4
}

export enum TaskType {
  Project = 0,
  Milestone = 1,
  Task = 2
}

export interface Task {
  id: string;
  name: string;
  description?: string;
  parentTaskId?: string;
  createdByUserId: string;
  createdDate: Date;
  modifiedDate: Date;
  dueDate?: Date;
  priority: Priority;
  status: Status;
  progress: number;  // 0-100
  type: TaskType;
  isDeleted: boolean;
  totalLoggedTime: number;  // Seconds for easier calculation
  
  // Navigation properties (loaded on demand)
  parent?: Task;
  children?: Task[];
  assignees?: User[];
  timeEntries?: TimeEntry[];
  comments?: Comment[];
}

export interface TaskCreateDto {
  name: string;
  description?: string;
  parentTaskId?: string;
  dueDate?: Date;
  priority: Priority;
  status: Status;
  type: TaskType;
  assigneeIds?: string[];  // Initial assignees
}

export interface TaskUpdateDto {
  name?: string;
  description?: string;
  parentTaskId?: string;
  dueDate?: Date;
  priority?: Priority;
  status?: Status;
  progress?: number;
  type?: TaskType;
}
```

**Relationships:**
- **Self-Referencing (Parent-Child):** Task.ParentTaskId → Task.Id enables recursive hierarchy (FR5)
- **Many-to-One with User:** Task.CreatedByUserId → User.Id establishes ownership
- **Many-to-Many with User via TaskAssignee:** Multiple users assigned to task (FR8)
- **One-to-Many with TimeEntry:** Task has many time entries from various users (FR12)
- **One-to-Many with Comment:** Task has threaded comment discussions (FR21)
- **One-to-Many with ActivityLog:** Task changes generate activity events (FR22)

**Design Decisions:**
- ParentTaskId nullable enables both root tasks and deeply nested hierarchies without separate tables
- Progress auto-calculated for parents via weighted average of children (FR6) - stored as computed column or application-calculated
- TotalLoggedTime denormalized for performance - updated via EF Core cascade or background job
- IsDeleted soft delete preserves historical data and prevents cascade deletion breaking time tracking reports
- Type enum allows flexible task categorization without rigid "project must contain epic" constraints
- Database indexes on CreatedByUserId, Status, DueDate, ParentTaskId optimize common queries (list view, filtering)

## TaskAssignee

**Purpose:** Join table enabling many-to-many relationship between Tasks and Users for multi-user assignments (FR8, FR9). Supports "My Tasks" filtering and team collaboration features.

**Key Attributes:**
- `TaskId`: Guid (FK to Task, composite PK part 1) - References assigned task
- `UserId`: Guid (FK to User, composite PK part 2) - References assigned user
- `AssignedDate`: DateTime - Timestamp of assignment for activity log (FR22)
- `AssignedByUserId`: Guid (FK to User) - Who made the assignment (team lead tracking)

**TypeScript Interface:**
```typescript
export interface TaskAssignee {
  taskId: string;
  userId: string;
  assignedDate: Date;
  assignedByUserId: string;
}

export interface AssignTaskDto {
  taskId: string;
  userIds: string[];  // Assign multiple users at once
}
```

**Relationships:**
- **Many-to-One with Task:** TaskAssignee.TaskId → Task.Id
- **Many-to-One with User (assignee):** TaskAssignee.UserId → User.Id
- **Many-to-One with User (assigner):** TaskAssignee.AssignedByUserId → User.Id

**Design Decisions:**
- Composite primary key (TaskId, UserId) prevents duplicate assignments
- AssignedDate enables activity log entry "Marcus assigned Sarah to Task X" (FR22)
- AssignedByUserId tracks team lead actions for future permission model
- No additional metadata (role, permission) in MVP - keep simple

## TimeEntry

**Purpose:** Records time tracking events for tasks, supporting both active timer sessions (FR10) and manual time entries (FR11). Enables billable hours tracking and automatic parent task time aggregation (FR13).

**Key Attributes:**
- `Id`: Guid (Primary Key) - Unique time entry identifier
- `TaskId`: Guid (FK to Task, indexed) - Task being tracked, enables fast queries for task time log
- `UserId`: Guid (FK to User, indexed) - User who logged the time
- `StartTime`: DateTime - When timer started or manual entry period begins
- `EndTime`: DateTime? (nullable) - When timer stopped, null = timer still running
- `Duration`: TimeSpan (computed) - Calculated EndTime - StartTime, stored for query performance
- `Notes`: string? (nullable, max 500 chars) - Optional notes for manual entries (e.g., "Client call regarding scope change")
- `IsManual`: bool - Distinguishes timer-tracked (false) vs manual entry (true)
- `CreatedDate`: DateTime - Entry creation timestamp for audit
- `ModifiedDate`: DateTime - Last edit timestamp (manual entries editable)

**TypeScript Interface:**
```typescript
export interface TimeEntry {
  id: string;
  taskId: string;
  userId: string;
  startTime: Date;
  endTime?: Date;
  duration: number;  // Seconds for easier calculation
  notes?: string;
  isManual: boolean;
  createdDate: Date;
  modifiedDate: Date;
  
  // Navigation properties
  task?: Task;
  user?: User;
}

export interface TimeEntryCreateDto {
  taskId: string;
  startTime: Date;
  endTime?: Date;  // Omit for starting active timer
  notes?: string;
  isManual: boolean;
}

export interface TimeEntryUpdateDto {
  endTime?: Date;  // Stop active timer
  notes?: string;
}

export interface ActiveTimerDto {
  timeEntryId: string;
  taskId: string;
  taskName: string;
  startTime: Date;
  elapsedSeconds: number;  // Calculated server-side
}
```

**Relationships:**
- **Many-to-One with Task:** TimeEntry.TaskId → Task.Id enables time log per task (FR12)
- **Many-to-One with User:** TimeEntry.UserId → User.Id attributes time to specific user

**Design Decisions:**
- EndTime nullable enables active timer state (FR10) - null = timer running, client polls for duration
- Duration stored as computed column for performance - avoids calculating on every query
- IsManual flag distinguishes timer (precise to second) vs manual entry (user-entered hours)
- Notes optional for manual entries - timer entries typically have no notes
- StartTime/EndTime stored as UTC, converted to user timezone in frontend
- No cascade delete - if Task deleted, preserve TimeEntries for billing/reporting (soft delete Task instead)

## Comment

**Purpose:** Enables threaded discussions on tasks with user mentions (FR21). Supports activity log integration and edit/delete with author permissions (FR23).

**Key Attributes:**
- `Id`: Guid (Primary Key) - Unique comment identifier
- `TaskId`: Guid (FK to Task, indexed) - Task being discussed
- `UserId`: Guid (FK to User) - Comment author
- `ParentCommentId`: Guid? (nullable, self-referencing FK) - Enables threaded replies (post-MVP nested threads)
- `Content`: string (required, max 2000 chars) - Comment text with markdown support
- `CreatedDate`: DateTime (indexed) - Comment timestamp for sorting
- `ModifiedDate`: DateTime? (nullable) - Last edit timestamp, null = never edited
- `IsDeleted`: bool - Soft delete preserves thread context ("This comment has been deleted")
- `MentionedUserIds`: string (JSON array) - User IDs mentioned with @username for notifications (post-MVP)

**TypeScript Interface:**
```typescript
export interface Comment {
  id: string;
  taskId: string;
  userId: string;
  parentCommentId?: string;
  content: string;
  createdDate: Date;
  modifiedDate?: Date;
  isDeleted: boolean;
  mentionedUserIds: string[];
  
  // Navigation properties
  task?: Task;
  user?: User;
  replies?: Comment[];
}

export interface CommentCreateDto {
  taskId: string;
  content: string;
  parentCommentId?: string;
  mentionedUserIds?: string[];
}

export interface CommentUpdateDto {
  content: string;
}
```

**Relationships:**
- **Many-to-One with Task:** Comment.TaskId → Task.Id creates comment thread per task (FR21)
- **Many-to-One with User:** Comment.UserId → User.Id establishes authorship for permissions (FR23)
- **Self-Referencing (Threaded Replies):** Comment.ParentCommentId → Comment.Id enables reply chains (post-MVP feature)

**Design Decisions:**
- ParentCommentId enables threaded replies but MVP shows flat list (complexity deferred)
- IsDeleted soft delete maintains thread context - show "[deleted]" placeholder in UI
- ModifiedDate nullable distinguishes edited vs original comments - show "edited" badge in UI
- MentionedUserIds stored as JSON array (PostgreSQL JSONB) for future notifications without separate table
- Content max 2000 chars prevents database bloat while allowing detailed discussions
- CreatedDate indexed for efficient chronological sorting in comment threads

## ActivityLog

**Purpose:** Audit trail tracking all significant task changes for activity feed (FR22). Enables "Marcus changed status from In Progress to Done" timeline view and future analytics.

**Key Attributes:**
- `Id`: Guid (Primary Key) - Unique log entry identifier
- `TaskId`: Guid (FK to Task, indexed) - Task that changed
- `UserId`: Guid (FK to User) - User who made the change
- `ActivityType`: ActivityType enum - Categorizes event (Created/StatusChanged/Assigned/TimeLogged/Commented/etc.)
- `Timestamp`: DateTime (indexed) - When event occurred for chronological display
- `Description`: string - Human-readable event summary ("changed status from In Progress to Done")
- `OldValue`: string? (nullable, JSON) - Previous state for undo/history (e.g., "{"status": "InProgress"}")
- `NewValue`: string? (nullable, JSON) - New state after change (e.g., "{"status": "Done"}")
- `Metadata`: string? (nullable, JSON) - Additional context (e.g., assigned user names, time duration)

**TypeScript Interface:**
```typescript
export enum ActivityType {
  TaskCreated = 0,
  TaskUpdated = 1,
  StatusChanged = 2,
  PriorityChanged = 3,
  AssigneeAdded = 4,
  AssigneeRemoved = 5,
  TimeLogged = 6,
  CommentAdded = 7,
  CommentEdited = 8,
  CommentDeleted = 9,
  DueDateChanged = 10,
  ParentChanged = 11
}

export interface ActivityLog {
  id: string;
  taskId: string;
  userId: string;
  activityType: ActivityType;
  timestamp: Date;
  description: string;
  oldValue?: string;  // JSON string
  newValue?: string;  // JSON string
  metadata?: string;  // JSON string
  
  // Navigation properties
  task?: Task;
  user?: User;
}
```

**Relationships:**
- **Many-to-One with Task:** ActivityLog.TaskId → Task.Id creates activity timeline per task (FR22)
- **Many-to-One with User:** ActivityLog.UserId → User.Id attributes action to specific user

**Design Decisions:**
- ActivityType enum enables filtering ("show me only status changes") and icon rendering in UI
- Description pre-formatted on backend - frontend just displays ("Sarah assigned Marcus to QA Testing")
- OldValue/NewValue as JSON enables rich diff views ("Status: To Do → In Progress") without separate columns per field
- Metadata JSON stores contextual info (assignee names, time duration) avoiding complex joins for display
- Timestamp indexed for efficient "recent activity" queries with pagination
- No cascade delete - preserve activity history even if Task/User deleted (audit requirement)
- Background service or EF Core interceptor auto-creates entries on entity changes

---

**Data Model Summary:**

The TaskFlow data model consists of **6 core entities** with **11 relationships** that support all PRD requirements:

- **User** (authentication, profile)
- **Task** (recursive hierarchy with self-referencing ParentTaskId)
- **TaskAssignee** (join table for multi-user assignment)
- **TimeEntry** (timer and manual time tracking)
- **Comment** (task discussions with future threading)
- **ActivityLog** (audit trail for all changes)

**Key Design Features:**
- Recursive CTEs via Task.ParentTaskId fulfill NFR19 for efficient hierarchy queries
- Normalized relational design leverages PostgreSQL's ACID transactions and referential integrity
- Soft deletes (IsDeleted flags) preserve data integrity for reporting while appearing deleted in UI
- Computed/cached columns (TotalLoggedTime, Duration) optimize read-heavy operations
- JSON fields (MentionedUserIds, Metadata) provide flexibility without schema changes for evolving features
- Composite keys (TaskAssignee) and indexes (CreatedByUserId, Status, DueDate) optimize common query patterns

These TypeScript interfaces will be auto-generated from C# entities using NSwag or TypeScript Generator, ensuring frontend-backend contract alignment and preventing API desync bugs.

