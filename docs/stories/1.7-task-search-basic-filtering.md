# Story 1.7: Task Search and Basic Filtering

## Status

Ready for Review

## Story

**As a** user,
**I want** to search my tasks by text and filter by status,
**so that** I can quickly find specific tasks in a growing list.

## Story Context

**Existing System Integration:**
- Integrates with: Task API GET /api/tasks endpoint from Story 1.4
- Integrates with: Existing task-list component (Story 1.5) and TaskService
- Technology: Angular 20 standalone components, Angular Material 20, RxJS, TypeScript 5.9.3
- Follows pattern: Container/Presentational component pattern, reactive forms, RxJS debounceTime for search
- Touch points:
  - TaskService (modify getTasks method to support search and status query parameters)
  - TaskListComponent (add search input and status filter dropdown)
  - Backend TasksController GET /api/tasks endpoint (add query parameter support)
  - Backend TaskRepository GetUserTasksAsync (add filtering logic with EF Core Contains)
  - HTTP Interceptor for auth (already exists from Story 1.3)

## Acceptance Criteria

**Functional Requirements:**

1. Search box added to dashboard above task list with placeholder "Search tasks..."
2. Search functionality filters tasks by Name and Description containing search term (case-insensitive)
3. Search executes on keystroke with debounce (300ms delay) to avoid excessive API calls
4. Status filter dropdown added next to search box (options: All, To Do, In Progress, Blocked, Waiting, Done)
5. Selecting status filters task list to show only tasks with that status
6. Search and status filter work together (both criteria applied simultaneously)

**Integration Requirements:**

7. Backend API endpoint supports query parameters: ?search=term&status=InProgress
8. Full-text search performed on backend via EF Core Contains() or SQL LIKE query
9. Search/filter state persists during session (user navigates away and back, filters remain)
10. Clear search button (X icon) resets search term

**Quality Requirements:**

11. Task count displayed showing filtered results (e.g., "Showing 5 of 12 tasks")
12. Performance acceptableâ€”search returns results in <500ms for 500 tasks
13. Change is covered by appropriate unit tests
14. No regression in existing functionality verified

## Tasks / Subtasks

- [ ] **Task 1: Update Backend TaskRepository for Search/Filter** (AC: 7, 8, 12)
  - [ ] Modify `GetUserTasksAsync` method in TaskRepository to accept optional `string? searchTerm` parameter
  - [ ] Add filtering logic: if searchTerm is not null/empty, filter using EF Core `.Contains()` on Name and Description
  - [ ] Use case-insensitive search: `EF.Functions.ILike(t.Name, $"%{searchTerm}%")` or `.Contains()` which is case-insensitive by default
  - [ ] Ensure existing status filter parameter continues to work
  - [ ] Maintain existing sort order (OrderByDescending CreatedDate)
  - [ ] Test with sample data to ensure performance is acceptable

- [ ] **Task 2: Update Backend TasksController Endpoint** (AC: 7)
  - [ ] Modify `GetUserTasks` action method signature to accept `[FromQuery] string? search` parameter
  - [ ] Pass search parameter to TaskService method
  - [ ] Maintain existing status parameter support
  - [ ] Ensure query parameters are optional (both null by default)
  - [ ] Test endpoint manually using Swagger UI or HTTP client

- [ ] **Task 3: Update Backend TaskService** (AC: 7)
  - [ ] Modify `GetUserTasksAsync` method signature to accept `string? searchTerm` parameter
  - [ ] Pass searchTerm to repository method
  - [ ] Maintain existing business logic (authorization, mapping)
  - [ ] Add logging for search operations (optional)

- [ ] **Task 4: Update Frontend TaskService for Query Parameters** (AC: 3, 6, 7)
  - [ ] Modify `getTasks()` method signature to accept optional `search?: string` and `status?: TaskStatus` parameters
  - [ ] Build HttpParams with search and status query parameters when provided
  - [ ] Ensure parameters are only added to query string if they have values
  - [ ] Return Observable<Task[]> as before
  - [ ] Test service method with various parameter combinations

- [ ] **Task 5: Create Search Input Component in Task List** (AC: 1, 2, 3, 10)
  - [ ] Add search input field using mat-form-field and mat-input above task table
  - [ ] Add placeholder text: "Search tasks..."
  - [ ] Add mat-icon for search icon (prefix icon)
  - [ ] Add clear button (X icon suffix) that appears when search has value
  - [ ] Wire input to FormControl
  - [ ] Use RxJS `debounceTime(300)` on valueChanges observable
  - [ ] Emit search event to parent container component
  - [ ] Clear button resets FormControl value and emits empty search

- [ ] **Task 6: Create Status Filter Dropdown in Task List** (AC: 4, 5, 6)
  - [ ] Add mat-select dropdown next to search box
  - [ ] Options: All (null value), To Do (0), In Progress (1), Blocked (2), Waiting (3), Done (4)
  - [ ] Default selection: "All"
  - [ ] Wire select to FormControl
  - [ ] On selection change, emit status filter event to parent container
  - [ ] Style dropdown consistently with search input

- [ ] **Task 7: Integrate Search and Filter in TaskListComponent** (AC: 3, 6, 9, 11)
  - [ ] Add `searchTerm: string = ''` and `statusFilter: TaskStatus | null = null` properties
  - [ ] Handle search input event: update searchTerm and call loadTasks()
  - [ ] Handle status filter event: update statusFilter and call loadTasks()
  - [ ] Modify `loadTasks()` to pass search and status parameters to TaskService.getTasks()
  - [ ] Store filter state in component properties (session persistence)
  - [ ] Calculate and display task count: "Showing X of Y tasks" (X = filtered count, Y = total if available)
  - [ ] If backend doesn't return total count yet, display "Showing X tasks"

- [ ] **Task 8: Session State Persistence** (AC: 9)
  - [ ] Consider using a service or localStorage to persist search/filter state
  - [ ] For MVP, keeping state in component is sufficient (user navigates away, state lost)
  - [ ] Alternative: Use Angular Router query parameters to persist state in URL
  - [ ] Implement simple solution: store in TaskListComponent properties (resets on navigation)

- [ ] **Task 9: Error Handling and Edge Cases** (AC: 2, 12)
  - [ ] Handle empty search results: display message "No tasks match your search"
  - [ ] Handle API errors gracefully with MatSnackBar
  - [ ] Handle special characters in search term (backend should handle safely via parameterized query)
  - [ ] Test with very long search terms (trim if necessary)
  - [ ] Ensure debounce prevents API spam during rapid typing

- [ ] **Task 10: Styling and UX Polish** (AC: 1, 4, 10, 11)
  - [ ] Style search box and filter dropdown using Angular Material theme
  - [ ] Position search and filter inline at top of task list (use CSS Flexbox)
  - [ ] Add spacing between search box and dropdown
  - [ ] Ensure responsive layout (stack vertically on mobile if needed)
  - [ ] Add smooth transition/animation when task list updates
  - [ ] Show loading indicator during search (reuse existing mat-spinner)

- [ ] **Task 11: Testing** (AC: 13, 14)
  - [ ] Write unit tests for TaskRepository search logic
  - [ ] Write unit tests for TaskService with search/filter parameters
  - [ ] Write unit tests for TasksController with query parameters
  - [ ] Write unit tests for frontend TaskService.getTasks() with parameters
  - [ ] Write unit tests for TaskListComponent search and filter handlers
  - [ ] Test debounce behavior (verify API not called until 300ms after last keystroke)
  - [ ] Test combined search + status filter scenario
  - [ ] Test clear search button functionality
  - [ ] Verify no regression in existing task creation/edit/delete functionality from Stories 1.5-1.6
  - [ ] Aim for >80% code coverage on new code

## Dev Notes

### Technical Context

This story adds search and filter capabilities to the existing task management system from Stories 1.5-1.6. It extends both the backend API and frontend components to support query parameters for filtering tasks.

**Key Dependencies:**
- Story 1.4: Task API provides GET /api/tasks endpoint (will be enhanced with query params)
- Story 1.5: TaskListComponent and TaskService exist and fetch tasks
- Story 1.6: Edit/delete functionality should continue working with filtered views

### Relevant Architecture

**Backend Filtering Pattern (from 11-backend-architecture.md):**
- Use EF Core `.Where()` clauses to filter at database level
- Use `.Contains()` for text search (case-insensitive by default in EF Core with SQL Server/PostgreSQL)
- Apply filters before `.ToListAsync()` to optimize query performance
- Example pattern:
  ```csharp
  var query = _context.Tasks
      .AsNoTracking()
      .Where(t => t.CreatedByUserId == userId && !t.IsDeleted);
  
  if (!string.IsNullOrEmpty(searchTerm))
      query = query.Where(t => t.Name.Contains(searchTerm) || t.Description.Contains(searchTerm));
  
  if (status.HasValue)
      query = query.Where(t => t.Status == status.Value);
  
  return await query.OrderByDescending(t => t.CreatedDate).ToListAsync(ct);
  ```

**Frontend RxJS Debounce Pattern (from frontend-architecture.md):**
- Use `debounceTime(300)` on FormControl valueChanges observable
- Prevents excessive API calls during user typing
- Example:
  ```typescript
  this.searchControl.valueChanges.pipe(
    debounceTime(300),
    distinctUntilChanged()
  ).subscribe(searchTerm => {
    this.onSearch(searchTerm);
  });
  ```

**Component Structure:**
- TaskListComponent (container/smart) handles search/filter state and API calls
- Search input and filter dropdown are inline in template (or could be separate presentational components)
- Use Angular Material form controls for consistent styling

**Query Parameter Pattern:**
- Frontend: Use HttpParams to build query string
- Backend: Use `[FromQuery]` attribute on action method parameters
- Optional parameters should be nullable types (`string?`, `TaskStatus?`)

### Existing Code References

**Current TaskRepository.GetUserTasksAsync signature:**
```csharp
public async Task<List<TaskEntity>> GetUserTasksAsync(
    Guid userId, 
    TaskStatus? status, 
    CancellationToken ct = default)
```

**Current TasksController.GetUserTasks signature:**
```csharp
[HttpGet]
public async Task<IActionResult> GetUserTasks(
    [FromQuery] TaskStatus? status, 
    CancellationToken ct)
```

**Current Frontend TaskService.getTasks signature:**
```typescript
getTasks(): Observable<Task[]>
```

### Testing Standards

**Backend Tests:**
- Location: `backend/TaskFlow.Tests/Unit/` for unit tests, `backend/TaskFlow.Tests/Integration/` for integration tests
- Framework: xUnit + Moq for mocking
- Test EF Core queries with in-memory database or mock DbContext
- Verify SQL query generation is optimal (use logging or profiler)

**Frontend Tests:**
- Location: Test files alongside components (`*.component.spec.ts`)
- Framework: Jasmine + Karma
- Mock TaskService using jasmine.createSpyObj
- Test debounce behavior using `fakeAsync` and `tick()`
- Test FormControl value changes and component state updates

**Coverage Goal:** >80% code coverage on all new/modified code

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Initial story creation | Sarah (PO) |
