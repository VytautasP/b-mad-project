# Story 2.3: Drag-and-Drop Task Reparenting

## Status

Draft

## Story

**As a** user,
**I want** to drag tasks in the tree view to change their parent,
**so that** I can reorganize my project structure easily.

## Acceptance Criteria

1. Drag-and-drop functionality enabled on tree view nodes using Angular CDK Drag-Drop or tree library's built-in support
2. Dragging task shows visual feedback (ghost image, drop zones highlighted)
3. Dropping task on valid parent updates ParentTaskId via API PUT /api/tasks/:id/parent
4. Dropping task on root area (not on another task) removes parent (sets ParentTaskId to null)
5. Invalid drop targets prevented (cannot drop task on itself or its descendants)
6. Visual indicators show valid vs. invalid drop zones during drag
7. Successful reparenting updates tree view immediately without full page reload
8. API validation prevents circular references and enforces depth limit during reparenting
9. Error messages displayed for invalid reparenting attempts ("Cannot move task under its own child")
10. Undo toast notification displayed after reparenting with "Undo" action (optional enhancement)
11. Drag-and-drop works smoothly without lag for trees with 50+ tasks
12. Mobile users have alternative method to reparent tasks (edit form with parent selector dropdown)

## Tasks / Subtasks

- [ ] **Task 1: Install and Configure Angular CDK Drag-Drop** (AC: 1)
  - [ ] Verify @angular/cdk is installed (already in dependencies)
  - [ ] Import DragDropModule in TaskTreeComponent or parent module
  - [ ] Review Angular CDK Drag-Drop documentation for tree implementation patterns
  - [ ] Plan integration with existing Angular Material Tree structure

- [ ] **Task 2: Implement Drag-Drop on Tree Nodes** (AC: 1, 2, 5, 6, 11)
  - [ ] Add `cdkDrag` directive to tree node elements in task-tree.component.html
  - [ ] Add `cdkDropList` directive to tree container or each parent node
  - [ ] Configure drag preview template for visual feedback (ghost image)
  - [ ] Implement `cdkDragStarted` handler to track dragged task
  - [ ] Implement `cdkDragEntered` handler to highlight valid/invalid drop zones
  - [ ] Implement `cdkDragExited` handler to remove drop zone highlights
  - [ ] Add CSS classes for drag states: dragging, valid-drop-target, invalid-drop-target
  - [ ] Implement `cdkDragPredicate` to prevent dragging parent onto itself or descendants
  - [ ] Optimize for performance with 50+ tasks (use `trackBy` function, debounce if needed)

- [ ] **Task 3: Handle Drop Events** (AC: 3, 4, 7)
  - [ ] Implement `cdkDropped` event handler in TaskTreeComponent
  - [ ] Extract dropped task ID and target parent ID from event
  - [ ] Distinguish between dropping on a task (set as parent) vs. dropping on root area (remove parent)
  - [ ] Call TaskService.setParentTask(taskId, parentTaskId) for reparenting
  - [ ] Call TaskService.removeParent(taskId) for dropping on root
  - [ ] Update local tree data structure immediately (optimistic update)
  - [ ] Refresh tree view to reflect new hierarchy without full page reload
  - [ ] Handle API errors and revert optimistic update on failure

- [ ] **Task 4: Create TaskService Reparenting Methods** (AC: 3, 4, 8)
  - [ ] Add `setParentTask(taskId: string, parentTaskId: string): Observable<void>` to TaskService
  - [ ] Implement PUT /api/tasks/:id/parent API call with SetParentDto body
  - [ ] Add `removeParent(taskId: string): Observable<void>` to TaskService
  - [ ] Implement DELETE /api/tasks/:id/parent API call
  - [ ] Map API responses and errors appropriately
  - [ ] Ensure Authorization header included via HTTP interceptor

- [ ] **Task 5: Implement Validation and Error Handling** (AC: 5, 8, 9)
  - [ ] Client-side validation: prevent dropping task on itself
  - [ ] Client-side validation: prevent dropping task on its descendants (check tree structure)
  - [ ] Display error toast notification for validation failures
  - [ ] Handle API validation errors (circular reference, depth limit exceeded)
  - [ ] Parse API error messages and display user-friendly notifications
  - [ ] Log errors for debugging purposes

- [ ] **Task 6: Add Undo Functionality** (AC: 10)
  - [ ] Install or use existing notification/toast library (Angular Material Snackbar)
  - [ ] After successful reparenting, show toast with "Undo" action button
  - [ ] Store previous parent ID before reparenting
  - [ ] Implement undo handler that calls setParentTask/removeParent with previous value
  - [ ] Toast auto-dismisses after 5 seconds
  - [ ] Undo action dismisses toast immediately

- [ ] **Task 7: Mobile Alternative for Reparenting** (AC: 12)
  - [ ] Add "Change Parent" button to task detail panel/form
  - [ ] Create parent selector dropdown showing all tasks except self and descendants
  - [ ] Dropdown includes "None" option to remove parent
  - [ ] Submit form calls same TaskService reparenting methods
  - [ ] Show success/error notifications same as drag-drop flow
  - [ ] Consider detecting mobile viewport and hiding drag-drop handles on small screens

- [ ] **Task 8: Add Visual Indicators** (AC: 2, 6)
  - [ ] Style drag preview (ghost image) with semi-transparent background
  - [ ] Add drop zone highlight with border/background color change
  - [ ] Use distinct colors for valid (green) vs. invalid (red) drop zones
  - [ ] Add cursor styles (grabbing, not-allowed) for drag states
  - [ ] Ensure visual feedback is clear and accessible (WCAG 2.1 color contrast)

- [ ] **Task 9: Write Component Tests** (AC: All)
  - [ ] Create tests in task-tree.component.spec.ts:
    - [ ] Test drag-drop handlers are called correctly
    - [ ] Test setParentTask API is called with correct parameters
    - [ ] Test removeParent API is called when dropping on root
    - [ ] Test validation prevents invalid drops (self, descendants)
    - [ ] Test error handling displays notifications
    - [ ] Test undo functionality restores previous parent
  - [ ] Mock TaskService and toast notification service
  - [ ] Use Angular CDK testing utilities for drag-drop simulation

- [ ] **Task 10: Manual Testing** (AC: 11, 12)
  - [ ] Test drag-drop with various tree structures (2-5 levels deep)
  - [ ] Test performance with 50+ tasks in tree
  - [ ] Test all validation scenarios (circular reference, depth limit, self-drop)
  - [ ] Test mobile view and alternative reparenting method
  - [ ] Test keyboard accessibility (drag-drop may not be keyboard accessible, ensure mobile alternative works)
  - [ ] Test with different browsers (Chrome, Firefox, Safari)

## Dev Notes

### Story Context

This story builds directly on Story 2.2 (Task Tree Visualization), which implemented the TaskTreeComponent using Angular Material Tree. Story 2.1 (Recursive Hierarchy Backend Support) already implemented the backend API endpoints needed for reparenting:
- PUT /api/tasks/:id/parent (set parent)
- DELETE /api/tasks/:id/parent (remove parent)

These endpoints include validation for circular references and depth limits (max 15 levels).

### Existing System Integration

**Frontend Component to Enhance:**
- File: [src/app/features/tasks/task-tree/task-tree.component.ts](src/app/features/tasks/task-tree/task-tree.component.ts)
- File: [src/app/features/tasks/task-tree/task-tree.component.html](src/app/features/tasks/task-tree/task-tree.component.html)
- File: [src/app/features/tasks/task-tree/task-tree.component.scss](src/app/features/tasks/task-tree/task-tree.component.scss)

**Service to Extend:**
- File: [src/app/core/services/task.service.ts](src/app/core/services/task.service.ts)
- Add methods: `setParentTask()`, `removeParent()`

**Backend API Endpoints (Already Implemented in Story 2.1):**
- PUT /api/tasks/:id/parent (body: { parentTaskId: string })
- DELETE /api/tasks/:id/parent
- Validation: Circular reference prevention, depth limit (15 levels)

**Technology Stack:**
- **Drag-Drop Library**: Angular CDK Drag-Drop (already installed as @angular/cdk dependency)
- **Tree Library**: Angular Material Tree (already used in Story 2.2)
- **Notifications**: Angular Material Snackbar (already available)
- **HTTP**: Angular HttpClient with interceptor for auth

**Existing Pattern to Follow:**
- TaskTreeComponent follows standalone component pattern
- Services use RxJS Observables
- Error handling via centralized HTTP interceptor
- Toast notifications via Angular Material Snackbar

### Key Constraints

1. **Integration with Angular Material Tree**: The drag-drop must work seamlessly with the existing tree structure. Angular CDK Drag-Drop can be integrated with custom tree implementations.

2. **Client-Side Validation**: Before calling API, validate that:
   - Task is not being dropped on itself
   - Task is not being dropped on its descendants (would create cycle)
   - This requires traversing the local tree structure

3. **Optimistic Updates**: Update the UI immediately after drop, then call API. Revert if API fails.

4. **Performance**: With 50+ tasks, ensure drag-drop is smooth:
   - Use `trackBy` function in tree rendering
   - Minimize DOM manipulations during drag
   - Consider virtual scrolling if performance issues arise (defer to future story)

5. **Accessibility**: Drag-drop is not keyboard accessible by default. The mobile alternative (parent selector dropdown) also serves as the accessible alternative for keyboard users.

6. **Undo Complexity**: Undo is marked as "optional enhancement" in AC 10. Implement if time permits, otherwise defer to future story.

### Testing

**Testing Standards:**
- **Test Location**: [src/app/features/tasks/task-tree/task-tree.component.spec.ts](src/app/features/tasks/task-tree/task-tree.component.spec.ts)
- **Framework**: Jasmine + Karma (Angular default)
- **Patterns**:
  - Use Angular CDK drag-drop testing utilities for simulating drag-drop
  - Mock TaskService using Jasmine spies
  - Mock MatSnackBar for notification testing
  - Test component logic, not DOM manipulation details
  - Focus on: validation logic, API calls, error handling, undo functionality
  
**Testing Approach:**
- Unit tests for component logic (validation, event handlers)
- Mock external dependencies (TaskService, MatSnackBar)
- Use Angular testing utilities (TestBed, ComponentFixture)
- Aim for 80%+ code coverage on new drag-drop logic

### Technical Notes

**Drag-Drop Implementation Approach:**
1. Add `cdkDropList` to tree container
2. Add `cdkDrag` to each tree node
3. Use `cdkDropListConnectedTo` for nested drop lists (parent nodes)
4. Implement custom drop logic in `cdkDropped` handler
5. Use CSS for visual feedback

**Alternative Considered:**
- @circlon/angular-tree-component has built-in drag-drop support, but we're already using Angular Material Tree from Story 2.2. Adding another library would increase bundle size. Stick with Angular CDK Drag-Drop for consistency.

**Validation Logic:**
```typescript
// Check if targetParentId is a descendant of draggedTaskId
function isDescendant(taskId: string, potentialDescendantId: string, tree: TaskNode[]): boolean {
  // Traverse tree recursively
  // Return true if potentialDescendantId found in subtree of taskId
}
```

**API Error Responses (from Story 2.1):**
- 400 Bad Request: Circular reference, depth limit exceeded
- 404 Not Found: Task or parent task not found
- 403 Forbidden: User doesn't own task

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Initial story creation | Sarah (PO Agent) |