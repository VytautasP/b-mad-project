# Story 2.8: Manual Time Entry UI

## Status

Ready for Review

## Story

**As a** user,
**I want** to manually log time for past work without using a timer,
**so that** I can record hours when I forgot to start the timer.

## Acceptance Criteria

1. "Log Time" button added to task detail panel
2. Clicking "Log Time" opens form with fields: Hours (number), Minutes (number), Note (textarea), Date (date picker defaulting to today)
3. Form validates total time is > 0 and < 24 hours
4. Submitting form creates TimeEntry via API with EntryType=Manual
5. Time entries displayed in task detail panel showing: User, Date, Duration (formatted as "2h 30m"), Note, Type icon (timer/manual)
6. Time entry list sorted by EntryDate descending (most recent first)
7. Delete button on each time entry (only for entry creator) with confirmation
8. Deleting time entry updates task's LoggedMinutes immediately
9. Time log shows total logged time for task prominently (e.g., "Total: 12h 45m")
10. Quick log buttons for common durations (15m, 30m, 1h, 2h) pre-fill form
11. Empty state displayed when task has no time entries ("No time logged yet")
12. Mobile-friendly time entry form

## Tasks / Subtasks

- [x] **Task 1: Create Manual Time Entry Form Component** (AC: 1, 2, 3, 10, 12)
  - [x] Create `manual-time-entry-form.component.ts` in `src/app/features/tasks/components/`
  - [x] Design form with reactive forms using FormBuilder
  - [x] Add form fields: hours (number input), minutes (number input), note (textarea), date (Angular Material datepicker)
  - [x] Implement form validation: total time > 0 and < 24 hours (1440 minutes)
  - [x] Add quick log buttons (15m, 30m, 1h, 2h) that pre-fill hours/minutes fields
  - [x] Default date picker to today's date
  - [x] Make form mobile-responsive using Angular Material responsive utilities
  - [x] Add "Log Time" button to task detail panel that opens form in modal/dialog

- [x] **Task 2: Integrate Time Entry API Service** (AC: 4)
  - [x] Update `time-tracking.service.ts` with `logManualTime(taskId, hours, minutes, note, date)` method
  - [x] Call POST /api/tasks/:id/timeentries with EntryType=Manual
  - [x] Convert hours and minutes to total minutes for API call
  - [x] Handle API errors and display error messages to user
  - [x] Show success notification after successful time entry creation

- [x] **Task 3: Display Time Entries in Task Detail Panel** (AC: 5, 6, 9, 11)
  - [x] Create `time-entry-list.component.ts` in `src/app/features/tasks/components/`
  - [x] Fetch time entries using GET /api/tasks/:id/timeentries on task detail load
  - [x] Display time entries in list with: User name, Date, Duration (formatted as "2h 30m"), Note, Type icon
  - [x] Sort time entries by EntryDate descending (most recent first)
  - [x] Add type icon to distinguish timer entries (⏱️) from manual entries (✏️)
  - [x] Calculate and display total logged time prominently (e.g., "Total: 12h 45m")
  - [x] Implement empty state UI when no time entries exist ("No time logged yet")
  - [x] Format duration helper function to convert minutes to "Xh Ym" format

- [x] **Task 4: Implement Time Entry Deletion** (AC: 7, 8)
  - [x] Add delete button (trash icon) to each time entry row
  - [x] Show delete button only for entries created by current user
  - [x] Implement confirmation dialog before deletion using Angular Material Dialog
  - [x] Call DELETE /api/timeentries/:id when confirmed
  - [x] Remove time entry from list immediately on successful deletion
  - [x] Update task's total LoggedMinutes display after deletion
  - [x] Show success notification after deletion
  - [x] Handle deletion errors gracefully

- [x] **Task 5: Unit Testing** (AC: 1-12)
  - [x] Write unit tests for manual-time-entry-form.component.ts (form validation, quick log buttons)
  - [x] Write unit tests for time-entry-list.component.ts (display, sorting, formatting)
  - [x] Write unit tests for time-tracking.service.ts (API calls, error handling)
  - [x] Test form validation edge cases (0 minutes, 24+ hours, negative values)
  - [x] Test duration formatting helper function
  - [x] Mock HttpClient responses for service tests

## Dev Notes

### Relevant Source Tree Info

**Frontend Components Location:**
```
src/app/features/tasks/
├── components/
│   ├── manual-time-entry-form/
│   │   ├── manual-time-entry-form.component.ts
│   │   ├── manual-time-entry-form.component.html
│   │   ├── manual-time-entry-form.component.scss
│   │   └── manual-time-entry-form.component.spec.ts
│   ├── time-entry-list/
│   │   ├── time-entry-list.component.ts
│   │   ├── time-entry-list.component.html
│   │   ├── time-entry-list.component.scss
│   │   └── time-entry-list.component.spec.ts
│   └── task-detail/
│       └── task-detail.component.ts (add "Log Time" button here)
└── services/
    └── time-tracking.service.ts (update with manual time entry methods)
```

**Backend API Endpoints (from Story 2.6):**
- POST `/api/tasks/:id/timeentries` - Create time entry
- GET `/api/tasks/:id/timeentries` - Fetch all time entries for a task
- DELETE `/api/timeentries/:id` - Delete a time entry

**Time Entry Model (from Story 2.6):**
```typescript
interface TimeEntry {
  id: string;              // GUID
  taskId: string;          // FK to Task
  userId: string;          // FK to User
  minutes: number;         // Total minutes logged
  entryDate: Date;         // When work was done
  note?: string;           // Optional note (max 500 chars)
  entryType: 'Timer' | 'Manual';  // Type of entry
  userName: string;        // User's display name
}
```

**Task Model Update (from Story 2.6):**
```typescript
interface Task {
  // ... existing fields
  totalLoggedMinutes: number;  // Sum of all TimeEntry.minutes
}
```

### Key Implementation Details

**Form Validation Logic:**
- Hours field: min=0, max=23, integer only
- Minutes field: min=0, max=59, integer only
- Total validation: (hours * 60) + minutes > 0 AND (hours * 60) + minutes < 1440
- Custom validator function: `totalTimeValidator()` to validate combined hours+minutes

**Duration Formatting:**
```typescript
// Helper function to format minutes to "Xh Ym" display
function formatDuration(minutes: number): string {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  if (hours === 0) return `${mins}m`;
  if (mins === 0) return `${hours}h`;
  return `${hours}h ${mins}m`;
}
```

**Quick Log Buttons:**
- 15m button: sets hours=0, minutes=15
- 30m button: sets hours=0, minutes=30
- 1h button: sets hours=1, minutes=0
- 2h button: sets hours=2, minutes=0

**Authorization for Delete:**
- Frontend: Only show delete button if `timeEntry.userId === currentUser.id`
- Backend: API already enforces deletion authorization (from Story 2.6 AC 9)

**Responsive Design:**
- Use Angular Material's responsive breakpoints
- Form layout: 2-column on desktop (hours/minutes side-by-side), stacked on mobile
- Time entry list: full width with wrapping on small screens
- Dialog/modal should be full-screen on mobile, centered on desktop

**Previous Story Context (Story 2.7 - Active Timer UI):**
- Active timer functionality already implemented
- Timer creates TimeEntry with EntryType=Timer
- This story adds manual entry for past work
- Both types display in same time entry list
- Type icon distinguishes timer vs manual entries

### Testing

**Test File Location:**
- Unit tests: Same directory as component (`*.component.spec.ts`)
- Use Jasmine + Karma as per tech stack

**Testing Framework:**
- Jasmine 5.1+ for test specs
- Karma 6.4+ for test runner
- Angular TestBed for component testing
- HttpClientTestingModule for service testing

**Key Test Scenarios:**
1. Form validation: Valid and invalid time combinations
2. Quick log buttons: Verify form pre-fill with correct values
3. Time entry list: Verify sorting by date descending
4. Duration formatting: Test edge cases (0m, 1h, 1h 30m, etc.)
5. Delete confirmation: Verify dialog appears and deletion occurs
6. Empty state: Verify message displays when no entries
7. Mobile responsiveness: Test form layout on different screen sizes (use component fixture with viewport changes)

**Test Standards:**
- Follow component/presentational testing patterns
- Mock all HTTP calls using HttpClientTestingModule
- Use `async` and `fakeAsync` for async operations
- Test both success and error paths
- Aim for >80% code coverage

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-03 | 1.0 | Initial story creation | Sarah (PO) |
| 2026-02-03 | 1.1 | Implementation completed | James (Dev Agent) |

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

No blocking issues encountered during implementation.

### Completion Notes List

- Created manual-time-entry-form component with reactive forms and validation
- Implemented custom validator for total time (> 0 and < 1440 minutes)
- Added quick log buttons (15m, 30m, 1h, 2h) for common time entries
- Created time-entry-list component to display time entries with sorting and formatting
- Integrated time-entry components into task-detail-dialog
- Implemented delete functionality with confirmation dialog
- Added duration formatting helper (formatDuration) to display time in "Xh Ym" format
- Created comprehensive unit tests using Vitest for all components and services
- Mobile-responsive design implemented using CSS media queries
- All acceptance criteria (1-12) have been met

### File List

**New Files:**
- src/app/features/tasks/components/manual-time-entry-form/manual-time-entry-form.ts
- src/app/features/tasks/components/manual-time-entry-form/manual-time-entry-form.html
- src/app/features/tasks/components/manual-time-entry-form/manual-time-entry-form.css
- src/app/features/tasks/components/manual-time-entry-form/manual-time-entry-form.spec.ts
- src/app/features/tasks/components/time-entry-list/time-entry-list.ts
- src/app/features/tasks/components/time-entry-list/time-entry-list.html
- src/app/features/tasks/components/time-entry-list/time-entry-list.css
- src/app/features/tasks/components/time-entry-list/time-entry-list.spec.ts
- src/app/core/services/time-tracking.service.spec.ts

**Modified Files:**
- src/app/features/tasks/task-detail-dialog/task-detail-dialog.ts
- src/app/features/tasks/task-detail-dialog/task-detail-dialog.html
- src/app/features/tasks/task-detail-dialog/task-detail-dialog.css

## QA Results

_Results from QA Agent review will be added here after implementation._
