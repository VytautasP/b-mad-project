# Story 2.4: Multi-Assignment Backend System

## Status

Approved

## Story

**As a** team lead,
**I want** to assign tasks to multiple team members simultaneously,
**so that** I can reflect shared responsibility and collaborative work.

## Acceptance Criteria

1. TaskAssignment entity created with fields: TaskId (FK), UserId (FK), AssignedDate, AssignedByUserId (FK—who made the assignment)
2. Many-to-many relationship configured between Task and User via TaskAssignment junction table
3. Database migration created for TaskAssignment table with composite primary key (TaskId, UserId)
4. TaskService methods created: AssignUser(taskId, userId), UnassignUser(taskId, userId), GetTaskAssignees(taskId)
5. API endpoint created: POST /api/tasks/:id/assignments accepts userId to assign
6. API endpoint created: DELETE /api/tasks/:id/assignments/:userId to remove assignment
7. API endpoint created: GET /api/tasks/:id/assignments returns list of assigned users with names
8. Task list endpoint updated to include assignee information (array of assigned user objects)
9. Authorization enforced—only task owner or existing assignees can modify assignments
10. Validation prevents assigning non-existent users
11. "My Tasks" filter updated to show tasks where current user is assigned (not just CreatedByUserId)
12. Unit tests cover assignment/unassignment logic and authorization
13. Integration tests validate assignment endpoints with multiple users

## Tasks / Subtasks

- [ ] **Task 1: Create TaskAssignment Entity and Configuration** (AC: 1, 2, 3)
  - [ ] Create `TaskAssignment.cs` in `TaskFlow.Abstractions/Entities/`:
    - [ ] TaskId: Guid (FK to Tasks)
    - [ ] UserId: Guid (FK to Users)
    - [ ] AssignedDate: DateTime (default: CURRENT_TIMESTAMP)
    - [ ] AssignedByUserId: Guid (FK to Users—who made the assignment)
    - [ ] Task navigation property: Task
    - [ ] User navigation property: User
    - [ ] AssignedByUser navigation property: User
  - [ ] Create `TaskAssignmentConfiguration.cs` in `TaskFlow.Infrastructure/Configurations/`:
    - [ ] Configure composite primary key (TaskId, UserId)
    - [ ] Configure foreign key relationships with appropriate delete behavior
    - [ ] Configure indexes on TaskId, UserId, and AssignedDate
  - [ ] Update `ApplicationDbContext.cs` to include TaskAssignment DbSet
  - [ ] Create and apply database migration for TaskAssignment table

- [ ] **Task 2: Update Task Entity with Assignments Navigation** (AC: 2, 8)
  - [ ] Add to `Task.cs` entity:
    - [ ] `ICollection<TaskAssignment> TaskAssignments { get; set; }` navigation property
  - [ ] Update `TaskConfiguration.cs`:
    - [ ] Configure one-to-many relationship between Task and TaskAssignment
  - [ ] Verify EF Core navigation property mappings are correct

- [ ] **Task 3: Create Assignment DTOs** (AC: 5, 6, 7, 8)
  - [ ] Create `TaskAssignmentDto.cs` in `TaskFlow.Abstractions/DTOs/Task/`:
    - [ ] UserId: Guid
    - [ ] UserName: string
    - [ ] UserEmail: string
    - [ ] AssignedDate: DateTime
    - [ ] AssignedByUserId: Guid
    - [ ] AssignedByUserName: string
  - [ ] Create `AssignUserDto.cs` in `TaskFlow.Abstractions/DTOs/Task/`:
    - [ ] UserId: Guid (required)
  - [ ] Update `TaskResponseDto.cs` to include:
    - [ ] `List<TaskAssignmentDto> Assignees { get; set; }`

- [ ] **Task 4: Create TaskAssignment Repository** (AC: 4)
  - [ ] Create `ITaskAssignmentRepository.cs` interface in `TaskFlow.Abstractions/Interfaces/`:
    - [ ] `Task<TaskAssignment?> GetAssignmentAsync(Guid taskId, Guid userId, CancellationToken cancellationToken)`
    - [ ] `Task<List<TaskAssignment>> GetTaskAssignmentsAsync(Guid taskId, CancellationToken cancellationToken)`
    - [ ] `Task<List<TaskAssignment>> GetUserAssignmentsAsync(Guid userId, CancellationToken cancellationToken)`
    - [ ] `Task AddAssignmentAsync(TaskAssignment assignment, CancellationToken cancellationToken)`
    - [ ] `Task RemoveAssignmentAsync(TaskAssignment assignment, CancellationToken cancellationToken)`
    - [ ] `Task<bool> IsUserAssignedToTaskAsync(Guid taskId, Guid userId, CancellationToken cancellationToken)`
  - [ ] Create `TaskAssignmentRepository.cs` in `TaskFlow.Infrastructure/Repositories/`:
    - [ ] Implement all interface methods
    - [ ] Include User navigation property in queries (for names/emails)
    - [ ] Use `AsNoTracking()` for read-only queries
    - [ ] Apply appropriate indexes for performance

- [ ] **Task 5: Create TaskService Assignment Methods** (AC: 4, 9, 10, 11)
  - [ ] Update `ITaskService.cs` interface with new methods:
    - [ ] `Task AssignUserAsync(Guid taskId, Guid userId, Guid assignedByUserId, CancellationToken cancellationToken)`
    - [ ] `Task UnassignUserAsync(Guid taskId, Guid userId, Guid currentUserId, CancellationToken cancellationToken)`
    - [ ] `Task<List<TaskAssignmentDto>> GetTaskAssigneesAsync(Guid taskId, Guid currentUserId, CancellationToken cancellationToken)`
  - [ ] Implement methods in `TaskService.cs`:
    - [ ] AssignUserAsync:
      - [ ] Validate task exists and currentUser has permission (is owner or assignee)
      - [ ] Validate target user exists (call UserRepository)
      - [ ] Prevent duplicate assignments (check if already assigned)
      - [ ] Create TaskAssignment with AssignedByUserId
      - [ ] Save to repository
      - [ ] Throw `NotFoundException` if task/user not found
      - [ ] Throw `UnauthorizedException` if no permission
    - [ ] UnassignUserAsync:
      - [ ] Validate task exists and currentUser has permission
      - [ ] Validate assignment exists
      - [ ] Remove assignment from repository
      - [ ] Throw `NotFoundException` if assignment not found
      - [ ] Throw `UnauthorizedException` if no permission
    - [ ] GetTaskAssigneesAsync:
      - [ ] Validate task exists and currentUser has permission to view
      - [ ] Fetch assignments with user details
      - [ ] Map to TaskAssignmentDto list
  - [ ] Update `GetTasksAsync` method to include assignee information in TaskResponseDto

- [ ] **Task 6: Update Task Query Methods for "My Tasks" Filter** (AC: 11)
  - [ ] Update `ITaskRepository.cs` interface:
    - [ ] Add `Task<List<Task>> GetAssignedTasksAsync(Guid userId, CancellationToken cancellationToken)`
  - [ ] Implement in `TaskRepository.cs`:
    - [ ] Query tasks where user is in TaskAssignments OR CreatedByUserId equals userId
    - [ ] Include all standard task properties and navigation properties
    - [ ] Apply IsDeleted = false filter
  - [ ] Update `ITaskService.cs`:
    - [ ] Add optional parameter to GetTasksAsync: `bool myTasksOnly = false`
  - [ ] Update `TaskService.GetTasksAsync`:
    - [ ] When myTasksOnly = true, call GetAssignedTasksAsync instead of GetTasksAsync
    - [ ] Ensure assignee information is included in response

- [ ] **Task 7: Create API Endpoints** (AC: 5, 6, 7, 11)
  - [ ] Add methods to `TasksController.cs`:
    - [ ] `[HttpPost("{id}/assignments")]` AssignUser(Guid id, [FromBody] AssignUserDto dto)
      - [ ] Extract current userId from JWT claims
      - [ ] Call TaskService.AssignUserAsync
      - [ ] Return 204 NoContent on success
    - [ ] `[HttpDelete("{id}/assignments/{userId}")]` UnassignUser(Guid id, Guid userId)
      - [ ] Extract current userId from JWT claims
      - [ ] Call TaskService.UnassignUserAsync
      - [ ] Return 204 NoContent on success
    - [ ] `[HttpGet("{id}/assignments")]` GetTaskAssignees(Guid id)
      - [ ] Extract current userId from JWT claims
      - [ ] Call TaskService.GetTaskAssigneesAsync
      - [ ] Return 200 OK with List<TaskAssignmentDto>
  - [ ] Update `[HttpGet]` GetTasks method:
    - [ ] Add optional query parameter: `bool myTasks = false`
    - [ ] Pass myTasksOnly to TaskService.GetTasksAsync
  - [ ] Add `[Authorize]` attribute to all endpoints
  - [ ] Apply proper error handling middleware (returns 400/403/404 automatically)

- [ ] **Task 8: Write Unit Tests** (AC: 9, 10, 12)
  - [ ] Create `TaskServiceAssignmentTests.cs` in `TaskFlow.Tests/Unit/Services/`:
    - [ ] Test successful user assignment (happy path)
    - [ ] Test duplicate assignment prevention (should not error, idempotent)
    - [ ] Test unassignment (happy path)
    - [ ] Test authorization enforcement (non-owner/non-assignee cannot assign)
    - [ ] Test validation of non-existent user (throws NotFoundException)
    - [ ] Test validation of non-existent task (throws NotFoundException)
    - [ ] Test GetTaskAssigneesAsync returns correct data
    - [ ] Test "My Tasks" filter includes assigned tasks
  - [ ] Mock dependencies: ITaskRepository, ITaskAssignmentRepository, IUserRepository
  - [ ] Use xUnit with Moq for mocking

- [ ] **Task 9: Write Integration Tests** (AC: 13)
  - [ ] Create `TaskAssignmentControllerTests.cs` in `TaskFlow.Tests/Integration/Controllers/`:
    - [ ] Test POST /api/tasks/{id}/assignments with valid userId
    - [ ] Test POST with invalid userId (404)
    - [ ] Test POST with unauthorized user (403)
    - [ ] Test DELETE /api/tasks/{id}/assignments/{userId} successfully
    - [ ] Test DELETE with unauthorized user (403)
    - [ ] Test GET /api/tasks/{id}/assignments returns all assignees
    - [ ] Test GET /api/tasks with myTasks=true returns only assigned tasks
    - [ ] Test multiple users assigned to same task
    - [ ] Test user assigned to multiple tasks
  - [ ] Use in-memory database with test data seeding
  - [ ] Use CustomWebApplicationFactory for test setup

- [ ] **Task 10: Update Seed Data (Optional for Testing)** (AC: 13)
  - [ ] Update `DbInitializer` or seed script to create sample assignments
  - [ ] Assign multiple users to test tasks for manual testing

## Dev Notes

### Relevant Source Tree

**Backend Structure:**
- **Entities**: `backend/TaskFlow.Abstractions/Entities/`
  - Task.cs (existing, will add navigation property)
  - User.cs (existing)
  - TaskAssignment.cs (new)
- **DTOs**: `backend/TaskFlow.Abstractions/DTOs/Task/`
  - TaskAssignmentDto.cs (new)
  - AssignUserDto.cs (new)
  - TaskResponseDto.cs (update to include assignees)
- **Interfaces**: `backend/TaskFlow.Abstractions/Interfaces/`
  - ITaskService.cs (update)
  - ITaskRepository.cs (update)
  - ITaskAssignmentRepository.cs (new)
- **Services**: `backend/TaskFlow.Core/Services/`
  - TaskService.cs (update with assignment methods)
- **Repositories**: `backend/TaskFlow.Infrastructure/Repositories/`
  - TaskRepository.cs (update for "My Tasks" query)
  - TaskAssignmentRepository.cs (new)
- **Configurations**: `backend/TaskFlow.Infrastructure/Configurations/`
  - TaskConfiguration.cs (update)
  - TaskAssignmentConfiguration.cs (new)
- **Controllers**: `backend/TaskFlow.Api/Controllers/`
  - TasksController.cs (add assignment endpoints)
- **Database**: `backend/TaskFlow.Infrastructure/Data/`
  - ApplicationDbContext.cs (add TaskAssignment DbSet)
  - Migrations/ (new migration for TaskAssignment table)

### Database Schema Reference

From [database-schema.md](../architecture/database-schema.md):

**TaskAssignees Table (TaskAssignment in code):**
```sql
CREATE TABLE "TaskAssignees" (
    "TaskId" UUID NOT NULL,
    "UserId" UUID NOT NULL,
    "AssignedDate" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "AssignedByUserId" UUID NOT NULL,
    
    CONSTRAINT "PK_TaskAssignees" PRIMARY KEY ("TaskId", "UserId"),
    CONSTRAINT "FK_TaskAssignees_Task" FOREIGN KEY ("TaskId") 
        REFERENCES "Tasks" ("Id") ON DELETE CASCADE,
    CONSTRAINT "FK_TaskAssignees_User" FOREIGN KEY ("UserId") 
        REFERENCES "Users" ("Id") ON DELETE CASCADE,
    CONSTRAINT "FK_TaskAssignees_AssignedByUser" FOREIGN KEY ("AssignedByUserId") 
        REFERENCES "Users" ("Id") ON DELETE CASCADE
);
```

**Indexes:**
- IX_TaskAssignees_UserId (for "My Tasks" queries)
- IX_TaskAssignees_TaskId (for assignee list queries)
- IX_TaskAssignees_AssignedDate (for audit/sorting)

### Architecture Patterns to Follow

**Repository Pattern:**
- All database access through repository interfaces
- Use `AsNoTracking()` for read-only queries
- Include navigation properties with `.Include()` for efficiency
- Apply cancellation tokens to all async methods

**Service Layer Authorization:**
- Verify user owns task OR is assigned to task before allowing modifications
- TaskService methods receive `currentUserId` parameter from controller (extracted from JWT)
- Throw `UnauthorizedException` for permission failures
- Throw `NotFoundException` for missing entities
- Throw `ValidationException` for business rule violations

**Many-to-Many Relationship Pattern:**
- Use explicit join entity (TaskAssignment) instead of EF Core's automatic join table
- This allows additional fields (AssignedDate, AssignedByUserId) on the relationship
- Configure composite primary key in EF Core configuration
- Navigation properties on both sides: Task.TaskAssignments and User.TaskAssignments (add if needed)

**DTO Mapping:**
- Services return DTOs, never entities
- Map entities to DTOs in service layer
- Include related data in DTOs (user names, emails) to avoid N+1 queries
- TaskResponseDto includes full assignee list for frontend display

**API Endpoint Conventions:**
- RESTful resource nesting: `/api/tasks/{taskId}/assignments`
- POST for creating assignments
- DELETE with userId in route for removing assignments
- GET for listing assignments
- Return 204 NoContent for successful mutations
- Return 200 OK with data for queries
- Middleware handles exceptions and returns appropriate status codes

### Authorization Rules

1. **Assigning Users:**
   - Task owner (CreatedByUserId) can assign anyone
   - Existing assignees can assign others (collaborative teams)
   - Cannot assign to non-existent users (NotFoundException)

2. **Unassigning Users:**
   - Task owner can unassign anyone
   - Assignees can unassign themselves
   - Assignees can unassign others (team flexibility)

3. **Viewing Assignments:**
   - Task owner can view all assignees
   - Assignees can view all assignees
   - Others cannot view (returns 403)

4. **"My Tasks" Filter:**
   - Returns tasks where user is CreatedByUserId OR in TaskAssignments
   - Only shows non-deleted tasks

### Testing

**Testing Standards:**
- **Unit Tests Location**: `backend/TaskFlow.Tests/Unit/Services/TaskServiceAssignmentTests.cs`
- **Integration Tests Location**: `backend/TaskFlow.Tests/Integration/Controllers/TaskAssignmentControllerTests.cs`
- **Framework**: xUnit with Moq for mocking
- **Patterns**:
  - Unit tests mock all dependencies (repositories)
  - Integration tests use in-memory SQLite database
  - Use `CustomWebApplicationFactory` for integration tests
  - Arrange-Act-Assert pattern for test structure
  - Descriptive test names: `AssignUserAsync_WhenUserNotFound_ThrowsNotFoundException`

**Coverage Requirements:**
- All service methods covered by unit tests
- All API endpoints covered by integration tests
- Happy paths and error cases tested
- Authorization rules verified with tests
- Edge cases: duplicate assignments, self-assignment, circular references (if applicable)

**Test Data Setup:**
- Create test users (owner, assignee1, assignee2, unauthorized)
- Create test tasks owned by different users
- Seed assignments for multi-user scenarios
- Use GUIDs consistently for test IDs

### Previous Story Notes

From Story 2.1-2.3, key learnings:
- EF Core configuration pattern established in `TaskConfiguration.cs`
- Repository methods consistently use `AsNoTracking()` for queries
- Service layer handles all business logic and validation
- Controllers are thin, delegating to services
- JWT claims extraction pattern: `User.FindFirst(ClaimTypes.NameIdentifier)?.Value`
- Migration naming: `Add{EntityName}Table` or `Update{EntityName}{Feature}`
- Composite primary keys require explicit configuration in `OnModelCreating`

### Important Implementation Notes

1. **Composite Primary Key Configuration:**
```csharp
modelBuilder.Entity<TaskAssignment>()
    .HasKey(ta => new { ta.TaskId, ta.UserId });
```

2. **Foreign Key Configuration:**
```csharp
modelBuilder.Entity<TaskAssignment>()
    .HasOne(ta => ta.Task)
    .WithMany(t => t.TaskAssignments)
    .HasForeignKey(ta => ta.TaskId)
    .OnDelete(DeleteBehavior.Cascade);

modelBuilder.Entity<TaskAssignment>()
    .HasOne(ta => ta.User)
    .WithMany()
    .HasForeignKey(ta => ta.UserId)
    .OnDelete(DeleteBehavior.Cascade);

modelBuilder.Entity<TaskAssignment>()
    .HasOne(ta => ta.AssignedByUser)
    .WithMany()
    .HasForeignKey(ta => ta.AssignedByUserId)
    .OnDelete(DeleteBehavior.Cascade);
```

3. **"My Tasks" Query Pattern:**
```csharp
return await _context.Tasks
    .Where(t => !t.IsDeleted && 
                (t.CreatedByUserId == userId || 
                 t.TaskAssignments.Any(ta => ta.UserId == userId)))
    .Include(t => t.TaskAssignments)
        .ThenInclude(ta => ta.User)
    .ToListAsync(cancellationToken);
```

4. **Idempotent Assignment:**
- Assigning an already-assigned user should not error
- Check if assignment exists before creating
- Return success either way (idempotent operation)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Initial story creation | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_