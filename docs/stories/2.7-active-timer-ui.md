# Story 2.7: Active Timer UI

## Status

Approved

## Story

**As a** user,
**I want** to start, pause, and stop a timer on tasks,
**so that** I can track time as I work without manually entering minutes.

## Acceptance Criteria

1. "Start Timer" button added to task list view and task detail panel
2. Clicking "Start Timer" initiates browser-based timer showing elapsed time (HH:MM:SS format)
3. Timer displays prominently in UI (sticky header or floating widget) showing active task name
4. Timer updates every second without performance issues
5. "Pause" button allows pausing timer without losing elapsed time
6. "Resume" button continues timer from paused elapsed time
7. "Stop" button ends timer and prompts to save time entry with optional note
8. Saving timer creates TimeEntry via API with EntryType=Timer and calculated minutes (rounded up to nearest minute)
9. Only one timer can run at a time (starting new timer stops current timer with confirmation)
10. Timer state persists in browser localStorage (survives page refresh during active timing)
11. Timer displays even when navigating to different pages within application
12. Successfully saved time entry updates task's LoggedMinutes display immediately
13. Timer shows visual indicator (pulsing dot, color change) when active

## Tasks / Subtasks

- [ ] **Task 1: Create Timer State Service** (AC: 4, 10, 11)
  - [ ] Create `timer-state.service.ts` in `src/app/core/services/state/`
  - [ ] Inject Angular `inject()` function for dependencies
  - [ ] Create interface `TimerState`:
    - [ ] Property: `isRunning: boolean`
    - [ ] Property: `isPaused: boolean`
    - [ ] Property: `taskId: string | null`
    - [ ] Property: `taskName: string | null`
    - [ ] Property: `elapsedSeconds: number`
    - [ ] Property: `startTime: number | null` (timestamp)
  - [ ] Create private `BehaviorSubject<TimerState>` with initial state
  - [ ] Create public `timer$: Observable<TimerState>` from BehaviorSubject
  - [ ] Method: `startTimer(taskId: string, taskName: string): void`
    - [ ] Save current state to localStorage
    - [ ] Update BehaviorSubject with running state
    - [ ] Start interval timer (1 second)
  - [ ] Method: `pauseTimer(): void`
    - [ ] Update state to paused
    - [ ] Stop interval
    - [ ] Save state to localStorage
  - [ ] Method: `resumeTimer(): void`
    - [ ] Update state to running
    - [ ] Resume interval timer
    - [ ] Save state to localStorage
  - [ ] Method: `stopTimer(): number` (returns elapsed minutes)
    - [ ] Calculate total elapsed minutes (rounded up)
    - [ ] Clear timer state
    - [ ] Remove from localStorage
    - [ ] Return elapsed minutes
  - [ ] Method: `loadTimerFromStorage(): void` (called in constructor)
    - [ ] Read from localStorage key 'taskflow_timer'
    - [ ] If valid timer state exists, restore and resume
  - [ ] Private method: `tick(): void`
    - [ ] Increment elapsedSeconds
    - [ ] Update BehaviorSubject
  - [ ] Register service as `providedIn: 'root'`

- [ ] **Task 2: Create Timer Widget Component** (AC: 2, 3, 4, 5, 6, 7, 13)
  - [ ] Create `timer-widget` component in `src/app/shared/components/`
  - [ ] Component files:
    - [ ] `timer-widget.component.ts`
    - [ ] `timer-widget.component.html`
    - [ ] `timer-widget.component.scss`
    - [ ] `timer-widget.component.spec.ts`
  - [ ] Inject `TimerStateService`
  - [ ] Inject `TimeTrackingService` (for saving time entry)
  - [ ] Inject `MatDialog` (for stop confirmation)
  - [ ] Subscribe to `timerState.timer$` in component
  - [ ] Create computed signal or pipe for formatted time (HH:MM:SS)
  - [ ] Template structure:
    - [ ] Container div with fixed/sticky positioning (top-right corner)
    - [ ] Show widget only when `timerState.isRunning || timerState.isPaused`
    - [ ] Display task name
    - [ ] Display formatted elapsed time (HH:MM:SS)
    - [ ] Pulsing dot indicator when running (CSS animation)
    - [ ] Button: "Pause" (shown when running)
    - [ ] Button: "Resume" (shown when paused)
    - [ ] Button: "Stop" (always shown)
  - [ ] Method: `onPause(): void`
    - [ ] Call `timerState.pauseTimer()`
  - [ ] Method: `onResume(): void`
    - [ ] Call `timerState.resumeTimer()`
  - [ ] Method: `onStop(): void`
    - [ ] Open dialog to enter note (optional)
    - [ ] Get elapsed minutes from `timerState.stopTimer()`
    - [ ] Call `timeTrackingService.logTime()` with EntryType=Timer
    - [ ] Show success notification
    - [ ] Refresh task data to update LoggedMinutes
  - [ ] Styling (SCSS):
    - [ ] Fixed position: top-right corner, z-index high
    - [ ] Card-like appearance with shadow
    - [ ] Pulsing animation for active indicator
    - [ ] Responsive design (collapse on mobile)
    - [ ] Use Angular Material colors/theming

- [ ] **Task 3: Create Stop Timer Dialog Component** (AC: 7)
  - [ ] Create `stop-timer-dialog` component in `src/app/shared/components/`
  - [ ] Component files:
    - [ ] `stop-timer-dialog.component.ts`
    - [ ] `stop-timer-dialog.component.html`
    - [ ] `stop-timer-dialog.component.scss`
  - [ ] Use `MAT_DIALOG_DATA` to receive elapsed minutes
  - [ ] Template:
    - [ ] Display elapsed time (formatted as "2h 30m")
    - [ ] Textarea for optional note (maxlength 500)
    - [ ] "Save" button (primary)
    - [ ] "Cancel" button
  - [ ] Method: `onSave(): void`
    - [ ] Return dialog data: `{ note: string, confirmed: true }`
  - [ ] Method: `onCancel(): void`
    - [ ] Close dialog with `{ confirmed: false }`

- [ ] **Task 4: Add Start Timer Button to Task List** (AC: 1, 9)
  - [ ] Update `task-list.component.ts`:
    - [ ] Inject `TimerStateService`
    - [ ] Inject `MatDialog` for confirmation
    - [ ] Subscribe to `timerState.timer$` to get current timer state
  - [ ] Update `task-list.component.html`:
    - [ ] Add "Start Timer" button/icon to each task row
    - [ ] Disable button if timer is already running for different task
    - [ ] Show "Timer Running" badge if this task's timer is active
  - [ ] Method: `onStartTimer(task: Task): void`
    - [ ] If another timer is running, show confirmation dialog
    - [ ] If confirmed, stop current timer with auto-save
    - [ ] Call `timerState.startTimer(task.id, task.name)`
    - [ ] Show success notification

- [ ] **Task 5: Add Start Timer Button to Task Detail Panel** (AC: 1, 9)
  - [ ] Update `task-detail.component.ts`:
    - [ ] Inject `TimerStateService`
    - [ ] Subscribe to `timerState.timer$`
  - [ ] Update `task-detail.component.html`:
    - [ ] Add "Start Timer" button in task actions area
    - [ ] Disable if timer running for different task
    - [ ] Show "Timer Running" badge if active for this task
  - [ ] Method: `onStartTimer(): void`
    - [ ] Same logic as Task 4 (extract to shared method if needed)
    - [ ] Handle confirmation for switching timers

- [ ] **Task 6: Add Timer Widget to App Root** (AC: 11)
  - [ ] Update `app.component.html`:
    - [ ] Add `<app-timer-widget></app-timer-widget>` at root level
    - [ ] Widget will display globally across all pages
  - [ ] Import `TimerWidgetComponent` in `app.component.ts`

- [ ] **Task 7: Update Time Tracking Service** (AC: 8)
  - [ ] Update `time-tracking.service.ts` in `src/app/core/services/api/`:
    - [ ] Ensure `logTime()` method accepts `EntryType` parameter
    - [ ] Method signature: `logTime(taskId: string, minutes: number, note: string, entryType: 'Timer' | 'Manual'): Observable<TimeEntry>`
    - [ ] POST to `/api/tasks/${taskId}/timeentries` with DTO including EntryType

- [ ] **Task 8: Update Task State After Timer Save** (AC: 12)
  - [ ] In `timer-widget.component.ts` `onStop()` method:
    - [ ] After successful time entry save, emit event or call task state service
    - [ ] Trigger refresh of task data to update `TotalLoggedMinutes`
  - [ ] Option 1: Call `taskStateService.refreshTask(taskId)`
  - [ ] Option 2: Emit custom event that task-list/task-detail listens to

- [ ] **Task 9: Add localStorage Persistence Logic** (AC: 10)
  - [ ] In `timer-state.service.ts`:
    - [ ] Define localStorage key: `TIMER_STORAGE_KEY = 'taskflow_timer'`
    - [ ] Method: `private saveToStorage(state: TimerState): void`
      - [ ] Serialize state to JSON
      - [ ] Store in localStorage
    - [ ] Method: `private loadFromStorage(): TimerState | null`
      - [ ] Read from localStorage
      - [ ] Validate structure
      - [ ] Return parsed state or null
    - [ ] Call `loadFromStorage()` in constructor to restore timer on app load
    - [ ] Resume interval if timer was running before refresh

- [ ] **Task 10: Create Confirmation Dialog for Timer Switch** (AC: 9)
  - [ ] Create `confirm-timer-switch-dialog` component or reuse generic confirmation dialog
  - [ ] Template:
    - [ ] Message: "A timer is already running for [Task Name]. Stop current timer and start new one?"
    - [ ] Display elapsed time for current timer
    - [ ] "Yes, Switch Timer" button
    - [ ] "Cancel" button
  - [ ] If confirmed:
    - [ ] Auto-save current timer with note "Auto-saved: switched to another task"
    - [ ] Start new timer

- [ ] **Task 11: Add Unit Tests for TimerStateService** (AC: 4, 10)
  - [ ] Create `timer-state.service.spec.ts`
  - [ ] Test: `should start timer and update state`
  - [ ] Test: `should pause timer and stop ticking`
  - [ ] Test: `should resume timer and continue ticking`
  - [ ] Test: `should stop timer and return elapsed minutes (rounded up)`
  - [ ] Test: `should persist timer state to localStorage`
  - [ ] Test: `should load timer from localStorage on init`
  - [ ] Test: `should clear localStorage when timer stopped`
  - [ ] Test: `should increment elapsed seconds every second`

- [ ] **Task 12: Add Component Tests for TimerWidgetComponent** (AC: 2, 3, 5, 6, 7, 13)
  - [ ] Create `timer-widget.component.spec.ts`
  - [ ] Test: `should display timer widget when timer is running`
  - [ ] Test: `should hide timer widget when no timer active`
  - [ ] Test: `should display task name and formatted time`
  - [ ] Test: `should show pause button when running`
  - [ ] Test: `should show resume button when paused`
  - [ ] Test: `should call timerState.pauseTimer() on pause click`
  - [ ] Test: `should call timerState.resumeTimer() on resume click`
  - [ ] Test: `should open stop dialog on stop click`
  - [ ] Test: `should display pulsing indicator when active`

- [ ] **Task 13: Add Styling for Timer Widget** (AC: 3, 13)
  - [ ] Update `timer-widget.component.scss`:
    - [ ] Fixed position: `position: fixed; top: 20px; right: 20px; z-index: 1000;`
    - [ ] Card styling with shadow: `mat-card` or custom card styles
    - [ ] Pulsing animation for active indicator:
      ```scss
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .timer-active-indicator {
        animation: pulse 2s infinite;
      }
      ```
    - [ ] Responsive: collapse to smaller widget or move to bottom on mobile
    - [ ] Use Angular Material theming variables

- [ ] **Task 14: Integration Test - Full Timer Flow** (AC: 1-13)
  - [ ] Create E2E test or integration test:
    - [ ] Start timer from task list
    - [ ] Verify timer widget appears with task name
    - [ ] Wait for elapsed time to increment
    - [ ] Pause timer, verify time stops
    - [ ] Resume timer, verify time continues
    - [ ] Navigate to different page, verify timer persists
    - [ ] Refresh page, verify timer restored from localStorage
    - [ ] Stop timer, enter note, save
    - [ ] Verify time entry created in backend
    - [ ] Verify task's TotalLoggedMinutes updated

## Dev Notes

### Relevant Architecture

**Frontend Framework**: Angular 20 with standalone components
**State Management**: RxJS with BehaviorSubject for reactive timer state
**UI Components**: Angular Material for dialogs, buttons, cards
**Storage**: Browser localStorage for timer persistence
**API Integration**: TimeTrackingService for saving time entries

### Source Tree (Relevant Locations)

```
src/app/
  core/
    services/
      state/
        timer-state.service.ts          # NEW: Timer state management
      api/
        time-tracking.service.ts        # EXISTING: Update to support EntryType
  shared/
    components/
      timer-widget/                     # NEW: Global timer display widget
        timer-widget.component.ts
        timer-widget.component.html
        timer-widget.component.scss
        timer-widget.component.spec.ts
      stop-timer-dialog/                # NEW: Dialog for stopping timer
        stop-timer-dialog.component.ts
        stop-timer-dialog.component.html
        stop-timer-dialog.component.scss
  features/
    tasks/
      task-list/
        task-list.component.ts          # UPDATE: Add start timer button
        task-list.component.html
      task-detail/
        task-detail.component.ts        # UPDATE: Add start timer button
        task-detail.component.html
  app.component.html                    # UPDATE: Add timer widget
```

### Key Technical Details

**Timer Interval Management**:
- Use RxJS `interval(1000)` for one-second ticks
- Store interval subscription and clean up on pause/stop
- Use `takeUntil()` to auto-unsubscribe when service destroyed

**localStorage Schema**:
```typescript
{
  isRunning: boolean,
  isPaused: boolean,
  taskId: string,
  taskName: string,
  elapsedSeconds: number,
  startTime: number  // timestamp when timer started/resumed
}
```

**Elapsed Time Calculation**:
- Store `startTime` timestamp when timer starts
- On each tick, calculate elapsed = (now - startTime) + previousElapsedSeconds
- Round up to nearest minute when saving: `Math.ceil(elapsedSeconds / 60)`

**Timer State Synchronization**:
- Timer state is global singleton service (providedIn: 'root')
- All components subscribe to `timer$` observable for reactive updates
- Widget displays on all pages by mounting in app root

**Confirmation Flow for Timer Switch**:
1. User clicks "Start Timer" on Task B while Task A timer running
2. Show dialog: "Timer running for Task A (15m elapsed). Switch to Task B?"
3. If YES: Auto-save Task A time with note "Auto-saved", start Task B timer
4. If NO: Do nothing, keep Task A timer running

**Performance Considerations**:
- Use `OnPush` change detection strategy for timer widget
- Format time using pure pipe to avoid recalculations
- Debounce localStorage writes (write on pause/stop, not every tick)

**Previous Story Dependencies**:
- Story 2.6 implemented TimeEntry backend and TimeTrackingService
- TimeEntry entity has `EntryType` enum (Timer/Manual)
- API endpoint: POST `/api/tasks/:id/timeentries` accepts EntryType

### Testing

**Test File Locations**:
- Unit tests: `src/app/core/services/state/timer-state.service.spec.ts`
- Component tests: `src/app/shared/components/timer-widget/timer-widget.component.spec.ts`
- Integration tests: Can use Playwright E2E tests in `e2e/` folder

**Testing Frameworks**:
- Jasmine + Karma for unit/component tests
- Angular TestBed for component testing
- Playwright for E2E testing (optional for full flow)

**Key Test Scenarios**:
1. Timer state management (start, pause, resume, stop)
2. localStorage persistence and restoration
3. UI updates (widget display, buttons, formatted time)
4. Timer switching with confirmation
5. Time entry creation on stop
6. Task data refresh after save

**Mocking**:
- Mock `TimeTrackingService` in component tests
- Mock `localStorage` in service tests
- Use Jasmine `jasmine.clock()` to control time in tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-29 | 1.0 | Initial story creation | Sarah (PO) |
