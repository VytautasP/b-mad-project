# Story 3.5: Interactive Gantt Features

## Status

Approved

## Story

**As a** user,
**I want** to drag task bars to adjust dates and zoom the timeline view,
**so that** I can plan schedules interactively.

## Acceptance Criteria

1. Clicking task bar in Gantt chart opens task detail panel (same as list view)
2. Drag-and-drop enabled on task bars to adjust dates horizontally
3. Dragging task bar updates DueDate via API PUT /api/tasks/:id with new calculated date
4. Visual feedback during drag (semi-transparent bar, snap-to-grid guidelines)
5. Successful date change updates task immediately in Gantt without full reload
6. Zoom controls added: "Day", "Week", "Month" buttons change X-axis granularity
7. Zoom level persists in user session (returns to last used zoom on page revisit)
8. Horizontal scrolling enabled to navigate beyond visible date range
9. Scroll position persists during task updates (chart doesn't jump to top)
10. Keyboard shortcuts: +/- to zoom in/out, arrow keys to scroll timeline
11. Date change validationâ€”prevents setting due date before creation date with error message
12. Parent task due dates automatically adjusted when child dates exceed parent range (or warning displayed)
13. Drag disabled on completed tasks (Done status) with visual indicator (locked icon)
14. Mobile users see read-only Gantt (no drag-and-drop) or simplified calendar view

## Tasks / Subtasks

- [ ] **Task 1: Implement Task Bar Click Handler** (AC: 1)
  - [ ] In `timeline.component.ts`:
    - [ ] Add method: `onTaskClick(taskId: string)`
    - [ ] Emit event or navigate to open task detail panel
    - [ ] Check if shared `TaskDetailComponent` exists (from Story 1.6)
    - [ ] If yes, open detail panel as modal/sidebar: inject `MatDialog` or use router outlet
    - [ ] If no shared component, navigate to task edit route: `router.navigate(['/tasks', taskId, 'edit'])`
  - [ ] Configure Gantt library click event handler:
    - [ ] Register click event on task bars (library-specific API)
    - [ ] Call `onTaskClick(task.id)` when task bar clicked
  - [ ] Verify clicking task bar opens detail view with correct task data
  - [ ] Ensure detail panel shows all task fields (Name, Description, Status, DueDate, etc.)
  - [ ] Test with multiple tasks to verify correct task selected

- [ ] **Task 2: Enable Drag-and-Drop on Task Bars** (AC: 2, 4)
  - [ ] Check if selected Gantt library supports drag-and-drop natively:
    - [ ] If Frappe Gantt: enable dragging via configuration option `{ draggable: true }`
    - [ ] If DHTMLX or other: enable drag-and-drop feature
  - [ ] Configure visual feedback during drag:
    - [ ] Semi-transparent bar: apply CSS opacity 0.6 during drag
    - [ ] Snap-to-grid: enable date snapping (snap to day boundaries)
    - [ ] Drag cursor: show move cursor (`cursor: grab` / `cursor: grabbing`)
  - [ ] Test dragging task bars left and right across date range
  - [ ] Verify visual feedback displays correctly during drag
  - [ ] Ensure drag is smooth without lag (60fps performance)

- [ ] **Task 3: Update Task Due Date via API on Drag** (AC: 3, 5, 11)
  - [ ] Register drag end event handler in Gantt library:
    - [ ] Method: `onTaskDragEnd(taskId: string, newEndDate: Date)`
    - [ ] Library calls this method when user releases dragged bar
  - [ ] Implement drag end handler logic:
    - [ ] Calculate new due date from newEndDate (Date object)
    - [ ] Get task's CreatedDate from tasks array
    - [ ] Validate: newEndDate >= CreatedDate (AC 11)
    - [ ] If invalid: show error toast "Due date cannot be before creation date" and revert bar to original position
    - [ ] If valid: call `taskService.updateTask(taskId, { dueDate: newEndDate })`
  - [ ] Update TaskService with updateTask method (if not exists):
    - [ ] Method: `updateTask(taskId: string, updates: Partial<Task>): Observable<Task>`
    - [ ] Make HTTP PUT request to `/api/tasks/${taskId}` with updates
    - [ ] Return updated task observable
  - [ ] Handle API response:
    - [ ] On success: update local tasks array with new due date (AC 5)
    - [ ] On error: show error toast and revert bar to original position
    - [ ] No full Gantt reloadâ€”update single bar only
  - [ ] Test dragging and verifying date updated in backend (check via task detail panel)
  - [ ] Test validation: drag task before creation date, verify error message
  - [ ] Test API failure scenario: disconnect network, verify revert behavior

- [ ] **Task 4: Disable Drag on Completed Tasks** (AC: 13)
  - [ ] Implement method: `isTaskDraggable(task: TimelineTask): boolean`
    - [ ] Return `false` if task.status === TaskStatus.Done
    - [ ] Return `true` for all other statuses
  - [ ] Configure Gantt library to disable drag on completed tasks:
    - [ ] Pass draggable predicate function to library (library-specific)
    - [ ] Or apply CSS class `.locked` to Done tasks and disable pointer events
  - [ ] Add visual indicator for locked tasks:
    - [ ] Overlay locked icon (ðŸ”’ or padlock icon) on Done task bars
    - [ ] Change cursor to `not-allowed` on hover
  - [ ] Test dragging completed task, verify no drag behavior
  - [ ] Test visual indicator appears on Done tasks
  - [ ] Test dragging tasks in other statuses still works

- [ ] **Task 5: Parent Task Due Date Adjustment Logic** (AC: 12)
  - [ ] On drag end, after validating new due date:
    - [ ] Check if task is a child (has `parentTaskId`)
    - [ ] If yes, get parent task from tasks array
    - [ ] Check if newEndDate > parent.dueDate
    - [ ] If yes, show warning dialog: "Moving this task will extend the parent task deadline. Continue?"
    - [ ] If user confirms, update child task AND update parent task due date to newEndDate + 1 day
    - [ ] Call API to update both tasks: child first, then parent
  - [ ] Alternative simpler approach (if no auto-update):
    - [ ] Show warning toast: "This task exceeds parent deadline. Please review parent task."
    - [ ] Do not auto-update parentâ€”require manual adjustment
  - [ ] Test dragging child task beyond parent due date
  - [ ] Verify warning displayed
  - [ ] Verify parent task updated (if auto-update) or warning shown (if manual)
  - [ ] Test hierarchical tasks with multiple levels (grandchild â†’ child â†’ parent)

- [ ] **Task 6: Implement Zoom Controls** (AC: 6, 7)
  - [ ] Add zoom control buttons to timeline template:
    - [ ] Above Gantt chart: "Day", "Week", "Month" buttons
    - [ ] Use Angular Material buttons or custom styled buttons
  - [ ] Add component property: `zoomLevel: 'day' | 'week' | 'month' = 'week'`
  - [ ] Implement zoom change handler:
    - [ ] Method: `changeZoom(level: 'day' | 'week' | 'month')`
    - [ ] Update `zoomLevel` property
    - [ ] Re-render Gantt chart with new X-axis scale
    - [ ] Call Gantt library API to change view mode (e.g., `gantt.change_view_mode(level)`)
  - [ ] Persist zoom level in session storage (AC 7):
    - [ ] On zoom change: `sessionStorage.setItem('gantt-zoom', level)`
    - [ ] In `ngOnInit()`: restore zoom level: `this.zoomLevel = sessionStorage.getItem('gantt-zoom') || 'week'`
  - [ ] Highlight active zoom button (CSS active class)
  - [ ] Test switching between Day, Week, Month views
  - [ ] Verify X-axis granularity changes correctly
  - [ ] Verify zoom level restored on page refresh/revisit

- [ ] **Task 7: Enable Horizontal Scrolling** (AC: 8, 9)
  - [ ] Configure Gantt chart container to allow horizontal scrolling:
    - [ ] Set CSS: `overflow-x: auto` on Gantt container div
    - [ ] Ensure Gantt width exceeds viewport for scrolling to activate
  - [ ] Persist scroll position during updates (AC 9):
    - [ ] Before updating Gantt data, save scroll position: `const scrollLeft = container.scrollLeft`
    - [ ] After updating Gantt, restore scroll position: `container.scrollLeft = scrollLeft`
  - [ ] Test scrolling horizontally to navigate date range
  - [ ] Test dragging task and verify chart doesn't jump to top/left
  - [ ] Test with wide date range (3+ months) requiring horizontal scrolling

- [ ] **Task 8: Implement Keyboard Shortcuts** (AC: 10)
  - [ ] Add `@HostListener` for keyboard events in `timeline.component.ts`:
    - [ ] Listen for '+' or '=' key: zoom in (day â†’ week â†’ month limited to Month)
    - [ ] Listen for '-' key: zoom out (month â†’ week â†’ day limited to Day)
    - [ ] Listen for ArrowLeft: scroll left by 100px
    - [ ] Listen for ArrowRight: scroll right by 100px
  - [ ] Implement zoom in/out logic:
    - [ ] Method: `zoomIn()` and `zoomOut()`
    - [ ] Cycle through zoom levels: day â†” week â†” month
  - [ ] Implement scroll logic:
    - [ ] Method: `scrollTimeline(direction: 'left' | 'right')`
    - [ ] Adjust `container.scrollLeft` by +/- 100px
  - [ ] Test keyboard shortcuts:
    - [ ] Press '+': verify zoom in
    - [ ] Press '-': verify zoom out
    - [ ] Press arrow keys: verify scrolling
    - [ ] Test edge cases: zoom at max/min level, scroll at edge
  - [ ] Ensure keyboard shortcuts don't conflict with browser shortcuts (may need event.preventDefault())

- [ ] **Task 9: Mobile Responsive Behavior** (AC: 14)
  - [ ] Detect mobile device:
    - [ ] Use CSS media query: `@media (max-width: 768px)`
    - [ ] Or use Angular service to detect device type
  - [ ] Disable drag-and-drop on mobile:
    - [ ] Set Gantt library draggable: false on mobile
    - [ ] Or detect touch events and disable drag handlers
  - [ ] Simplify Gantt view on mobile (optional):
    - [ ] Reduce task bar height for smaller screens
    - [ ] Show fewer date labels on X-axis
    - [ ] Enable touch scrolling (should work by default)
  - [ ] Alternative: show simplified calendar view on mobile:
    - [ ] Replace Gantt with month calendar grid showing task counts per day
    - [ ] Clicking date opens task list for that day
    - [ ] (This is optional enhancement if Gantt is too complex on mobile)
  - [ ] Test on mobile device or browser device emulator:
    - [ ] Verify read-only Gantt displays
    - [ ] Verify no drag-and-drop on touch
    - [ ] Verify scrolling works smoothly
    - [ ] Verify click to open task detail works

- [ ] **Task 10: Integration Testing and Manual Validation** (AC: All)
  - [ ] Test complete user workflow:
    - [ ] Navigate to timeline view
    - [ ] Click task bar â†’ verify detail panel opens
    - [ ] Drag task bar right â†’ verify due date updated
    - [ ] Drag task bar left â†’ verify due date updated
    - [ ] Drag completed task â†’ verify no drag, locked icon shown
    - [ ] Drag child task beyond parent â†’ verify warning displayed
    - [ ] Change zoom to Day â†’ verify X-axis shows days
    - [ ] Change zoom to Month â†’ verify X-axis shows months
    - [ ] Refresh page â†’ verify zoom level restored
    - [ ] Scroll horizontally â†’ verify navigation works
    - [ ] Drag task, then scroll â†’ verify chart doesn't jump
    - [ ] Press '+' key â†’ verify zoom in
    - [ ] Press '-' key â†’ verify zoom out
    - [ ] Press arrow keys â†’ verify scrolling
    - [ ] Try to set due date before creation date â†’ verify error message
    - [ ] Test on mobile device â†’ verify read-only Gantt
  - [ ] Performance testing:
    - [ ] Drag 10 tasks rapidly â†’ verify smooth updates
    - [ ] Zoom in/out multiple times â†’ verify no lag
    - [ ] Scroll large date range â†’ verify smooth scrolling
  - [ ] Edge case testing:
    - [ ] Drag task to far future date (1 year+) â†’ verify API accepts
    - [ ] Drag task to same date as current â†’ verify no unnecessary API call
    - [ ] Drag task while loading indicator showing â†’ verify race condition handled
    - [ ] Multiple users editing same task (requires testing with 2 browsers) â†’ verify conflict resolution
  - [ ] Document any bugs or limitations found

## Dev Notes

### Existing System Integration

This story enhances the **Timeline view** created in Story 3.4 by adding interactive features: drag-and-drop rescheduling, zoom controls, keyboard navigation, and task detail panel access. It leverages the existing task update API and task detail components.

**Key Integration Points:**
- **Task Update API**: Uses existing `PUT /api/tasks/:id` endpoint (from Story 1.4) to update due dates
- **Task Service**: Extends `TaskService.ts` with `updateTask()` method if not already present (added in Story 1.6)
- **Task Detail Panel**: Reuses `TaskDetailComponent` or navigates to task edit route (from Story 1.6)
- **Timeline Component**: Builds on `TimelineComponent` from Story 3.4
- **Gantt Library**: Extends Gantt library integration (Frappe Gantt from Story 3.4) with drag-and-drop API
- **Session Storage**: Uses browser sessionStorage API for zoom level persistence
- **Validation Logic**: Uses existing date validation patterns (DueDate >= CreatedDate)
- **Error Handling**: Uses existing toast notification service for errors and warnings
- **Parent-Child Hierarchy**: Leverages `ParentTaskId` relationships (from Story 2.1)

### Technology Stack

- **Frontend Framework**: Angular 20 (standalone components)
- **Language**: TypeScript 5.9.3
- **HTTP Client**: Angular HttpClient (built-in)
- **Gantt Library**: Frappe Gantt with drag-and-drop API
- **Storage**: Browser sessionStorage API (for zoom persistence)
- **Styling**: Tailwind CSS + Angular Material + custom SCSS
- **State Management**: RxJS Observables via service layer

### Existing Patterns to Follow

**Drag-and-Drop Pattern** (NEWâ€”specific to Gantt):
- Register drag end event handler with library
- Validate new date before API call
- Optimistic UI update (update bar immediately)
- Revert on API failure with error message
- Use task service method for API calls

**Task Update Pattern** (from Story 1.6):
- Use `TaskService.updateTask(taskId, updates)` method
- Send PATCH or PUT request with partial updates
- Return updated task from API
- Update local state with response
- Show success/error toast notification

**Session Storage Pattern**:
- Save state on change: `sessionStorage.setItem(key, value)`
- Restore on component init: `ngOnInit()` â†’ `sessionStorage.getItem(key)`
- Use JSON.stringify/parse for complex objects
- Clear on logout: `sessionStorage.clear()`

**Keyboard Event Handling Pattern**:
```typescript
@HostListener('document:keydown', ['$event'])
handleKeyboardEvent(event: KeyboardEvent) {
  if (event.key === '+' || event.key === '=') {
    event.preventDefault();
    this.zoomIn();
  }
  // ... more handlers
}
```

**Modal/Dialog Pattern** (from Angular Material):
- Inject `MatDialog` service
- Open dialog: `this.dialog.open(TaskDetailComponent, { data: { taskId } })`
- Subscribe to dialog close event: `dialogRef.afterClosed().subscribe(result => ...)`
- Alternative: use router outlet for side panel

**Loading State Pattern** (from Story 1.5):
- Show loading spinner during API calls: `isUpdating: boolean`
- Disable drag during loading to prevent race conditions
- Use `finalize()` RxJS operator to reset loading state

**Error Handling Pattern** (from Story 1.6):
- Use toast notification service: `toastService.showError(message)`
- Display inline error message for validation errors
- Revert UI changes on API failure
- Log errors to console for debugging

**Responsive Design Pattern** (from Architecture):
- Use CSS media queries: `@media (max-width: 768px)`
- Conditionally render mobile-specific UI: `*ngIf="isMobile"`
- Detect device type: inject `BreakpointObserver` service
- Touch event handling: `(touchstart)`, `(touchmove)`, `(touchend)`

### Technical Notes

**Frappe Gantt Drag-and-Drop API**:
- Enable dragging: `new Gantt(container, tasks, { draggable: true })`
- Register drag handler: `gantt.on_date_change((task, start, end) => { ... })`
- Parameters: `task` object with id, `start` Date, `end` Date (new due date)
- Return false from handler to revert drag (for validation errors)
- Update task object directly to reflect changes: `task.end = newEnd`

**Date Validation Logic**:
```typescript
validateDueDate(createdDate: Date, newDueDate: Date): boolean {
  return newDueDate >= createdDate;
}
```

**Parent Task Due Date Logic**:
- When child task due date > parent due date:
  - Option 1 (Auto-adjust): Update parent task due date to max(child dates)
  - Option 2 (Warning): Show warning and require manual parent update
- Story uses Option 2 (warning only) for simplicity
- Future enhancement: implement auto-adjust with confirmation dialog

**Zoom Level Persistence**:
```typescript
// Save zoom level
changeZoom(level: 'day' | 'week' | 'month') {
  this.zoomLevel = level;
  sessionStorage.setItem('gantt-zoom', level);
  this.gantt.change_view_mode(level); // Frappe Gantt API
}

// Restore zoom level
ngOnInit() {
  const savedZoom = sessionStorage.getItem('gantt-zoom');
  this.zoomLevel = (savedZoom as any) || 'week';
}
```

**Scroll Position Persistence**:
```typescript
updateTask(taskId: string, updates: Partial<Task>) {
  const container = this.ganttContainer.nativeElement;
  const scrollLeft = container.scrollLeft; // Save scroll position
  
  this.taskService.updateTask(taskId, updates).subscribe({
    next: (updatedTask) => {
      this.updateLocalTask(updatedTask);
      this.refreshGantt(); // Re-render Gantt
      setTimeout(() => container.scrollLeft = scrollLeft, 0); // Restore scroll
    }
  });
}
```

**Mobile Detection**:
```typescript
import { BreakpointObserver, Breakpoints } from '@angular/cdk/layout';

constructor(private breakpointObserver: BreakpointObserver) {}

ngOnInit() {
  this.breakpointObserver.observe([Breakpoints.Handset])
    .subscribe(result => {
      this.isMobile = result.matches;
      this.ganttConfig.draggable = !this.isMobile; // Disable drag on mobile
    });
}
```

**Performance Considerations**:
- Dragging should not trigger unnecessary API callsâ€”debounce if needed
- Optimistic UI updates prevent perceived lag
- Avoid full Gantt re-render on single task updateâ€”update bar only
- For >100 tasks, consider pagination or viewport-based rendering

**Rollback Plan**:
- Interactive features are enhancementsâ€”if drag fails, users can still edit tasks via detail panel
- Keyboard shortcuts are optionalâ€”no impact if not implemented
- Zoom persistence is nice-to-haveâ€”defaults to week view if not persisted
- Mobile read-only is acceptableâ€”desktop is primary use case for Gantt
- Low riskâ€”all changes are frontend-only except task update API (already exists)

### Testing

#### Testing Standards (from Architecture)

**Unit Tests** (`timeline.component.spec.ts`):
- Test zoom level change updates component state
- Test drag end handler calls task service with correct date
- Test date validation rejects due date before creation date
- Test keyboard event handlers trigger correct actions
- Test mobile detection disables drag on small screens
- Mock TaskService and MatDialog dependencies
- Use Jasmine + Karma (Angular default)

**Integration Tests**:
- Test drag-and-drop updates task in backend (requires running API)
- Test zoom level persistence across page reloads
- Test clicking task bar opens detail panel with correct data
- Test parent task warning displays when child exceeds parent date
- Test keyboard shortcuts work end-to-end

**Manual Testing Checklist**:
- [ ] Drag task bar right, verify due date updated in backend
- [ ] Drag task bar left, verify due date updated in backend
- [ ] Click task bar, verify detail panel opens
- [ ] Drag completed task, verify no drag allowed
- [ ] Drag child task beyond parent, verify warning shown
- [ ] Change zoom to Day/Week/Month, verify X-axis changes
- [ ] Refresh page, verify zoom level restored
- [ ] Scroll horizontally, verify navigation works
- [ ] Drag task after scrolling, verify no jump
- [ ] Press '+'/'-' keys, verify zoom changes
- [ ] Press arrow keys, verify scrolling
- [ ] Try to set due date before creation date, verify error
- [ ] Test on mobile/tablet, verify read-only Gantt
- [ ] Test with 50+ tasks, verify performance is smooth
- [ ] Test rapid dragging (10 tasks in 10 seconds), verify no lag or errors

**Test Data Requirements**:
- At least 50 tasks with due dates spanning 3 months
- Tasks in all status types (To Do, In Progress, Blocked, Waiting, Done)
- Hierarchical tasks: parent with 3-5 children
- Tasks with due dates near each other (test overlapping bars)
- Tasks at edge of date range (test boundary conditions)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 1.0 | Story created from Epic 3.5 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

*To be populated by dev agent*

### Debug Log References

*To be populated by dev agent*

### Completion Notes List

*To be populated by dev agent*

### File List

*To be populated by dev agent*

## QA Results

*To be populated by QA agent*