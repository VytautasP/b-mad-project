# Story 3.9: Activity Log UI and Status Indicators

## Status

Approved

## Story

**As a** user,
**I want** to see task activity history and clear visual status indicators throughout the application,
**so that** I understand what happened and can quickly identify task states.

## Acceptance Criteria

1. Activity log section added to task detail panel showing chronological activity feed
2. Activity items displayed with: Actor avatar, Activity description, Timestamp (relative: "2 hours ago" or absolute date)
3. Activity types have distinct icons (created: ?, updated: ??, status changed: ??, assigned: ??, time logged: ??, commented: ??)
4. Field changes expanded to show details (e.g., "Status changed from In Progress to Done")
5. Activity log scrollable with "Load More" button for tasks with extensive history (pagination)
6. Status-specific visual indicators implemented throughout UI: status badges (colored pills), icons (? for Done, ? for Blocked, ? for Waiting)
7. Status color coding consistent: To Do (gray), In Progress (blue), Blocked (red), Waiting (yellow), Done (green)
8. Priority indicators added to task list: Critical (red flag), High (orange), Medium (yellow), Low (gray)
9. Task cards/rows show multiple visual indicators simultaneously (status badge + priority icon)
10. Gantt chart bars use status colors matching list view
11. Tree view nodes show status/priority icons consistently
12. Dashboard summary widget displays task counts by status with color-coded badges (optional enhancement)
13. Empty activity log state: "No activity yet"
14. Activity log updates in real-time when changes made in same session (or on next refresh)
15. Mobile-friendly activity log display (condensed format, icons emphasized)

## Tasks / Subtasks

- [ ] **Task 1: Add Activity Log Frontend Models and API Service** (AC: 1, 2, 3, 4, 5, 13)
  - [ ] Create `src/app/shared/models/activity-log.model.ts` with:
    - [ ] `ActivityType` enum matching backend values
    - [ ] `ActivityLog` interface aligned with backend `ActivityLogResponseDto`
    - [ ] `ActivityLogQuery` interface for `page` and `pageSize`
    - [ ] `PaginatedActivityLogResult` type alias (or reuse generic paginated contract)
  - [ ] Create `src/app/features/collaboration/services/activity-log.service.ts`:
    - [ ] `getTaskActivity(taskId: string, page = 1, pageSize = 20)` calling `GET /api/tasks/{taskId}/activity`
    - [ ] Error handling consistent with existing frontend service patterns
    - [ ] Use `environment.apiUrl` and typed `Observable` responses
  - [ ] Add/extend service unit tests in `activity-log.service.spec.ts`

- [ ] **Task 2: Build Reusable Activity Item Component** (AC: 2, 3, 4, 15)
  - [ ] Create `src/app/features/collaboration/activity-log/components/activity-item/`:
    - [ ] `activity-item.component.ts`
    - [ ] `activity-item.component.html`
    - [ ] `activity-item.component.scss`
  - [ ] Render actor avatar (fallback initials), activity description, relative timestamp
  - [ ] Map activity type to distinct Material icon and semantic class for visual differentiation
  - [ ] Add expandable field-change details for `changedField`, `oldValue`, `newValue`
  - [ ] Ensure mobile-condensed layout with clear icon prominence

- [ ] **Task 3: Build Activity Log Container Component with Pagination** (AC: 1, 5, 13, 14, 15)
  - [ ] Create `src/app/features/collaboration/activity-log/`:
    - [ ] `activity-log.component.ts`
    - [ ] `activity-log.component.html`
    - [ ] `activity-log.component.scss`
  - [ ] Inputs:
    - [ ] `@Input() taskId: string`
    - [ ] `@Input() refreshToken?: number | string` (or equivalent trigger)
  - [ ] State:
    - [ ] `activities` collection
    - [ ] loading + loading-more flags
    - [ ] paging state (`page`, `pageSize`, `hasMore`)
  - [ ] Behavior:
    - [ ] Load first page on init/task change
    - [ ] Append more items on "Load More"
    - [ ] Maintain descending order (most recent first)
    - [ ] Show empty state: "No activity yet"
    - [ ] Make feed area scrollable for long histories

- [ ] **Task 4: Integrate Activity Log into Task Detail Dialog** (AC: 1, 14)
  - [ ] Update `src/app/features/tasks/task-detail-dialog/task-detail-dialog.ts`:
    - [ ] Import and register `ActivityLogComponent`
    - [ ] Add refresh signal/version counter used to refresh activity feed after local actions
  - [ ] Update `src/app/features/tasks/task-detail-dialog/task-detail-dialog.html`:
    - [ ] Add new "Activity" section in dialog body as a dedicated `section-card`
    - [ ] Keep section ordering consistent with current task detail layout
  - [ ] Wire refresh triggers after actions in same session (time logging, assignee changes, comment add/edit/delete where available)

- [ ] **Task 5: Standardize Status Badge Colors and Icons Across Views** (AC: 6, 7, 10, 11)
  - [ ] Verify and align status visual mapping across:
    - [ ] `src/app/features/tasks/task-list/task-list.component.ts` and `.html`
    - [ ] `src/app/features/tasks/task-detail-dialog/task-detail-dialog.ts` and `.html`
    - [ ] `src/app/features/tasks/task-tree/task-tree.component.ts` (existing icon/class mapping)
    - [ ] `src/app/features/tasks/timeline/timeline.ts` + timeline styles/classes
  - [ ] Ensure shared status semantics are consistent:
    - [ ] To Do = gray
    - [ ] In Progress = blue
    - [ ] Blocked = red
    - [ ] Waiting = yellow
    - [ ] Done = green
  - [ ] Ensure Done / Blocked / Waiting iconography is explicit in list/detail/tree where applicable

- [ ] **Task 6: Add Priority Icons to Task List and Card Rows** (AC: 8, 9)
  - [ ] Update `src/app/features/tasks/task-list/task-list.component.ts`:
    - [ ] Add helper(s) for priority icon and class mapping
  - [ ] Update `src/app/features/tasks/task-list/task-list.component.html`:
    - [ ] Show status badge + priority icon together in desktop rows
    - [ ] Show same combined indicators in mobile cards
  - [ ] Add styling in `task-list.component.scss` for critical/high/medium/low priority icon emphasis

- [ ] **Task 7: Optional Dashboard Status Summary Enhancement** (AC: 12)
  - [ ] Assess existing dashboard widgets in `src/app/features/dashboard/`
  - [ ] If scope remains within this story session, add status count badges with consistent colors
  - [ ] If deferred, document explicitly in story implementation notes as optional enhancement not completed

- [ ] **Task 8: Unit Tests for Activity Log Components and Indicator Mapping** (AC: 2, 3, 4, 5, 6, 7, 8, 9, 13, 15)
  - [ ] Add `activity-item.component.spec.ts` tests for:
    - [ ] icon mapping by `activityType`
    - [ ] timestamp rendering
    - [ ] expanded field-change details
    - [ ] mobile-safe rendering
  - [ ] Add `activity-log.component.spec.ts` tests for:
    - [ ] initial load and empty state
    - [ ] load-more pagination append behavior
    - [ ] loading indicators and error handling
    - [ ] refresh trigger behavior
  - [ ] Extend `task-list.component.spec.ts` and `task-detail-dialog` tests to verify combined status/priority indicators

- [ ] **Task 9: Integration/Workflow Validation for Same-Session Updates** (AC: 14)
  - [ ] Validate activity feed refresh behavior when:
    - [ ] assignee changes in task detail dialog
    - [ ] manual time entry is logged
    - [ ] comments are created/edited/deleted (from Story 3.7 integration point)
  - [ ] Confirm updates appear without reopening task detail dialog (or document fallback refresh behavior)

## Dev Notes

### Dependencies and Current State

- Story 3.8 backend is implemented and exposes `GET /api/tasks/{id}/activity` with pagination.
- Story 3.7 comment thread UI is implemented in task detail dialog and is an integration point for same-session activity updates.
- No frontend activity log model/service/component exists yet in `src/app`.

### Backend Contract to Use

- Endpoint: `GET /api/tasks/{id}/activity`
- Query params: `page` (default 1), `pageSize` (default 20, max 100)
- Response type: paginated result of `ActivityLogResponseDto`
- Activity fields available: `id`, `taskId`, `userId`, `userName`, `activityType`, `description`, `changedField`, `oldValue`, `newValue`, `timestamp`

### Existing Frontend Patterns to Follow

- Standalone component architecture with explicit imports and Angular signals.
- Service API calls via `HttpClient` + `environment.apiUrl` in feature/core services.
- Task detail dialog structure uses section cards and existing collaboration components (`CommentThreadComponent`).
- Shared relative-time formatting exists and should be reused for activity timestamps.

### Relevant Source Tree

```text
src/app/
├── features/
│   ├── collaboration/
│   │   ├── comment-thread/                          # Existing from Story 3.7
│   │   ├── services/
│   │   │   └── (add) activity-log.service.ts
│   │   └── (add) activity-log/
│   │       ├── activity-log.component.ts
│   │       ├── activity-log.component.html
│   │       ├── activity-log.component.scss
│   │       └── components/
│   │           └── activity-item/
│   │               ├── activity-item.component.ts
│   │               ├── activity-item.component.html
│   │               └── activity-item.component.scss
│   └── tasks/
│       ├── task-detail-dialog/
│       │   ├── task-detail-dialog.ts               # Update to include ActivityLogComponent
│       │   └── task-detail-dialog.html             # Add Activity section
│       ├── task-list/
│       │   ├── task-list.component.ts              # Add priority icon helpers / status icon mapping
│       │   ├── task-list.component.html            # Show combined status + priority indicators
│       │   └── task-list.component.scss            # Indicator styling updates
│       ├── task-tree/task-tree.component.ts        # Verify status/priority consistency
│       └── timeline/timeline.ts                    # Verify status color consistency for bars
└── shared/
    └── models/
        └── (add) activity-log.model.ts
```

### Testing

- Frontend unit tests should use Angular TestBed and `HttpClientTestingModule` patterns already used in feature services/components.
- Follow coding standards in `docs/architecture/12-coding-standards.md`:
  - Components with business logic must have unit tests.
  - Service methods must have unit tests.
  - Use Arrange-Act-Assert pattern.
- Story-specific verification focus:
  - Distinct activity icons and field change details rendering.
  - Pagination + load-more behavior for long histories.
  - Consistent status/priority indicators in list, tree, and timeline surfaces.
  - Same-session activity refresh behavior in task detail dialog.

## Change Log

| Date       | Version | Description   | Author     |
|------------|---------|---------------|------------|
| 2026-02-12 | 0.1     | Initial draft | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
