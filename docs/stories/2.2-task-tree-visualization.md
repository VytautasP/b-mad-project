# Story 2.2: Task Tree Visualization

## Status

Ready for Review

## Story

**As a** user,
**I want** to view my tasks in an expandable tree structure,
**so that** I can see project organization and navigate hierarchies visually.

## Acceptance Criteria

1. Tree view component created using Angular tree library (@circlon/angular-tree-component or Angular Material Tree)
2. Tree view displays tasks hierarchically with expand/collapse icons for parent tasks
3. Tree nodes show task Name, Status icon, and Priority indicator
4. Root tasks (no parent) displayed at top level, children indented beneath parents
5. Expand/collapse state persists per user session (expanded nodes remain expanded on navigation)
6. Clicking task name in tree opens task detail panel (slide-out or modal)
7. Visual indicators distinguish task types: Projects (folder icon), Milestones (flag icon), Tasks (checkbox icon)
8. Tree view toggle button added to dashboard to switch between tree view and list view
9. Tree loads hierarchical data efficiently (single API call fetching full tree, not lazy-loaded for MVP)
10. Deep hierarchies (5+ levels) render with appropriate indentation without UI breaking
11. Empty tree state displayed when user has no tasks
12. Tree view responsiveâ€”works on desktop (primary) and collapses/simplifies on mobile

## Tasks / Subtasks

- [x] **Task 1: Choose and Install Tree Library** (AC: 1)
  - [x] Evaluate Angular Material Tree vs @circlon/angular-tree-component
  - [x] Install selected library (recommend Angular Material Tree for consistency with existing Material components)
  - [x] Add necessary imports to package.json and update dependencies

- [x] **Task 2: Create TaskTreeComponent** (AC: 1, 2, 4, 8, 11)
  - [x] Create `src/app/features/tasks/task-tree/task-tree.component.ts`
  - [x] Create `src/app/features/tasks/task-tree/task-tree.component.html`
  - [x] Create `src/app/features/tasks/task-tree/task-tree.component.scss`
  - [x] Import Angular Material Tree modules (MatTreeModule, MatIconModule, MatButtonModule)
  - [x] Inject TaskService to fetch tasks
  - [x] Create tree data source using NestedTreeControl or FlatTreeControl
  - [x] Build tree structure from flat task array using parentTaskId references
  - [x] Display root tasks (parentTaskId === null) at top level
  - [x] Implement empty state template when no tasks exist
  - [x] Use standalone component pattern matching existing component architecture

- [x] **Task 3: Implement Tree Node Display** (AC: 2, 3, 7)
  - [x] Create tree node template showing task name, status icon, and priority indicator
  - [x] Add expand/collapse icons for parent tasks (mat-icon with chevron_right/expand_more)
  - [x] Display status icon based on task.status (done: check_circle, inProgress: hourglass_empty, etc.)
  - [x] Display priority indicator (high: arrow_upward with red color, medium: remove, low: arrow_downward)
  - [x] Add task type icons: Projects (folder), Milestones (flag), Tasks (check_box)
  - [x] Style nodes with appropriate indentation for hierarchy levels
  - [x] Ensure hasChildren property determines if expand icon shows

- [x] **Task 4: Add Expand/Collapse State Persistence** (AC: 5)
  - [x] Create service or use localStorage to persist expanded node IDs
  - [x] Save expanded node state on expand/collapse events
  - [x] Restore expanded state when component initializes
  - [x] Key storage by user ID to support multi-user sessions
  - [x] Handle edge cases (task deleted while expanded, etc.)

- [x] **Task 5: Implement Task Detail Navigation** (AC: 6)
  - [x] Add click handler to task name in tree node
  - [x] Open task detail panel (slide-out or modal) on task name click
  - [x] Reuse existing TaskFormComponent in view-only or edit mode OR create TaskDetailComponent
  - [x] Pass selected task ID to detail component
  - [x] Ensure panel/modal closes and tree refreshes if task updated

- [x] **Task 6: Add Tree/List View Toggle** (AC: 8)
  - [x] Add toggle button to Dashboard component toolbar
  - [x] Use mat-button-toggle or mat-slide-toggle for view selection
  - [x] Store view preference in component state or localStorage
  - [x] Show TaskListComponent when "List View" selected
  - [x] Show TaskTreeComponent when "Tree View" selected
  - [x] Default to List View for backward compatibility

- [x] **Task 7: Optimize Tree Data Loading** (AC: 9)
  - [x] Update TaskService.getTasks() to fetch all tasks in single API call
  - [x] Ensure backend GET /api/tasks includes parentTaskId and hasChildren fields (already implemented in Story 2.1)
  - [x] Build client-side tree structure from flat array using parentTaskId references
  - [x] Avoid N+1 query problems by loading full tree upfront (not lazy-loaded for MVP)
  - [x] Use RxJS operators to transform flat task array to nested tree structure

- [x] **Task 8: Handle Deep Hierarchies** (AC: 10)
  - [x] Test tree rendering with 5+ levels of nesting
  - [x] Ensure indentation scaling works (e.g., 20px per level)
  - [x] Add CSS max-width or scrolling if tree exceeds container width
  - [x] Consider visual indicators for very deep trees (depth badges, etc.)

- [x] **Task 9: Make Tree View Responsive** (AC: 12)
  - [x] Add mobile-specific styles (reduce indentation, smaller icons)
  - [x] Simplify tree on mobile (consider collapsing all by default)
  - [x] Ensure touch-friendly expand/collapse targets (min 44x44px)
  - [x] Test on mobile viewport (< 768px width)
  - [x] Consider horizontal scrolling or simplified mobile view

- [x] **Task 10: Write Component Tests** (AC: All)
  - [x] Create `task-tree.component.spec.ts`
  - [x] Test tree builds correctly from flat task array
  - [x] Test expand/collapse functionality
  - [x] Test empty state display
  - [x] Test task selection and detail navigation
  - [x] Mock TaskService.getTasks() with hierarchical test data
  - [x] Test responsive behavior with different viewport sizes

## Dev Notes

### Existing System Integration

This story builds on Story 2.1 (Recursive Hierarchy Backend Support), which implemented:
- `ParentTaskId` field on Task entity
- API endpoints: GET /api/tasks (with parentTaskId and hasChildren fields)
- Backend hierarchy validation (circular reference prevention, depth limits)

**Key Integration Points:**
- Fetches tasks from existing `TaskService.getTasks()` method
- Uses existing `Task` model which includes parentTaskId and hasChildren properties
- Integrates into existing Dashboard component via view toggle
- Follows existing Angular Material component patterns (TaskListComponent, TaskFormComponent)

### Technology Stack

- **Frontend Framework**: Angular 20 with standalone components
- **UI Library**: Angular Material 20 (MatTreeModule, MatIconModule, MatButtonModule)
- **State Management**: RxJS Observables
- **Styling**: Angular Material theming + custom SCSS
- **Testing**: Jasmine + Karma

### Recommended Tree Library

**Angular Material Tree** (recommended for MVP):
- Already using Angular Material throughout the app (consistency)
- Built-in support for nested and flat tree data structures
- NestedTreeControl for hierarchical data
- No additional dependencies
- Excellent accessibility support
- Well-documented

**Alternative: @circlon/angular-tree-component**:
- More feature-rich (drag-drop built-in, virtual scrolling)
- Requires additional dependency
- Consider for Story 2.3 if drag-drop integration needed

### Existing Patterns to Follow

**Component Architecture** (from Story 1.5):
- Standalone components with explicit imports
- Inject services using `inject()` function
- Use signals for reactive state management
- OnPush change detection strategy for performance
- Implement OnInit and OnDestroy lifecycle hooks
- Use `takeUntil(destroy$)` pattern for subscription cleanup

**Service Integration** (from Story 1.5):
- TaskService returns `Observable<Task[]>`
- Use RxJS operators (map, filter, tap) to transform data
- Handle loading state with signal: `isLoading = signal(true)`
- Display errors with MatSnackBar
- Follow existing error handling patterns

**Styling Patterns** (from Story 1.5):
- Use Angular Material components for consistent UI
- Follow existing responsive patterns (mobile: cards, desktop: table/tree)
- Use CSS classes: `.mobile-view`, `.desktop-view`
- Apply Angular Material theming variables
- Match existing color scheme (primary, accent, warn)

### Building Tree Structure from Flat Array

```typescript
// Example transformation function
buildTreeStructure(tasks: Task[]): TreeNode[] {
  const taskMap = new Map<string, TreeNode>();
  const rootNodes: TreeNode[] = [];

  // First pass: create all nodes
  tasks.forEach(task => {
    taskMap.set(task.id, {
      task: task,
      children: []
    });
  });

  // Second pass: build parent-child relationships
  tasks.forEach(task => {
    const node = taskMap.get(task.id)!;
    if (task.parentTaskId) {
      const parent = taskMap.get(task.parentTaskId);
      if (parent) {
        parent.children.push(node);
      } else {
        rootNodes.push(node); // Parent not found, treat as root
      }
    } else {
      rootNodes.push(node); // No parent, is root
    }
  });

  return rootNodes;
}
```

### Angular Material Tree Setup

```typescript
// Component setup with NestedTreeControl
export class TaskTreeComponent {
  treeControl = new NestedTreeControl<TreeNode>(node => node.children);
  dataSource: MatTreeNestedDataSource<TreeNode>;

  hasChild = (_: number, node: TreeNode) => 
    node.task.hasChildren && node.children.length > 0;
}
```

### Expand/Collapse State Persistence

```typescript
// LocalStorage key pattern
const EXPAND_STATE_KEY = 'taskflow_tree_expanded_nodes';

// Save expanded state
saveExpandedState(): void {
  const expandedIds = this.treeControl.expansionModel.selected.map(node => node.task.id);
  localStorage.setItem(EXPAND_STATE_KEY, JSON.stringify(expandedIds));
}

// Restore expanded state
restoreExpandedState(nodes: TreeNode[]): void {
  const expandedIds = JSON.parse(localStorage.getItem(EXPAND_STATE_KEY) || '[]');
  const nodesToExpand = this.findNodesByIds(nodes, expandedIds);
  nodesToExpand.forEach(node => this.treeControl.expand(node));
}
```

### Source Tree Locations

**New Files to Create:**
- `src/app/features/tasks/task-tree/task-tree.component.ts`
- `src/app/features/tasks/task-tree/task-tree.component.html`
- `src/app/features/tasks/task-tree/task-tree.component.scss`
- `src/app/features/tasks/task-tree/task-tree.component.spec.ts`

**Existing Files to Modify:**
- `src/app/features/dashboard/dashboard.ts` - Add tree/list toggle
- `src/app/features/dashboard/dashboard.html` - Add toggle UI and conditional rendering
- `src/app/shared/models/task.model.ts` - Verify parentTaskId and hasChildren properties exist

### Testing

**Component Tests (Jasmine/Karma):**
- Test tree structure building from flat array
- Test expand/collapse interactions
- Test empty state rendering
- Test task selection and navigation
- Mock TaskService.getTasks() with hierarchical test data
- Test localStorage persistence of expanded state

**Manual Testing Checklist:**
- [ ] Tree displays root tasks at top level
- [ ] Parent tasks show expand/collapse icons
- [ ] Expanding parent shows immediate children
- [ ] Deep hierarchies (5+ levels) render correctly
- [ ] Task name click opens detail panel
- [ ] Toggle switches between list and tree view
- [ ] Expanded state persists across navigation
- [ ] Empty state shows when no tasks exist
- [ ] Responsive on mobile (simplified view)
- [ ] Icons display correctly (status, priority, type)

### Testing Standards

**Test File Location:**
- Place test file alongside component: `task-tree.component.spec.ts`

**Test Standards:**
- Follow existing test patterns from `task-list.component.spec.ts`
- Use Jasmine test framework with describe/it blocks
- Mock TaskService using jasmine.createSpyObj
- Test component in isolation (unit tests, not integration)
- Use TestBed.configureTestingModule for component setup
- Test both success and error scenarios
- Aim for >80% code coverage

**Testing Frameworks:**
- Jasmine 5.1+ for test structure and assertions
- Karma 6.4+ for test runner
- Angular TestBed for component testing
- Use `fixture.detectChanges()` to trigger change detection
- Use `async` and `fakeAsync` for asynchronous testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

N/A - No blocking issues encountered

### Completion Notes List

- Created TaskTreeComponent with Angular Material Tree library
- Implemented hierarchical tree visualization with expand/collapse functionality
- Added state persistence using localStorage for expanded nodes
- Integrated tree view toggle in Dashboard component
- Updated Task model to include `hasChildren` and `createdByUserName` properties
- Implemented responsive design with mobile-specific styles
- Created comprehensive test suite using Vitest
- Fixed existing test files to include new Task model properties

### File List

**New Files:**
- src/app/features/tasks/task-tree/task-tree.component.ts
- src/app/features/tasks/task-tree/task-tree.component.html
- src/app/features/tasks/task-tree/task-tree.component.scss
- src/app/features/tasks/task-tree/task-tree.component.spec.ts

**Modified Files:**
- src/app/shared/models/task.model.ts (added hasChildren and createdByUserName properties)
- src/app/features/dashboard/dashboard.ts (added tree view toggle and task selection handler)
- src/app/features/dashboard/dashboard.html (added view toggle UI and tree component)
- src/app/features/dashboard/dashboard.css (added styles for header actions)
- src/app/features/tasks/task-list/task-list.component.spec.ts (updated mock task)
- src/app/features/tasks/task-form/task-form.component.spec.ts (updated mock task)
- src/app/features/tasks/services/task.service.spec.ts (updated mock task)

## QA Results

_To be populated by QA agent_
