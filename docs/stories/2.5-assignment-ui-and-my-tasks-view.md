# Story 2.5: Assignment UI and "My Tasks" View

## Status

Approved

## Story

**As a** user,
**I want** to assign tasks to myself or team members and filter to see only my assigned tasks,
**so that** I can focus on my personal workload.

## Acceptance Criteria

1. Task detail panel includes "Assignees" section showing current assignees with avatar/name
2. "Add Assignee" button opens user picker (dropdown or autocomplete search)
3. User picker searches all users in system by name or email
4. Selecting user adds them to task assignees immediately (API call)
5. Remove assignee button (X icon) next to each assignee removes them
6. "My Tasks" filter button added to dashboard showing count of assigned tasks
7. Clicking "My Tasks" filters list to show only tasks assigned to current user
8. Tasks display assignee avatars in list view (stacked for multiple assignees, max 3 shown with +N indicator)
9. Unassigned tasks show "No assignees" placeholder
10. Task creator automatically assigned to task on creation (optional default behavior)
11. Assignment changes show brief success notification
12. Error handling for failed assignments (user not found, permission denied)

## Tasks / Subtasks

- [ ] **Task 1: Create Assignee Display Component** (AC: 1, 8, 9)
  - [ ] Create `assignee-list.component.ts` in `src/app/features/tasks/components/`:
    - [ ] Input: `assignees: TaskAssignmentDto[]`
    - [ ] Input: `maxVisible: number = 3` (for list view)
    - [ ] Input: `showActions: boolean = false` (for detail panel)
    - [ ] Output: `removeAssignee: EventEmitter<string>` (emits userId)
    - [ ] Computed property: `visibleAssignees` (first maxVisible)
    - [ ] Computed property: `hiddenCount` (total - maxVisible)
    - [ ] Method: `onRemoveClick(userId: string)` emits removeAssignee event
  - [ ] Create `assignee-list.component.html`:
    - [ ] Display assignee avatars (mat-chip or custom avatar component)
    - [ ] Show user initials if no avatar image available
    - [ ] Display +N badge for hidden assignees in list view
    - [ ] Show "No assignees" placeholder when empty
    - [ ] Include (X) remove button when showActions=true
    - [ ] Use tooltip to show full name on hover
  - [ ] Create `assignee-list.component.scss`:
    - [ ] Stack avatars with slight overlap in list view
    - [ ] Style remove button to appear on hover
    - [ ] Match Angular Material design system
  - [ ] Export component in task module

- [ ] **Task 2: Create User Picker Component** (AC: 2, 3, 4)
  - [ ] Create `user-picker.component.ts` in `src/app/features/tasks/components/`:
    - [ ] Input: `excludedUserIds: string[]` (already assigned users)
    - [ ] Output: `userSelected: EventEmitter<User>`
    - [ ] Property: `searchControl: FormControl`
    - [ ] Property: `filteredUsers$: Observable<User[]>`
    - [ ] Inject: `UserService` (create if doesn't exist)
    - [ ] Method: `ngOnInit()` sets up search observable with debounce (300ms)
    - [ ] Method: `onUserSelect(user: User)` emits userSelected and resets search
    - [ ] Method: `displayUserName(user: User)` returns formatted name for autocomplete
  - [ ] Create `user-picker.component.html`:
    - [ ] Use `mat-autocomplete` with `mat-form-field`
    - [ ] Display user name and email in options
    - [ ] Show "No users found" when filteredUsers$ is empty
    - [ ] Add mat-icon for user avatar in options
  - [ ] Create `user-picker.component.scss`:
    - [ ] Style autocomplete options with flex layout
    - [ ] Add spacing between avatar and text
  - [ ] Export component in task module

- [ ] **Task 3: Create/Update UserService** (AC: 3)
  - [ ] Create `user.service.ts` in `src/app/core/services/` if doesn't exist:
    - [ ] Inject: `HttpClient`
    - [ ] Inject: `environment` config
    - [ ] Property: `apiUrl = environment.apiUrl + '/users'`
    - [ ] Method: `searchUsers(query: string): Observable<User[]>`
      - [ ] Calls GET `/api/users/search?q=${query}`
      - [ ] Returns Observable<User[]>
      - [ ] Handles errors via error interceptor
    - [ ] Method: `getAllUsers(): Observable<User[]>`
      - [ ] Calls GET `/api/users`
      - [ ] Returns Observable<User[]>
      - [ ] Used for initial load if search empty
  - [ ] Create User interface if doesn't exist in `src/app/shared/models/`:
    - [ ] id: string
    - [ ] name: string
    - [ ] email: string
    - [ ] avatarUrl?: string (optional)
  - [ ] Add service to core module providers

- [ ] **Task 4: Update Task Detail Panel with Assignee Management** (AC: 1, 2, 4, 5, 11, 12)
  - [ ] Update `task-detail.component.ts`:
    - [ ] Inject: `TaskService` (should already exist)
    - [ ] Property: `showUserPicker: boolean = false`
    - [ ] Method: `toggleUserPicker()` shows/hides picker
    - [ ] Method: `onAddAssignee(user: User)`:
      - [ ] Calls `TaskService.assignUser(taskId, user.id)`
      - [ ] On success: refreshes task data, shows success notification
      - [ ] On error: shows error notification
      - [ ] Hides user picker
    - [ ] Method: `onRemoveAssignee(userId: string)`:
      - [ ] Shows confirmation dialog
      - [ ] Calls `TaskService.unassignUser(taskId, userId)`
      - [ ] On success: refreshes task data, shows success notification
      - [ ] On error: shows error notification
    - [ ] Method: `getExcludedUserIds()` returns array of currently assigned userIds
  - [ ] Update `task-detail.component.html`:
    - [ ] Add "Assignees" section after description
    - [ ] Use `<app-assignee-list>` with showActions=true
    - [ ] Bind removeAssignee output to `onRemoveAssignee()`
    - [ ] Add "Add Assignee" button (mat-button with mat-icon)
    - [ ] Show `<app-user-picker>` when showUserPicker=true
    - [ ] Bind userSelected output to `onAddAssignee()`
    - [ ] Pass excludedUserIds to user picker
  - [ ] Update `task-detail.component.scss`:
    - [ ] Style assignees section with proper spacing
    - [ ] Position user picker below button (absolute or mat-menu)

- [ ] **Task 5: Update TaskService with Assignment Methods** (AC: 4, 5)
  - [ ] Update `task.service.ts` in `src/app/core/services/`:
    - [ ] Method: `assignUser(taskId: string, userId: string): Observable<void>`
      - [ ] Calls POST `/api/tasks/${taskId}/assignments`
      - [ ] Body: `{ userId }`
      - [ ] Returns Observable<void>
    - [ ] Method: `unassignUser(taskId: string, userId: string): Observable<void>`
      - [ ] Calls DELETE `/api/tasks/${taskId}/assignments/${userId}`
      - [ ] Returns Observable<void>
    - [ ] Method: `getTaskAssignees(taskId: string): Observable<TaskAssignmentDto[]>`
      - [ ] Calls GET `/api/tasks/${taskId}/assignments`
      - [ ] Returns Observable<TaskAssignmentDto[]>
  - [ ] Update TaskAssignmentDto interface in `src/app/shared/models/`:
    - [ ] userId: string
    - [ ] userName: string
    - [ ] userEmail: string
    - [ ] assignedDate: string (ISO date)
    - [ ] assignedByUserId: string
    - [ ] assignedByUserName: string

- [ ] **Task 6: Add "My Tasks" Filter to Dashboard** (AC: 6, 7)
  - [ ] Update `task-list.component.ts`:
    - [ ] Property: `showMyTasksOnly: boolean = false`
    - [ ] Property: `myTasksCount$: Observable<number>`
    - [ ] Method: `ngOnInit()` initializes myTasksCount$ by calling TaskService
    - [ ] Method: `toggleMyTasks()`:
      - [ ] Sets `showMyTasksOnly = !showMyTasksOnly`
      - [ ] Calls `loadTasks()` with myTasksOnly parameter
    - [ ] Update `loadTasks()` method:
      - [ ] Pass `myTasksOnly: showMyTasksOnly` to TaskService.getTasks()
    - [ ] Update TaskService call to include new parameter
  - [ ] Update `task-list.component.html`:
    - [ ] Add "My Tasks" filter button to toolbar/header
    - [ ] Use mat-button-toggle or mat-chip-listbox
    - [ ] Display count badge: "My Tasks ({{myTasksCount$ | async}})"
    - [ ] Apply active state styling when showMyTasksOnly=true
    - [ ] Position alongside existing filters (search, status, etc.)
  - [ ] Update `task-list.component.scss`:
    - [ ] Style My Tasks button with accent color when active
    - [ ] Style count badge consistently

- [ ] **Task 7: Update TaskService.getTasks with myTasks Parameter** (AC: 7)
  - [ ] Update `task.service.ts`:
    - [ ] Update `getTasks()` method signature:
      - [ ] Add optional parameter: `myTasksOnly: boolean = false`
    - [ ] Update HTTP params:
      - [ ] Add `myTasks=${myTasksOnly}` to query string
    - [ ] Method: `getMyTasksCount(): Observable<number>`
      - [ ] Calls GET `/api/tasks?myTasks=true&count=true`
      - [ ] Returns Observable<number>
      - [ ] Or calculates from getTasks result length if count endpoint unavailable

- [ ] **Task 8: Display Assignee Avatars in Task List View** (AC: 8, 9)
  - [ ] Update `task-list-item.component.ts` (or create if using table):
    - [ ] Input: `task: TaskResponseDto` (should include assignees array)
    - [ ] Use `<app-assignee-list>` component
    - [ ] Pass maxVisible=3 for list view
    - [ ] Pass showActions=false (no remove button in list)
  - [ ] Update `task-list-item.component.html`:
    - [ ] Add assignee-list component to task row
    - [ ] Position after task name or in dedicated column
    - [ ] Show "No assignees" when empty (via assignee-list component)
  - [ ] Update `task-list-item.component.scss`:
    - [ ] Ensure avatars don't overflow row height
    - [ ] Align properly with other row content

- [ ] **Task 9: Auto-assign Task Creator on Creation (Optional)** (AC: 10)
  - [ ] Update `task-create.component.ts` or `task.service.ts`:
    - [ ] After successful task creation:
      - [ ] Get current userId from AuthService
      - [ ] Call `assignUser(newTaskId, currentUserId)`
      - [ ] Handle silently if fails (don't block creation)
    - [ ] Alternative: Backend auto-assigns on creation
  - [ ] Document decision in Dev Notes whether frontend or backend handles this

- [ ] **Task 10: Add Notification System for Assignment Changes** (AC: 11, 12)
  - [ ] Create `notification.service.ts` in `src/app/core/services/` if doesn't exist:
    - [ ] Inject: `MatSnackBar`
    - [ ] Method: `showSuccess(message: string, duration: number = 3000)`
    - [ ] Method: `showError(message: string, duration: number = 5000)`
    - [ ] Method: `showInfo(message: string, duration: number = 3000)`
  - [ ] Update task-detail.component.ts:
    - [ ] Inject NotificationService
    - [ ] Show success notification: "User assigned successfully"
    - [ ] Show success notification: "User unassigned successfully"
    - [ ] Show error notification on failure with error message
    - [ ] Error messages should be user-friendly:
      - [ ] "User not found"
      - [ ] "You don't have permission to modify assignments"
      - [ ] "Assignment failed. Please try again."
  - [ ] Add MatSnackBarModule to app imports if not present

- [ ] **Task 11: Update Backend API to Return Assignees in Task List** (AC: 8)
  - [ ] Verify `GET /api/tasks` endpoint includes assignees in TaskResponseDto
  - [ ] If missing, update TasksController.GetTasks():
    - [ ] Ensure TaskService.GetTasksAsync includes assignee data
    - [ ] Map TaskAssignment entities to TaskAssignmentDto
    - [ ] Include in TaskResponseDto.Assignees property
  - [ ] If TaskResponseDto doesn't have Assignees property:
    - [ ] Add `List<TaskAssignmentDto> Assignees { get; set; }` to TaskResponseDto
    - [ ] Update mapping in TaskService

- [ ] **Task 12: Create Backend User Search Endpoint** (AC: 3)
  - [ ] Create `UsersController.cs` in `TaskFlow.Api/Controllers/` if doesn't exist:
    - [ ] Inject: IUserService (or IUserRepository)
    - [ ] Add `[Authorize]` attribute
    - [ ] Method: `[HttpGet("search")]` SearchUsers([FromQuery] string q)
      - [ ] Validate query parameter not empty
      - [ ] Call UserService/Repository to search by name or email
      - [ ] Return 200 OK with List<UserDto>
      - [ ] Limit results to 20 for performance
    - [ ] Method: `[HttpGet]` GetAllUsers() (optional, for small user bases)
      - [ ] Returns all active users
      - [ ] Can be replaced with search endpoint
  - [ ] Create UserDto if doesn't exist:
    - [ ] Id: Guid
    - [ ] Name: string
    - [ ] Email: string
    - [ ] AvatarUrl: string (nullable)
  - [ ] Update IUserRepository/UserRepository:
    - [ ] Method: `Task<List<User>> SearchUsersAsync(string query, int limit, CancellationToken cancellationToken)`
    - [ ] Query filters: WHERE Name LIKE '%query%' OR Email LIKE '%query%'
    - [ ] Use `.AsNoTracking()` for read-only

- [ ] **Task 13: Write Unit Tests for Frontend Components** (AC: all)
  - [ ] Create `assignee-list.component.spec.ts`:
    - [ ] Test displays correct number of visible assignees
    - [ ] Test shows +N badge when more than maxVisible
    - [ ] Test emits removeAssignee event when X clicked
    - [ ] Test shows "No assignees" placeholder when empty
  - [ ] Create `user-picker.component.spec.ts`:
    - [ ] Test search debounce works (300ms delay)
    - [ ] Test filters users correctly based on search
    - [ ] Test emits userSelected event on selection
    - [ ] Test excludes already assigned users
    - [ ] Mock UserService
  - [ ] Update `task-detail.component.spec.ts`:
    - [ ] Test toggleUserPicker shows/hides picker
    - [ ] Test onAddAssignee calls TaskService and shows notification
    - [ ] Test onRemoveAssignee shows confirmation and calls service
    - [ ] Test error handling shows error notification
    - [ ] Mock TaskService and NotificationService
  - [ ] Update `task-list.component.spec.ts`:
    - [ ] Test toggleMyTasks filters task list correctly
    - [ ] Test myTasksCount$ displays correct count
    - [ ] Test My Tasks button shows active state
    - [ ] Mock TaskService

- [ ] **Task 14: Write Backend Integration Tests** (AC: 3, 7)
  - [ ] Create or update `UsersControllerTests.cs`:
    - [ ] Test SearchUsers returns users matching query
    - [ ] Test SearchUsers filters by name and email
    - [ ] Test SearchUsers returns max 20 results
    - [ ] Test SearchUsers requires authentication
  - [ ] Update existing TasksControllerTests:
    - [ ] Test GET /api/tasks?myTasks=true returns only assigned tasks
    - [ ] Test assigned tasks includes user's created tasks
    - [ ] Test task list includes assignees array
    - [ ] Test assignees array has correct user information

- [ ] **Task 15: Manual Testing Checklist**
  - [ ] Verify assignee list displays correctly in task detail
  - [ ] Verify user picker searches users by name and email
  - [ ] Verify adding assignee works and shows notification
  - [ ] Verify removing assignee shows confirmation and works
  - [ ] Verify "My Tasks" filter shows only assigned tasks
  - [ ] Verify My Tasks count badge is accurate
  - [ ] Verify assignee avatars display in list view
  - [ ] Verify +N indicator for multiple assignees (test with 4+ assignees)
  - [ ] Verify error handling for permission denied
  - [ ] Verify error handling for user not found
  - [ ] Verify task creator auto-assigned on creation (if implemented)
  - [ ] Test with no assignees (shows "No assignees" placeholder)
  - [ ] Test responsive behavior on mobile
  - [ ] Verify accessibility (keyboard navigation, screen readers)

## Dev Notes

### Relevant Source Tree Information

**Frontend Structure:**
- `src/app/features/tasks/` - Task feature module
  - `components/` - Reusable task components (create assignee-list, user-picker here)
  - `pages/` - Task list, detail pages
- `src/app/core/services/` - Singleton services (task.service.ts, user.service.ts, notification.service.ts)
- `src/app/shared/models/` - TypeScript interfaces (User, TaskAssignmentDto)

**Backend Structure:**
- `TaskFlow.Api/Controllers/` - API endpoints (TasksController, UsersController)
- `TaskFlow.Core/Services/` - Business logic (TaskService, UserService)
- `TaskFlow.Infrastructure/Repositories/` - Data access (UserRepository)
- `TaskFlow.Abstractions/DTOs/` - Data transfer objects (UserDto, TaskAssignmentDto)
- `TaskFlow.Abstractions/Entities/` - Database entities (User, TaskAssignment)

**Key Dependencies from Story 2.4:**
- TaskAssignment entity already created (TaskId, UserId, AssignedDate, AssignedByUserId)
- Backend assignment endpoints already exist:
  - POST `/api/tasks/:id/assignments`
  - DELETE `/api/tasks/:id/assignments/:userId`
  - GET `/api/tasks/:id/assignments`
- TaskService.AssignUserAsync, UnassignUserAsync, GetTaskAssigneesAsync methods exist
- "My Tasks" filter already implemented in backend (myTasksOnly parameter)

**Integration Points:**
- This story builds frontend UI for backend assignment system from Story 2.4
- Requires User entity and basic user management (should exist from Epic 1 auth stories)
- Integrates with existing task list and detail components
- Uses existing AuthService for current user context

**Technology Patterns to Follow:**
- Use Angular Material components (mat-autocomplete, mat-chip, mat-icon, mat-snackbar)
- Use RxJS for async operations (Observable, debounceTime for search)
- Use reactive forms (FormControl for search input)
- Follow container/presentational pattern (assignee-list is presentational)
- Use HTTP interceptor for auth headers (already configured)
- Use error handling interceptor (already configured)

### Testing

**Frontend Testing Standards:**
- Use Jasmine + Karma for unit tests
- Location: `src/app/features/tasks/components/*.spec.ts`
- Mock all services using jasmine.createSpyObj
- Test component inputs/outputs isolation
- Test error scenarios and edge cases
- Use async pipe in tests (no manual subscriptions)
- Run tests: `npm test`

**Backend Testing Standards:**
- Use xUnit for integration tests
- Location: `TaskFlow.Tests/Integration/Controllers/UsersControllerTests.cs`
- Use WebApplicationFactory for integration tests
- Mock authentication using test JWT tokens
- Test API endpoints end-to-end with test database
- Verify status codes and response bodies
- Run tests: `dotnet test`

**Code Coverage Goals:**
- Frontend: 80% minimum for new components
- Backend: 90% minimum for new endpoints
- Focus on critical paths (assignment add/remove, filtering)

**Manual Testing Focus:**
- Test with multiple users (3+) for avatar stacking
- Test permission scenarios (non-owner trying to assign)
- Test search performance with 20+ users
- Test My Tasks filter with mixed assigned/created tasks
- Verify notifications are user-friendly and clear

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-29 | 1.0 | Initial story creation for Epic 2 assignment UI | Sarah (PO) |
