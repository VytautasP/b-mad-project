# Story 3.4: Gantt Chart Library Integration

## Status

Draft

## Story

**As a** user,
**I want** to see my tasks displayed in a visual timeline/Gantt chart,
**so that** I can understand project schedules and deadlines visually.

## Acceptance Criteria

1. Open-source Gantt library evaluated and selected (Frappe Gantt, DHTMLX Gantt free tier, or ng-gantt) based on MIT/Apache license, TypeScript support, and customizability
2. Gantt library integrated into Angular project with npm package installation
3. Timeline view page created accessible from main navigation ("Timeline" or "Gantt" menu item)
4. Gantt chart renders tasks as horizontal bars positioned by CreatedDate (start) and DueDate (end)
5. Task bars display task name overlaid or beside bar
6. Task bars color-coded by status: To Do (gray), In Progress (blue), Blocked (red), Waiting (yellow), Done (green)
7. Y-axis displays task names or hierarchy structure (rows per task)
8. X-axis displays date scale with configurable view (day, week, month)
9. Parent-child relationships visualized (indentation, dependency lines, or parent bars spanning children)
10. Today indicator line shown on chart (vertical line highlighting current date)
11. Tasks load from API using timeline endpoint with date range matching visible viewport
12. Loading state displayed while fetching timeline data
13. Empty state displayed when no tasks have due dates ("Add due dates to see tasks in timeline")
14. Gantt renders without performance issues for 50 tasks

## Tasks / Subtasks

- [ ] **Task 1: Research and Select Gantt Library** (AC: 1)
  - [ ] Evaluate Frappe Gantt (https://frappe.io/gantt):
    - [ ] Check license (MIT), TypeScript support, npm package availability
    - [ ] Review documentation for Angular integration examples
    - [ ] Test customization options (colors, date scales, click handlers)
    - [ ] Verify active maintenance (last commit date, issue response rate)
  - [ ] Evaluate DHTMLX Gantt free tier:
    - [ ] Check license restrictions (GPL for free tier vs commercial)
    - [ ] Review TypeScript definitions and Angular integration
    - [ ] Test feature limitations in free tier
  - [ ] Evaluate ng-gantt or other Angular-specific libraries:
    - [ ] Check npm downloads and community support
    - [ ] Review Angular compatibility (Angular 20 standalone components)
  - [ ] Document comparison table (license, TypeScript support, features, maintenance)
  - [ ] Select library based on: MIT/Apache license, TypeScript support, customizability, Angular compatibility
  - [ ] Get approval from team/PO if needed before proceeding

- [ ] **Task 2: Install Gantt Library and Setup Component** (AC: 2, 3)
  - [ ] Install selected Gantt library via npm: `npm install [library-name] --save`
  - [ ] Install TypeScript definitions if needed: `npm install @types/[library-name] --save-dev`
  - [ ] Create timeline feature route in `src/app/features/tasks/`:
    - [ ] Create directory: `src/app/features/tasks/timeline/`
    - [ ] Create component: `timeline.component.ts`, `timeline.component.html`, `timeline.component.scss`
    - [ ] Generate standalone component with Angular CLI: `ng generate component features/tasks/timeline --standalone`
  - [ ] Register timeline route in `app.routes.ts`:
    - [ ] Add route: `{ path: 'timeline', loadComponent: () => import('./features/tasks/timeline/timeline.component').then(m => m.TimelineComponent), canActivate: [AuthGuard] }`
  - [ ] Add "Timeline" navigation menu item in main navigation component (header/sidebar)
  - [ ] Import Gantt library CSS in component or global styles
  - [ ] Verify navigation to timeline page works and component renders

- [ ] **Task 3: Create Timeline Data Service Method** (AC: 11)
  - [ ] Update `src/app/features/tasks/services/task.service.ts`:
    - [ ] Add interface for timeline query params: `TimelineQueryParams { startDate: string, endDate: string, assigneeId?: string, status?: string, priority?: string }`
    - [ ] Add interface for timeline task response: `TimelineTask { id: string, name: string, startDate: string, endDate: string, duration: number, status: TaskStatus, priority: TaskPriority, parentTaskId?: string, assignees: TaskAssignee[] }`
    - [ ] Add method: `getTimelineTasks(params: TimelineQueryParams): Observable<TimelineTask[]>`
    - [ ] Build query string from params: `?view=timeline&startDate=${params.startDate}&endDate=${params.endDate}&...`
    - [ ] Make HTTP GET request to `/api/tasks` with query params
    - [ ] Return Observable<TimelineTask[]> with timeline data
    - [ ] Use existing error handling via HTTP interceptor
  - [ ] Test service method manually with Postman or browser DevTools

- [ ] **Task 4: Render Basic Gantt Chart with Timeline Data** (AC: 4, 5, 7, 8, 11, 12, 14)
  - [ ] In `timeline.component.ts`:
    - [ ] Inject TaskService via constructor
    - [ ] Add component properties: `tasks: TimelineTask[] = []`, `isLoading = false`
    - [ ] Calculate default date range (e.g., current month: start = first day of month, end = last day of month)
    - [ ] In `ngOnInit()`, call `loadTimelineData(startDate, endDate)`
    - [ ] Implement `loadTimelineData(start: Date, end: Date)` method:
      - [ ] Set `isLoading = true`
      - [ ] Format dates as ISO strings for API
      - [ ] Call `taskService.getTimelineTasks({ startDate, endDate })`
      - [ ] Subscribe to observable, set `tasks` property, set `isLoading = false`
      - [ ] Handle errors (show error message if API fails)
  - [ ] Transform TimelineTask data to Gantt library format:
    - [ ] Map `tasks` array to format required by selected library (typically: `{ id, name, start, end, dependencies, ... }`)
    - [ ] Convert ISO date strings to Date objects if needed
  - [ ] Initialize Gantt chart after data loads:
    - [ ] In template, add container element: `<div #ganttContainer class="gantt-chart"></div>`
    - [ ] Use `@ViewChild('ganttContainer')` to get reference to container
    - [ ] After data loads, call Gantt library initialization API with container and transformed data
    - [ ] Configure X-axis scale (default: week view)
    - [ ] Configure Y-axis to show task names
  - [ ] Test rendering with 10-50 test tasks, verify performance is acceptable

- [ ] **Task 5: Implement Status Color Coding and Today Indicator** (AC: 6, 10)
  - [ ] Add task bar color mapping function:
    - [ ] Create method: `getTaskColor(status: TaskStatus): string`
    - [ ] Return colors: To Do → '#808080' (gray), In Progress → '#3b82f6' (blue), Blocked → '#ef4444' (red), Waiting → '#eab308' (yellow), Done → '#22c55e' (green)
  - [ ] Configure Gantt library to use custom colors:
    - [ ] Pass color mapping function to library configuration (library-specific API)
    - [ ] Or apply custom CSS classes based on status and style via SCSS
  - [ ] Add today indicator line:
    - [ ] Check if library has built-in "today" marker feature
    - [ ] If yes, enable it in configuration
    - [ ] If no, add custom vertical line overlay:
      - [ ] Calculate today's position on X-axis relative to date range
      - [ ] Add `<div class="today-line"></div>` positioned absolutely at calculated X position
      - [ ] Style with CSS: vertical red/blue line, full height, z-index above chart
  - [ ] Verify colors display correctly for each status
  - [ ] Verify today line appears at correct date position

- [ ] **Task 6: Implement Parent-Child Hierarchy Visualization** (AC: 9)
  - [ ] Check if selected library supports hierarchy/groups natively:
    - [ ] If yes, configure hierarchy field (e.g., `parentId` or `dependencies`)
    - [ ] Pass `parentTaskId` from TimelineTask data to library
  - [ ] If library supports indentation:
    - [ ] Enable indentation option to show parent/child levels visually
  - [ ] If library supports dependency lines:
    - [ ] Configure dependency rendering between parent and child bars
  - [ ] If library doesn't support hierarchy well:
    - [ ] Consider visual workaround: group tasks by parent, or display parent bars spanning children manually
  - [ ] Test with hierarchical test data (parent task with 2-3 children)
  - [ ] Verify parent-child relationships are visually clear

- [ ] **Task 7: Add Loading and Empty States** (AC: 12, 13)
  - [ ] In `timeline.component.html`:
    - [ ] Add loading spinner: `<div *ngIf="isLoading" class="loading-spinner">Loading timeline...</div>`
    - [ ] Use shared LoadingSpinnerComponent if available: `<app-loading-spinner *ngIf="isLoading" />`
  - [ ] Add empty state message:
    - [ ] Check if `tasks.length === 0` after loading
    - [ ] Display empty state component: `<app-empty-state *ngIf="!isLoading && tasks.length === 0" message="Add due dates to see tasks in timeline" icon="calendar" />`
    - [ ] Or create inline empty state: `<div *ngIf="!isLoading && tasks.length === 0" class="empty-state">...</div>`
  - [ ] Conditionally render Gantt chart only when tasks exist: `<div #ganttContainer *ngIf="!isLoading && tasks.length > 0"></div>`
  - [ ] Test loading state by adding artificial delay
  - [ ] Test empty state by querying date range with no tasks

- [ ] **Task 8: Configure Date Scale Views** (AC: 8)
  - [ ] Add view mode controls (buttons or dropdown):
    - [ ] Add to template: "Day", "Week", "Month" buttons above Gantt chart
    - [ ] Add component property: `viewMode: 'day' | 'week' | 'month' = 'week'`
  - [ ] Implement view mode change handler:
    - [ ] Method: `changeViewMode(mode: 'day' | 'week' | 'month')`
    - [ ] Update `viewMode` property
    - [ ] Re-initialize Gantt chart with new scale configuration
    - [ ] Or call library API to update scale dynamically (if supported)
  - [ ] Verify X-axis granularity changes correctly:
    - [ ] Day view: X-axis shows individual days
    - [ ] Week view: X-axis shows weeks
    - [ ] Month view: X-axis shows months
  - [ ] Highlight active view mode button (CSS active state)

- [ ] **Task 9: Manual Testing and Performance Validation** (AC: 14)
  - [ ] Test with 10 tasks: verify rendering is instant
  - [ ] Test with 50 tasks: verify rendering completes in <2 seconds
  - [ ] Test with 100+ tasks: identify any performance issues
  - [ ] Test with various date ranges (1 week, 1 month, 3 months)
  - [ ] Test with deeply nested hierarchies (parent → child → grandchild)
  - [ ] Test all status colors display correctly
  - [ ] Test today line appears at current date
  - [ ] Test empty state when no tasks in range
  - [ ] Test loading state during API fetch
  - [ ] Test navigation to/from timeline view
  - [ ] Test responsive behavior on mobile (read-only acceptable for this story)
  - [ ] Document any performance bottlenecks or visual issues

## Dev Notes

### Existing System Integration

This story creates a new **Timeline view feature** in the Angular frontend, consuming the timeline API endpoint built in Story 3.3. The Gantt chart visualizes task data optimized for date-based rendering, leveraging existing task hierarchy and status models.

**Key Integration Points:**
- **API Endpoint**: Uses `GET /api/tasks?view=timeline&startDate=...&endDate=...` from Story 3.3
- **Task Service**: Extends `TaskService.ts` (from Story 1.5) with new `getTimelineTasks()` method
- **Task Models**: Uses `TimelineTask` interface matching `TimelineTaskDto` from backend (Story 3.3)
- **Navigation**: Adds new route in `app.routes.ts` (existing routing structure from Story 1.3)
- **Authentication**: Timeline route protected by `AuthGuard` (from Story 1.3)
- **Shared Components**: Uses `LoadingSpinnerComponent` and `EmptyStateComponent` from shared components (Story 1.5)
- **Status Enum**: Uses existing `TaskStatus` enum for color-coding (from Story 1.4)
- **Hierarchy**: Visualizes `ParentTaskId` relationships (from Story 2.1)

### Technology Stack

- **Frontend Framework**: Angular 20 (standalone components)
- **Language**: TypeScript 5.9.3
- **HTTP Client**: Angular HttpClient (built-in)
- **Gantt Library**: TBD - Frappe Gantt (likely choice), DHTMLX Gantt, or ng-gantt
- **Styling**: Tailwind CSS + Angular Material + custom SCSS
- **State Management**: RxJS Observables via service layer

### Existing Patterns to Follow

**Component Structure** (from Story 1.5, Story 2.2):
- Standalone component with explicit imports
- Separate `.ts`, `.html`, `.scss` files
- Smart component pattern: Timeline component handles API calls and business logic
- Inject services via constructor: `constructor(private taskService: TaskService) {}`
- Use `ngOnInit()` for data loading
- Use `async pipe` in templates for observables to prevent memory leaks

**Service Pattern** (from Story 1.5):
- Service methods return `Observable<T>`
- Use Angular HttpClient for API calls
- Error handling via HTTP interceptor (centralized)
- Type-safe interfaces for request params and responses
- No direct error handling in service (interceptor handles global errors)

**Routing Pattern** (from Story 1.3):
- Lazy-loaded routes with `loadComponent`
- Protected routes with `canActivate: [AuthGuard]`
- Route definitions in `app.routes.ts`

**Loading/Empty States** (from Story 1.5, Story 2.2):
- Use shared `LoadingSpinnerComponent` for loading states
- Use shared `EmptyStateComponent` for empty states
- Component properties: `isLoading: boolean`, `tasks: Task[]`
- Conditional rendering with `*ngIf` directives

**File Organization** (from Frontend Architecture):
```
src/app/features/tasks/
├── services/
│   └── task.service.ts (extend with getTimelineTasks method)
├── timeline/
│   ├── timeline.component.ts
│   ├── timeline.component.html
│   └── timeline.component.scss
```

**Color Coding Pattern**:
Follow existing status colors from application (ensure consistency with list view colors from Story 3.2):
- To Do: Gray (#808080)
- In Progress: Blue (#3b82f6)
- Blocked: Red (#ef4444)
- Waiting: Yellow (#eab308)
- Done: Green (#22c55e)

### Technical Notes

**Gantt Library Selection Criteria**:
1. **License**: Must be MIT or Apache (no GPL restrictions for commercial use)
2. **TypeScript Support**: TypeScript definitions available or good JavaScript API
3. **Angular Compatibility**: Works with Angular 20 (no NgModule dependencies)
4. **Customization**: Supports custom colors, date scales, click handlers
5. **Maintenance**: Active development (commits within last 6 months)
6. **Bundle Size**: Minimal impact on app bundle (<100KB preferred)

**Recommended: Frappe Gantt**
- License: MIT
- TypeScript: Community types available
- Simple API: Vanilla JS, easy Angular integration
- Lightweight: ~15KB minified
- Active: Regular updates
- Limitations: Basic features only (no drag-drop in this story)

**Integration Approach**:
- Install via npm: `npm install frappe-gantt`
- Import in component: `import Gantt from 'frappe-gantt'`
- Initialize after view init: Use `ngAfterViewInit()` and `@ViewChild` to get container ref
- Data format: Transform `TimelineTask[]` to Frappe format:
  ```typescript
  {
    id: task.id,
    name: task.name,
    start: new Date(task.startDate),
    end: new Date(task.endDate),
    progress: 0,
    custom_class: this.getStatusClass(task.status)
  }
  ```

**Date Range Handling**:
- Default view: Current month (first day to last day)
- User can change range in future story (3.5 - interactive features)
- For this story, use fixed monthly view for simplicity

**Performance Considerations**:
- Gantt libraries can struggle with >200 tasks
- Story 3.3 backend limits response to 100 tasks per query (pagination)
- For 50 tasks, rendering should be <500ms
- If performance issues, consider virtual scrolling or pagination in future story

**Rollback Plan**:
- If Gantt library integration fails or performance is poor:
  - Remove npm package
  - Remove timeline component and route
  - Revert changes to TaskService
  - Timeline feature can be delayed to next sprint
- No database changes, so rollback is frontend-only (low risk)

### Testing

#### Manual Testing Checklist
- [ ] Timeline page loads via navigation menu
- [ ] Gantt chart renders with test data (50 tasks)
- [ ] Task bars display task names
- [ ] Task bars colored correctly by status (all 5 statuses)
- [ ] X-axis shows date scale (week view)
- [ ] Y-axis shows task names
- [ ] Today line appears at current date
- [ ] Loading spinner shows during API call
- [ ] Empty state shows when no tasks have due dates
- [ ] Parent-child hierarchy visible (if applicable)
- [ ] View mode buttons (Day/Week/Month) change scale
- [ ] Performance acceptable (<2s for 50 tasks)
- [ ] No console errors
- [ ] Responsive layout (mobile view acceptable as read-only)

#### Unit Testing Standards (from Architecture)
**Test File Location**: `src/app/features/tasks/timeline/timeline.component.spec.ts`

**Testing Framework**: Jasmine + Karma (Angular default)

**Test Coverage Requirements**:
- Component initialization (ngOnInit)
- Data loading method (loadTimelineData)
- Service integration (mocked TaskService)
- Data transformation (TimelineTask → Gantt format)
- Color mapping function (getTaskColor)
- View mode changes
- Loading state handling
- Empty state handling
- Error handling (API failure)

**Testing Patterns**:
```typescript
describe('TimelineComponent', () => {
  let component: TimelineComponent;
  let fixture: ComponentFixture<TimelineComponent>;
  let taskService: jasmine.SpyObj<TaskService>;

  beforeEach(async () => {
    const taskServiceSpy = jasmine.createSpyObj('TaskService', ['getTimelineTasks']);
    
    await TestBed.configureTestingModule({
      imports: [TimelineComponent],
      providers: [
        { provide: TaskService, useValue: taskServiceSpy }
      ]
    }).compileComponents();
    
    fixture = TestBed.createComponent(TimelineComponent);
    component = fixture.componentInstance;
    taskService = TestBed.inject(TaskService) as jasmine.SpyObj<TaskService>;
  });

  it('should load timeline data on init', () => {
    const mockTasks = [/* mock TimelineTask data */];
    taskService.getTimelineTasks.and.returnValue(of(mockTasks));
    
    component.ngOnInit();
    
    expect(taskService.getTimelineTasks).toHaveBeenCalled();
    expect(component.tasks).toEqual(mockTasks);
    expect(component.isLoading).toBe(false);
  });

  it('should map status to correct color', () => {
    expect(component.getTaskColor(TaskStatus.InProgress)).toBe('#3b82f6');
    expect(component.getTaskColor(TaskStatus.Done)).toBe('#22c55e');
    // ... test all statuses
  });

  // ... more tests
});
```

**Note**: Full unit tests can be written after implementation. For this brownfield story, focus on integration testing via manual QA first, then add unit tests for regression protection.

### Key Constraints

- This is a **visualization-only** story - no editing features (drag-drop, date changes)
- Interactive features (dragging bars, zooming) are in Story 3.5
- Timeline view is **read-only** in this story
- Mobile view can be simplified or read-only (responsive improvements in future stories)
- Gantt library must be **open-source** with permissive license (MIT/Apache, not GPL)

### Success Criteria

This story is successful when:
1. Gantt library selected, installed, and documented
2. Timeline view page accessible from main navigation
3. Tasks render as horizontal bars with names and status colors
4. Date scale (X-axis) and task names (Y-axis) displayed correctly
5. Today indicator line shown at current date
6. Loading and empty states handled gracefully
7. Performance acceptable for 50 tasks (<2s render time)
8. Hierarchy visualization implemented (basic indentation or grouping)
9. No console errors, clean code following Angular patterns
10. Ready for interactive features in Story 3.5

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
