# Story 1.2: User Registration and Authentication Backend

## Status

Ready for Review

## Story

**As a** new user,
**I want** to register with email and password and securely log in,
**so that** I can access my personal task data with confidence that it's protected.

## Acceptance Criteria

1. User entity created in database with fields: Id (GUID), Email (unique, indexed), PasswordHash, Name, ProfileImageUrl (nullable), CreatedDate
2. Registration endpoint (POST /api/auth/register) accepts email, password, name and returns success/error
3. Password validation enforces minimum 8 characters, at least one uppercase, one lowercase, one number
4. Passwords hashed using bcrypt or ASP.NET Core Identity password hasher before storage
5. Login endpoint (POST /api/auth/login) accepts email/password and returns JWT bearer token on success
6. JWT token includes user ID, email, and expiration (24 hours from issue)
7. JWT secret key configured via environment variable (not hardcoded)
8. Authentication failures return appropriate HTTP status codes (400 for validation, 401 for invalid credentials)
9. Duplicate email registration returns 409 Conflict with clear error message
10. Unit tests cover password hashing, JWT generation, and validation logic
11. Integration tests validate registration and login flows with in-memory database

## Tasks / Subtasks

- [x] **Task 1: Create User Entity and Database Schema** (AC: 1)
  - [x] Create User.cs entity in TaskFlow.Abstractions/Entities/
    - [x] Add properties: Id (Guid), Email (string, required), PasswordHash (string, required), Name (string, required), ProfileImageUrl (string, nullable), CreatedDate (DateTime)
  - [x] Create UserConfiguration.cs in TaskFlow.Infrastructure/Configurations/
    - [x] Configure Email as unique index
    - [x] Set max lengths (Email: 255, Name: 200, PasswordHash: 255, ProfileImageUrl: 500)
    - [x] Configure CreatedDate with default value
  - [x] Add DbSet<User> Users to ApplicationDbContext.cs
  - [x] Create and apply EF Core migration for User table
  - [x] Verify migration creates users table with unique index on email column

- [x] **Task 2: Create DTOs for Authentication** (AC: 2, 5)
  - [x] Create RegisterDto.cs in TaskFlow.Abstractions/DTOs/Auth/
    - [x] Properties: Email (string, required, EmailAddress attribute), Password (string, required, MinLength 8), Name (string, required)
  - [x] Create LoginDto.cs in TaskFlow.Abstractions/DTOs/Auth/
    - [x] Properties: Email (string, required), Password (string, required)
  - [x] Create AuthResponseDto.cs in TaskFlow.Abstractions/DTOs/Auth/
    - [x] Properties: Token (string), UserId (Guid), Email (string), Name (string), ExpiresAt (DateTime)

- [x] **Task 3: Implement Password Hashing Service** (AC: 4)
  - [x] Create IPasswordHasher.cs interface in TaskFlow.Abstractions/Interfaces/Services/
    - [x] Method: string HashPassword(string password)
    - [x] Method: bool VerifyPassword(string password, string hashedPassword)
  - [x] Create PasswordHasher.cs in TaskFlow.Infrastructure/Services/
    - [x] Use ASP.NET Core Identity PasswordHasher<User> or BCrypt.Net
    - [x] Implement HashPassword method
    - [x] Implement VerifyPassword method
  - [x] Register IPasswordHasher in dependency injection (singleton lifetime)

- [x] **Task 4: Implement JWT Token Service** (AC: 6, 7)
  - [x] Create JwtSettings class in TaskFlow.Abstractions/Constants/
    - [x] Properties: SecretKey, Issuer, Audience, ExpirationMinutes
  - [x] Create IJwtTokenService.cs interface in TaskFlow.Abstractions/Interfaces/Services/
    - [x] Method: string GenerateToken(User user)
    - [x] Method: ClaimsPrincipal? ValidateToken(string token)
  - [x] Create JwtTokenService.cs in TaskFlow.Infrastructure/Services/
    - [x] Inject IConfiguration to read JWT settings from environment variables
    - [x] Implement GenerateToken with claims: UserId (NameIdentifier), Email, Name
    - [x] Set token expiration to 24 hours (1440 minutes)
    - [x] Implement ValidateToken method
  - [x] Add JWT settings to appsettings.json (SecretKey placeholder)
  - [x] Configure JWT authentication in Program.cs using JWT_SECRET environment variable

- [x] **Task 5: Implement User Repository** (AC: 1, 9)
  - [x] Create IUserRepository.cs interface in TaskFlow.Abstractions/Interfaces/Repositories/
    - [x] Method: Task<User?> GetByEmailAsync(string email, CancellationToken ct)
    - [x] Method: Task<User?> GetByIdAsync(Guid id, CancellationToken ct)
    - [x] Method: Task<bool> EmailExistsAsync(string email, CancellationToken ct)
    - [x] Method: Task<User> CreateAsync(User user, CancellationToken ct)
  - [x] Create UserRepository.cs in TaskFlow.Infrastructure/Repositories/
    - [x] Implement all interface methods using ApplicationDbContext
    - [x] Use AsNoTracking for read queries
    - [x] Ensure CreateAsync sets Id and CreatedDate if not provided
  - [x] Add IUserRepository to IUnitOfWork interface
  - [x] Register UserRepository in UnitOfWork implementation

- [x] **Task 6: Implement Authentication Service** (AC: 2, 3, 5, 8, 9)
  - [x] Create IAuthService.cs interface in TaskFlow.Abstractions/Interfaces/Services/
    - [x] Method: Task<AuthResponseDto> RegisterAsync(RegisterDto dto, CancellationToken ct)
    - [x] Method: Task<AuthResponseDto> LoginAsync(LoginDto dto, CancellationToken ct)
  - [x] Create AuthService.cs in TaskFlow.Core/Services/
    - [x] Inject IUnitOfWork, IPasswordHasher, IJwtTokenService, ILogger
    - [x] Implement RegisterAsync:
      - [x] Validate password strength (min 8 chars, uppercase, lowercase, number) - AC 3
      - [x] Check if email already exists using UserRepository.EmailExistsAsync
      - [x] Throw ValidationException with 409 status if email exists - AC 9
      - [x] Hash password using IPasswordHasher
      - [x] Create User entity and save via repository
      - [x] Generate JWT token
      - [x] Return AuthResponseDto with token and user info
    - [x] Implement LoginAsync:
      - [x] Find user by email using UserRepository.GetByEmailAsync
      - [x] Return 401 if user not found or password invalid - AC 8
      - [x] Verify password using IPasswordHasher.VerifyPassword
      - [x] Generate JWT token if valid
      - [x] Return AuthResponseDto
  - [x] Register IAuthService in dependency injection (scoped lifetime)

- [x] **Task 7: Create Authentication Controller** (AC: 2, 5, 8)
  - [x] Create AuthController.cs in TaskFlow.Api/Controllers/
    - [x] Add [ApiController], [Route("api/auth")] attributes
    - [x] Inject IAuthService and ILogger
    - [x] Create POST register endpoint:
      - [x] Route: [HttpPost("register")]
      - [x] Accept RegisterDto from body
      - [x] Call AuthService.RegisterAsync
      - [x] Return 201 Created with AuthResponseDto on success
      - [x] Return 400 for validation errors - AC 8
      - [x] Return 409 for duplicate email - AC 9
    - [x] Create POST login endpoint:
      - [x] Route: [HttpPost("login")]
      - [x] Accept LoginDto from body
      - [x] Call AuthService.LoginAsync
      - [x] Return 200 OK with AuthResponseDto on success
      - [x] Return 401 for invalid credentials - AC 8

- [x] **Task 8: Configure Global Exception Handling** (AC: 8, 9)
  - [x] Create custom exceptions in TaskFlow.Abstractions/Exceptions/:
    - [x] ValidationException.cs with StatusCode property (400)
    - [x] UnauthorizedException.cs with StatusCode property (401)
    - [x] ConflictException.cs with StatusCode property (409)
  - [x] Create ErrorHandlingMiddleware.cs in TaskFlow.Api/Middleware/
    - [x] Catch all exceptions in HTTP pipeline
    - [x] Map custom exceptions to appropriate HTTP status codes
    - [x] Return consistent error response format (ErrorResponseDto)
    - [x] Log exceptions with correlation ID
  - [x] Register ErrorHandlingMiddleware in Program.cs pipeline

- [x] **Task 9: Write Unit Tests** (AC: 10)
  - [x] Create PasswordHasherTests.cs in TaskFlow.Tests/Unit/Services/
    - [x] Test HashPassword returns different hash for same password
    - [x] Test VerifyPassword returns true for matching password
    - [x] Test VerifyPassword returns false for wrong password
  - [x] Create JwtTokenServiceTests.cs in TaskFlow.Tests/Unit/Services/
    - [x] Test GenerateToken creates valid JWT with correct claims
    - [x] Test token expiration is 24 hours
    - [x] Test ValidateToken extracts user ID correctly
  - [x] Create AuthServiceTests.cs in TaskFlow.Tests/Unit/Services/
    - [x] Test RegisterAsync validates password requirements
    - [x] Test RegisterAsync throws ConflictException for duplicate email
    - [x] Test RegisterAsync hashes password before storing
    - [x] Test LoginAsync returns token for valid credentials
    - [x] Test LoginAsync throws UnauthorizedException for invalid credentials

- [x] **Task 10: Write Integration Tests** (AC: 11)
  - [x] Create AuthControllerTests.cs in TaskFlow.Tests/Integration/Controllers/
    - [x] Setup: Configure WebApplicationFactory with in-memory database
    - [x] Test POST /api/auth/register with valid data returns 201 and token
    - [x] Test POST /api/auth/register with duplicate email returns 409
    - [x] Test POST /api/auth/register with weak password returns 400
    - [x] Test POST /api/auth/login with valid credentials returns 200 and token
    - [x] Test POST /api/auth/login with invalid email returns 401
    - [x] Test POST /api/auth/login with wrong password returns 401
    - [x] Test JWT token includes correct user ID and email claims
    - [x] Test user can be retrieved from database after registration

## Dev Notes

### Relevant Source Tree

**TaskFlow.Abstractions/** (Shared contracts - no dependencies)
- `Entities/User.cs` - User domain entity
- `DTOs/Auth/RegisterDto.cs` - Registration request DTO
- `DTOs/Auth/LoginDto.cs` - Login request DTO
- `DTOs/Auth/AuthResponseDto.cs` - Authentication response with JWT token
- `DTOs/Shared/ErrorResponseDto.cs` - Standard error response format
- `Interfaces/Services/IAuthService.cs` - Authentication service contract
- `Interfaces/Services/IPasswordHasher.cs` - Password hashing contract
- `Interfaces/Services/IJwtTokenService.cs` - JWT token generation contract
- `Interfaces/Repositories/IUserRepository.cs` - User data access contract
- `Exceptions/ValidationException.cs` - Custom validation exception
- `Exceptions/UnauthorizedException.cs` - Custom authentication exception
- `Exceptions/ConflictException.cs` - Custom conflict exception
- `Constants/JwtSettings.cs` - JWT configuration settings

**TaskFlow.Core/** (Business logic)
- `Services/AuthService.cs` - Authentication business logic (registration, login, validation)

**TaskFlow.Infrastructure/** (Data access & external services)
- `Data/ApplicationDbContext.cs` - EF Core DbContext (add DbSet<User>)
- `Configurations/UserConfiguration.cs` - User entity EF Core configuration
- `Repositories/UserRepository.cs` - User database operations
- `Services/PasswordHasher.cs` - Password hashing implementation (BCrypt or ASP.NET Core Identity)
- `Services/JwtTokenService.cs` - JWT token generation and validation

**TaskFlow.Api/** (Presentation layer)
- `Controllers/AuthController.cs` - Authentication HTTP endpoints
- `Middleware/ErrorHandlingMiddleware.cs` - Global exception handling
- `Program.cs` - JWT authentication configuration, DI registration

**TaskFlow.Tests/**
- `Unit/Services/PasswordHasherTests.cs` - Password hashing unit tests
- `Unit/Services/JwtTokenServiceTests.cs` - JWT token unit tests
- `Unit/Services/AuthServiceTests.cs` - Authentication service unit tests
- `Integration/Controllers/AuthControllerTests.cs` - End-to-end auth flow tests

### Architecture Patterns

**Clean Architecture Layers:**
- **Abstractions**: Defines contracts (interfaces, DTOs, entities, exceptions) - no dependencies
- **Core**: Business logic (AuthService) - depends only on Abstractions
- **Infrastructure**: Data access (UserRepository, ApplicationDbContext) and external services (PasswordHasher, JwtTokenService) - depends on Abstractions
- **Api**: HTTP layer (AuthController, middleware) - depends on all layers

**Repository Pattern:**
- UserRepository encapsulates all database access for User entity
- IUserRepository interface in Abstractions enables testing and decoupling
- Use Unit of Work pattern for transaction management across repositories

**Dependency Injection:**
- Register all services in Program.cs or ServiceCollectionExtensions
- Use appropriate lifetimes:
  - Scoped: AuthService, UserRepository (per HTTP request)
  - Singleton: PasswordHasher, JwtTokenService (stateless)
  - Transient: Not needed for this story

### Security Considerations

**Password Storage:**
- NEVER store plain text passwords
- Use ASP.NET Core Identity PasswordHasher (PBKDF2 with HMAC-SHA256, 10,000 iterations) or BCrypt.Net
- PasswordHasher automatically includes salt in hash (no need to store separately)

**JWT Configuration:**
- JWT secret key MUST be at least 256 bits (32 characters) for HS256 algorithm
- Store secret in environment variable (JWT_SECRET), never in appsettings.json or code
- Set token expiration to 24 hours per AC 6
- Include minimal claims: UserId (NameIdentifier), Email, Name
- Issuer and Audience should match application name ("TaskFlow")

**Validation:**
- Data Annotations on DTOs provide basic validation (Required, EmailAddress, MinLength)
- Additional business logic validation in AuthService (password complexity)
- Use ModelState.IsValid in controller (automatic with [ApiController] attribute)

**Error Responses:**
- Return 400 Bad Request for validation errors (invalid format, missing fields)
- Return 401 Unauthorized for authentication failures (wrong password, user not found)
- Return 409 Conflict for duplicate email registration
- Never leak information in error messages (don't say "email exists" vs "password wrong")
- Use consistent error response format (ErrorResponseDto)

### Database Schema

**Users Table:**
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(200) NOT NULL,
    profile_image_url VARCHAR(500) NULL,
    created_date TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_date ON users(created_date);
```

**Entity Framework Configuration:**
- Use Fluent API in UserConfiguration.cs (not Data Annotations in entity)
- Set HasIndex(u => u.Email).IsUnique() for email uniqueness
- Set max lengths for all string properties to prevent DB errors
- Configure CreatedDate with default value: HasDefaultValueSql("NOW()")

### JWT Token Structure

**Claims:**
```csharp
var claims = new[]
{
    new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
    new Claim(ClaimTypes.Email, user.Email),
    new Claim(ClaimTypes.Name, user.Name),
    new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString()) // Token ID
};
```

**Configuration in Program.cs:**
```csharp
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = builder.Configuration["JwtSettings:Issuer"],
            ValidAudience = builder.Configuration["JwtSettings:Audience"],
            IssuerSigningKey = new SymmetricSecurityKey(
                Encoding.UTF8.GetBytes(Environment.GetEnvironmentVariable("JWT_SECRET")!))
        };
    });
```

**Important Notes:**
- Use Environment.GetEnvironmentVariable("JWT_SECRET") for production
- For development, can use user secrets or appsettings.Development.json
- Add app.UseAuthentication() and app.UseAuthorization() to middleware pipeline

### Password Validation Rules (AC 3)

Enforce in AuthService.RegisterAsync:
- Minimum 8 characters
- At least one uppercase letter (A-Z)
- At least one lowercase letter (a-z)
- At least one digit (0-9)

```csharp
private bool IsPasswordValid(string password)
{
    if (password.Length < 8) return false;
    if (!password.Any(char.IsUpper)) return false;
    if (!password.Any(char.IsLower)) return false;
    if (!password.Any(char.IsDigit)) return false;
    return true;
}
```

### API Endpoint Examples

**POST /api/auth/register**
Request:
```json
{
  "email": "user@example.com",
  "password": "SecurePass123",
  "name": "John Doe"
}
```

Response (201 Created):
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "userId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "email": "user@example.com",
  "name": "John Doe",
  "expiresAt": "2026-01-24T12:00:00Z"
}
```

**POST /api/auth/login**
Request:
```json
{
  "email": "user@example.com",
  "password": "SecurePass123"
}
```

Response (200 OK): Same as register response

**Error Response (400/401/409):**
```json
{
  "message": "Email already exists",
  "statusCode": 409,
  "traceId": "0HMVFE42N5V1J:00000001"
}
```

### Dependencies to Add

**NuGet Packages:**
- `Microsoft.AspNetCore.Authentication.JwtBearer` (8.0.x) - JWT authentication
- `Microsoft.AspNetCore.Identity.EntityFrameworkCore` (8.0.x) - Password hashing
- Alternative: `BCrypt.Net-Next` (4.0.x) - Simpler password hashing library
- `System.IdentityModel.Tokens.Jwt` (7.x) - JWT token generation (included with JwtBearer)

**Testing Packages:**
- `Microsoft.AspNetCore.Mvc.Testing` (8.0.x) - Integration testing
- `Microsoft.EntityFrameworkCore.InMemory` (8.0.x) - In-memory database for tests

### Testing Standards

**Unit Test Location:**
- `TaskFlow.Tests/Unit/Services/` for service tests
- Follow naming: `{ClassName}Tests.cs`
- Test method naming: `MethodName_Scenario_ExpectedResult`

**Integration Test Location:**
- `TaskFlow.Tests/Integration/Controllers/` for API tests
- Use WebApplicationFactory<Program> to create test server
- Configure in-memory database for isolation

**Test Frameworks:**
- xUnit 2.6+ for test framework
- Moq 4.20+ for mocking dependencies
- FluentAssertions 6.12+ for readable assertions (optional)

**Coverage Requirements:**
- All service methods must have unit tests
- All controller endpoints must have integration tests
- Critical paths (authentication, validation) require multiple test cases

### Important Implementation Notes

1. **Do NOT use ASP.NET Core Identity framework** - too heavyweight for MVP. Only use PasswordHasher class from Identity package
2. **User entity is POCO** - no inheritance from IdentityUser, keep it simple
3. **JWT secret must be environment variable** - use `Environment.GetEnvironmentVariable("JWT_SECRET")` in production
4. **Email uniqueness enforced at DB level** - use unique index, not just application validation
5. **Password hashing is one-way** - no "forgot password" feature in this story (future epic)
6. **No refresh tokens in MVP** - simple 24-hour expiration, user must re-login
7. **Exception handling middleware catches all exceptions** - controllers can throw exceptions, middleware converts to HTTP responses
8. **Integration tests must use in-memory database** - do not connect to real Supabase during tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

None

### Completion Notes List

- All 10 tasks and subtasks completed successfully
- EF Core migration created for User table (CreateUserTable)
- User authentication and registration endpoints fully implemented
- JWT token generation and validation implemented with ASP.NET Core Identity password hashing
- Global exception handling middleware configured with custom exceptions (ValidationException, UnauthorizedException, ConflictException)
- All 20 unit and integration tests passing (13 unit tests, 7 integration tests)
- Password validation enforces: min 8 chars, uppercase, lowercase, and number requirements
- JWT token expiration set to 24 hours (1440 minutes)
- Used ASP.NET Core Identity PasswordHasher for secure password hashing
- Integration tests use in-memory database for isolation

### File List

**Created Files:**
- TaskFlow.Abstractions/Entities/User.cs
- TaskFlow.Abstractions/DTOs/Auth/RegisterDto.cs
- TaskFlow.Abstractions/DTOs/Auth/LoginDto.cs
- TaskFlow.Abstractions/DTOs/Auth/AuthResponseDto.cs
- TaskFlow.Abstractions/Interfaces/Services/IPasswordHasher.cs
- TaskFlow.Abstractions/Interfaces/Services/IJwtTokenService.cs
- TaskFlow.Abstractions/Interfaces/Services/IAuthService.cs
- TaskFlow.Abstractions/Interfaces/Repositories/IUserRepository.cs
- TaskFlow.Abstractions/Interfaces/IUnitOfWork.cs
- TaskFlow.Abstractions/Constants/JwtSettings.cs
- TaskFlow.Abstractions/Exceptions/ValidationException.cs
- TaskFlow.Abstractions/Exceptions/UnauthorizedException.cs
- TaskFlow.Abstractions/Exceptions/ConflictException.cs
- TaskFlow.Infrastructure/Configurations/UserConfiguration.cs
- TaskFlow.Infrastructure/Services/PasswordHasher.cs
- TaskFlow.Infrastructure/Services/JwtTokenService.cs
- TaskFlow.Infrastructure/Repositories/UserRepository.cs
- TaskFlow.Infrastructure/Repositories/UnitOfWork.cs
- TaskFlow.Infrastructure/Migrations/*_CreateUserTable.cs (EF migration)
- TaskFlow.Core/Services/AuthService.cs
- TaskFlow.Api/Controllers/AuthController.cs
- TaskFlow.Api/Middleware/ErrorHandlingMiddleware.cs
- TaskFlow.Tests/Unit/Services/PasswordHasherTests.cs
- TaskFlow.Tests/Unit/Services/JwtTokenServiceTests.cs
- TaskFlow.Tests/Unit/Services/AuthServiceTests.cs
- TaskFlow.Tests/Integration/Controllers/AuthControllerTests.cs

**Modified Files:**
- TaskFlow.Infrastructure/Data/ApplicationDbContext.cs (added Users DbSet and configuration)
- TaskFlow.Api/Program.cs (added JWT authentication, DI registration, middleware configuration, exposed Program class for tests)
- TaskFlow.Api/appsettings.json (added JWT settings)

## QA Results

_To be populated by QA agent_