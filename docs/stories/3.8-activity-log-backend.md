# Story 3.8: Activity Log Backend

## Status

Ready for Review

## Story

**As a** user,
**I want** the system to track all changes to tasks automatically,
**so that** I have an audit trail and history of what happened.

## Acceptance Criteria

1. ActivityLog entity created with fields: Id (GUID), TaskId (FK), UserId (FK), ActivityType (enum: Created/Updated/Deleted/StatusChanged/Assigned/Unassigned/TimeLogged/Commented), Description (string), ChangedField (nullable), OldValue (nullable), NewValue (nullable), Timestamp
2. Database migration created for ActivityLog table with indexes on TaskId and Timestamp
3. ActivityLogService created with method: LogActivity(taskId, userId, activityType, description, ...)
4. Activity logging triggered automatically via service layer hooks or database triggers for: task creation, task field updates, status changes, assignment/unassignment, time entry creation, comment creation
5. Activity descriptions human-readable (e.g., "Sarah changed status from In Progress to Done", "Marcus logged 2 hours 30 minutes")
6. Field-level change tracking for task updates (captures which field changed and before/after values)
7. API endpoint created: GET /api/tasks/:id/activity returns activity log sorted by Timestamp descending (most recent first)
8. Activity log pagination supported for tasks with extensive history
9. Activity log includes actor name for display ("John Doe assigned this task to Jane Smith")
10. Bulk operations (if implemented) log individual activities per affected task
11. Deleted tasks retain activity logs for audit purposes (or cascade delete based on design)
12. Performance: activity logging does not slow down task operations (async processing or fast inserts)
13. Unit tests verify activity creation for each trigger scenario
14. Integration tests validate activity log captures full workflow sequence

## Tasks / Subtasks

- [x] **Task 1: Create Activity Log Domain Model and Constants** (AC: 1, 5, 6, 9)
  - [x] Add `ActivityType` enum in `backend/TaskFlow.Abstractions/Constants/ActivityType.cs`
  - [x] Add `ActivityLog` entity in `backend/TaskFlow.Abstractions/Entities/ActivityLog.cs`
  - [x] Include required properties for audit trail fields in AC 1
  - [x] Add navigation properties to `Task` and `User` entities following current entity pattern

- [x] **Task 2: Create Activity Log DTOs and Query Contract** (AC: 7, 8, 9)
  - [x] Create `backend/TaskFlow.Abstractions/DTOs/ActivityLogs/ActivityLogResponseDto.cs`
  - [x] Create `backend/TaskFlow.Abstractions/DTOs/ActivityLogs/ActivityLogQueryDto.cs` for pagination (`page`, `pageSize`)
  - [x] Ensure response includes actor display information required by AC 9
  - [x] Reuse existing `PaginatedResultDto<T>` in `DTOs/Shared`

- [x] **Task 3: Implement EF Core Configuration and Migration** (AC: 2, 11, 12)
  - [x] Add `ActivityLogConfiguration.cs` in `backend/TaskFlow.Infrastructure/Configurations/`
  - [x] Configure table/columns using existing snake_case convention (`activity_logs`, `task_id`, `user_id`, `activity_type`, `timestamp`, etc.)
  - [x] Add indexes for task timeline queries (TaskId + Timestamp desc, Timestamp)
  - [x] Decide delete behavior for task/user foreign keys to satisfy AC 11 and document the selected approach in this story
  - [x] Register `DbSet<ActivityLog>` in `ApplicationDbContext`
  - [x] Create migration in `backend/TaskFlow.Infrastructure/Migrations`

- [x] **Task 4: Add Repository Abstractions and Implementations** (AC: 3, 7, 8)
  - [x] Add `IActivityLogRepository` in `backend/TaskFlow.Abstractions/Interfaces/Repositories/`
  - [x] Implement `ActivityLogRepository` in `backend/TaskFlow.Infrastructure/Repositories/`
  - [x] Add repository methods for create and paginated fetch by task, ordered by timestamp descending
  - [x] Update `IUnitOfWork` and `UnitOfWork` to expose `ActivityLogs`

- [x] **Task 5: Add Activity Log Service Interface and Implementation** (AC: 3, 5, 6, 8, 9, 12)
  - [x] Add `IActivityLogService` in `backend/TaskFlow.Abstractions/Interfaces/Services/`
  - [x] Implement `ActivityLogService` in `backend/TaskFlow.Core/Services/`
  - [x] Implement logging method signature aligned with AC 3 (`LogActivity(...)`)
  - [x] Implement paginated retrieval method for task activity feed
  - [x] Add helper(s) for consistent human-readable description formatting
  - [x] Keep writes lightweight to meet AC 12 (single insert path, minimal additional queries)

- [x] **Task 6: Wire Activity Logging into Task Lifecycle Operations** (AC: 4, 5, 6)
  - [x] Inject `IActivityLogService` into `TaskService`
  - [x] Log task create/update/delete events
  - [x] Log assignment/unassignment events in `AssignUserAsync` and `UnassignUserAsync`
  - [x] Detect and log status changes and other updated fields with old/new values
  - [x] Log parent relationship changes in `SetParentTaskAsync` and `RemoveParentAsync`

- [x] **Task 7: Wire Activity Logging into Time Entry and Comment Flows** (AC: 4, 5)
  - [x] Inject `IActivityLogService` into `TimeEntryService`
  - [x] Log time entry creation events with readable duration text
  - [x] Inject `IActivityLogService` into `CommentService`
  - [x] Log comment creation events (and optionally update/delete for richer timeline consistency)

- [x] **Task 8: Add Activity Log Read Endpoint** (AC: 7, 8)
  - [x] Add endpoint in `TasksController` for task activity retrieval with pagination query params
  - [x] Return paginated activity response sorted by timestamp descending
  - [x] Validate task access using existing ownership/authorization patterns
  - [x] Resolve route naming mismatch between epic (`/activity`) and API spec (`/activities`) and document final route decision in this story

- [x] **Task 9: Register Dependencies in DI Container** (AC: 3)
  - [x] Register `IActivityLogRepository` in `RepositoryExtensions`
  - [x] Register `IActivityLogService` in `Program.cs`
  - [x] Verify application startup resolves all new dependencies

- [x] **Task 10: Unit Tests for Service and Hook Scenarios** (AC: 13)
  - [x] Create `ActivityLogServiceTests.cs` under `backend/TaskFlow.Tests/Unit/Services/`
  - [x] Add tests for creation, formatting, field tracking, and pagination
  - [x] Extend existing `TaskServiceTests`, `TaskServiceAssignmentTests`, `TimeEntryServiceTests`, and `CommentServiceTests` to assert logging is triggered where required
  - [x] Cover authorization-safe behavior and no-regression paths for existing operations

- [x] **Task 11: Integration Tests for Endpoint and Workflow Sequencing** (AC: 14)
  - [x] Create `ActivityLogControllerTests.cs` under `backend/TaskFlow.Tests/Integration/Controllers/`
  - [x] Validate `GET /api/tasks/{taskId}/activity` (or final selected route) returns expected ordering and pagination metadata
  - [x] Validate representative workflow sequence: create task → update status → assign user → log time → add comment
  - [x] Validate task-not-found and authorization failure responses

- [x] **Task 12: Performance and Compatibility Validation** (AC: 10, 11, 12)
  - [x] Confirm activity inserts do not introduce significant latency in task/time/comment write operations
  - [x] Verify existing task CRUD, assignment, time entry, and comment flows remain functional
  - [x] Confirm bulk behavior expectation in AC 10 is documented for current MVP scope (no dedicated bulk endpoint currently implemented)

## Dev Notes

### Existing System Integration

- Current backend has **no Activity Log implementation** yet:
  - No `ActivityLog` entity in `TaskFlow.Abstractions/Entities`
  - No `ActivityType` enum in `TaskFlow.Abstractions/Constants`
  - No activity repository/service/controller currently in place
- Primary integration touch points for automatic logging in current codebase:
  - `backend/TaskFlow.Core/Services/TaskService.cs`
  - `backend/TaskFlow.Core/Services/TimeEntryService.cs`
  - `backend/TaskFlow.Core/Services/CommentService.cs`
  - `backend/TaskFlow.Api/Controllers/TasksController.cs`

### Architecture and Contract References

- `docs/architecture/data-models.md` defines `ActivityLog` model shape and enum intent, including JSON old/new value tracking and timestamp ordering.
- `docs/architecture/database-schema.md` includes ActivityLogs schema and index strategy for chronological reads.
- `docs/architecture/api-specification.md` defines `GET /api/tasks/{taskId}/activities` (plural).
- Epic AC #7 specifies `GET /api/tasks/:id/activity` (singular). Implementer should reconcile this mismatch and keep API docs + frontend contract aligned.

### Existing Patterns to Follow

- **Entity + Configuration pattern**: mirror `Comment` and `CommentConfiguration` style for property mapping, FK behavior, and indexes.
- **Repository pattern**: mirror `CommentRepository` (`AsNoTracking`, include author relation where needed, deterministic ordering).
- **Service pattern**: mirror `TaskService` / `TimeEntryService` / `CommentService` (constructor DI, `IUnitOfWork`, `ILogger<T>`, explicit validation and exceptions).
- **Controller pattern**: mirror `TasksController` route structure and `GetCurrentUserId()` usage for authenticated user context.
- **Unit of Work pattern**: extend `IUnitOfWork` and `UnitOfWork` lazy repository properties consistently.
- **DI pattern**: repositories in `RepositoryExtensions`, services in `Program.cs`.

### Relevant Source Tree

```text
backend/
├── TaskFlow.Abstractions/
│   ├── Constants/
│   │   └── (add) ActivityType.cs
│   ├── Entities/
│   │   └── (add) ActivityLog.cs
│   ├── DTOs/
│   │   └── (add) ActivityLogs/
│   ├── Interfaces/
│   │   ├── Repositories/
│   │   │   └── (add) IActivityLogRepository.cs
│   │   ├── Services/
│   │   │   └── (add) IActivityLogService.cs
│   │   └── IUnitOfWork.cs (update)
├── TaskFlow.Infrastructure/
│   ├── Configurations/
│   │   └── (add) ActivityLogConfiguration.cs
│   ├── Repositories/
│   │   ├── (add) ActivityLogRepository.cs
│   │   └── UnitOfWork.cs (update)
│   ├── Data/
│   │   └── ApplicationDbContext.cs (update)
│   └── Migrations/
│       └── (add) AddActivityLogEntity migration
├── TaskFlow.Core/
│   └── Services/
│       ├── (add) ActivityLogService.cs
│       ├── TaskService.cs (update hooks)
│       ├── TimeEntryService.cs (update hooks)
│       └── CommentService.cs (update hooks)
├── TaskFlow.Api/
│   ├── Controllers/
│   │   └── TasksController.cs (add activity endpoint)
│   ├── Extensions/
│   │   └── RepositoryExtensions.cs (update)
│   └── Program.cs (update)
└── TaskFlow.Tests/
    ├── Unit/Services/
    │   ├── (add) ActivityLogServiceTests.cs
    │   ├── TaskServiceTests.cs (update)
    │   ├── TaskServiceAssignmentTests.cs (update)
    │   ├── TimeEntryServiceTests.cs (update)
    │   └── CommentServiceTests.cs (update)
    └── Integration/Controllers/
        └── (add) ActivityLogControllerTests.cs
```

### Testing

**Frameworks and Tooling in Current Repo:**
- Backend tests use xUnit + Moq (`backend/TaskFlow.Tests/Unit/Services/*Tests.cs`)
- Integration tests use `CustomWebApplicationFactory` + authenticated `HttpClient` (`backend/TaskFlow.Tests/Integration/Controllers/*Tests.cs`)

**Testing Standards (from `docs/architecture/12-coding-standards.md`):**
- Every service method MUST have unit tests
- Every repository method MUST have unit tests
- Components/services with business logic MUST have tests
- Arrange-Act-Assert pattern

**Story-Specific Testing Requirements:**
- Validate activity entries are produced for each required trigger path
- Validate ordering (newest first) and pagination behavior for activity endpoint
- Validate no regressions on task, assignment, time entry, and comment operations

## Change Log

| Date       | Version | Description   | Author     |
|------------|---------|---------------|------------|
| 2026-02-12 | 0.1     | Initial draft | Sarah (PO) |
| 2026-02-12 | 1.0     | Implemented activity log backend end-to-end (entity, migration, repository, service hooks, endpoint, unit/integration tests) | James (Dev) |

## Dev Agent Record

### Agent Model Used

GPT-5.3-Codex

### Debug Log References

- `dotnet build` (backend solution) succeeded after implementation updates.
- `dotnet ef migrations add AddActivityLogEntity --project TaskFlow.Infrastructure --startup-project TaskFlow.Api` generated migration.
- Targeted tests run via tool (`ActivityLogServiceTests`, updated service tests, `ActivityLogControllerTests`) passed.
- Full regression run: `dotnet test TaskFlow.Tests/TaskFlow.Tests.csproj --no-build` → 179 passed, 0 failed.

### Completion Notes List

- Implemented `ActivityLog` domain, `ActivityType` enum, DTOs, repository interface, service interface, and EF configuration.
- Added migration `AddActivityLogEntity` with indexes for activity timeline reads and FK delete behavior set to `Restrict` for both task and user to retain audit history.
- Implemented `ActivityLogService` with `LogActivityAsync(...)` and paginated task activity retrieval, including task-not-found vs unauthorized behavior.
- Hooked activity logging into `TaskService` (create/update/delete/status/assignment/unassignment/parent changes), `TimeEntryService` (human-readable duration text), and `CommentService` (comment creation).
- Added `GET /api/tasks/{id}/activity` endpoint with pagination and authorization-safe access checks.
- Route decision: implemented singular route `/api/tasks/{id}/activity` to align with story AC and epic wording; this is the backend contract used in integration tests.
- Bulk operations note: no dedicated bulk endpoint exists in current MVP; therefore AC10 is documented as not applicable for new code paths in this story.
- DoD checklist self-validation completed with all applicable items satisfied.

### File List

- `backend/TaskFlow.Abstractions/Constants/ActivityType.cs`
- `backend/TaskFlow.Abstractions/DTOs/ActivityLogs/ActivityLogQueryDto.cs`
- `backend/TaskFlow.Abstractions/DTOs/ActivityLogs/ActivityLogResponseDto.cs`
- `backend/TaskFlow.Abstractions/Entities/ActivityLog.cs`
- `backend/TaskFlow.Abstractions/Entities/Task.cs`
- `backend/TaskFlow.Abstractions/Entities/User.cs`
- `backend/TaskFlow.Abstractions/Interfaces/IUnitOfWork.cs`
- `backend/TaskFlow.Abstractions/Interfaces/Repositories/IActivityLogRepository.cs`
- `backend/TaskFlow.Abstractions/Interfaces/Services/IActivityLogService.cs`
- `backend/TaskFlow.Api/Controllers/TasksController.cs`
- `backend/TaskFlow.Api/Extensions/RepositoryExtensions.cs`
- `backend/TaskFlow.Api/Program.cs`
- `backend/TaskFlow.Core/Services/ActivityLogService.cs`
- `backend/TaskFlow.Core/Services/CommentService.cs`
- `backend/TaskFlow.Core/Services/TaskService.cs`
- `backend/TaskFlow.Core/Services/TimeEntryService.cs`
- `backend/TaskFlow.Infrastructure/Configurations/ActivityLogConfiguration.cs`
- `backend/TaskFlow.Infrastructure/Data/ApplicationDbContext.cs`
- `backend/TaskFlow.Infrastructure/Migrations/20260212094309_AddActivityLogEntity.cs`
- `backend/TaskFlow.Infrastructure/Migrations/20260212094309_AddActivityLogEntity.Designer.cs`
- `backend/TaskFlow.Infrastructure/Migrations/ApplicationDbContextModelSnapshot.cs`
- `backend/TaskFlow.Infrastructure/Repositories/ActivityLogRepository.cs`
- `backend/TaskFlow.Infrastructure/Repositories/UnitOfWork.cs`
- `backend/TaskFlow.Tests/Integration/Controllers/ActivityLogControllerTests.cs`
- `backend/TaskFlow.Tests/Unit/Controllers/TasksControllerTests.cs`
- `backend/TaskFlow.Tests/Unit/Services/ActivityLogServiceTests.cs`
- `backend/TaskFlow.Tests/Unit/Services/CommentServiceTests.cs`
- `backend/TaskFlow.Tests/Unit/Services/TaskServiceAdvancedQueryTests.cs`
- `backend/TaskFlow.Tests/Unit/Services/TaskServiceAssignmentTests.cs`
- `backend/TaskFlow.Tests/Unit/Services/TaskServiceHierarchyTests.cs`
- `backend/TaskFlow.Tests/Unit/Services/TaskServiceTests.cs`
- `backend/TaskFlow.Tests/Unit/Services/TaskServiceTimelineTests.cs`
- `backend/TaskFlow.Tests/Unit/Services/TimeEntryServiceTests.cs`

## QA Results

(To be filled by QA agent)