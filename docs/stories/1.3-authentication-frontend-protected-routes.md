# Story 1.3: Authentication Frontend and Protected Routes

## Status

Approved

## Story

**As a** user,
**I want** a login and registration UI that securely stores my authentication token,
**so that** I can access the application and remain logged in across sessions.

## Acceptance Criteria

1. Registration page created with form fields: email, password, confirm password, name
2. Login page created with form fields: email, password, and "Remember Me" option
3. Form validation displays inline error messages for invalid inputs (email format, password strength, password mismatch)
4. Successful registration automatically logs user in and navigates to dashboard
5. Successful login stores JWT token in localStorage and navigates to dashboard
6. HTTP interceptor created to add Authorization: Bearer <token> header to all API requests
7. Auth guard created to protect routes requiring authentication (redirects to login if no token)
8. Auth service provides isAuthenticated(), getCurrentUser(), and logout() methods
9. Logout clears token from localStorage and navigates to login page
10. Navigation bar displays user name and logout button when authenticated
11. Token expiration handled gracefully—expired tokens redirect to login with "Session expired" message
12. Basic responsive styling applied to login/registration pages (mobile-friendly)

## Tasks / Subtasks

- [ ] **Task 1: Create Auth Models and Interfaces** (AC: 1, 2, 8)
  - [ ] Create `src/app/core/models/` directory if not exists
  - [ ] Create `user.model.ts` interface with properties:
    - [ ] id: string
    - [ ] email: string
    - [ ] name: string
    - [ ] profileImageUrl?: string
  - [ ] Create `auth-response.model.ts` interface with properties:
    - [ ] token: string
    - [ ] userId: string
    - [ ] email: string
    - [ ] name: string
    - [ ] expiresAt: string (ISO date)
  - [ ] Create `register-request.model.ts` interface with properties:
    - [ ] email: string
    - [ ] password: string
    - [ ] name: string
  - [ ] Create `login-request.model.ts` interface with properties:
    - [ ] email: string
    - [ ] password: string

- [ ] **Task 2: Create Auth Service** (AC: 5, 6, 8, 9, 11)
  - [ ] Create `src/app/core/services/` directory if not exists
  - [ ] Create `auth.service.ts` as an Injectable with providedIn: 'root'
  - [ ] Inject Angular HttpClient
  - [ ] Add private BehaviorSubject<User | null> for current user state
  - [ ] Add public currentUser$: Observable<User | null> exposed from subject
  - [ ] Implement `register(request: RegisterRequest): Observable<AuthResponse>`:
    - [ ] POST to `${environment.apiUrl}/api/auth/register`
    - [ ] On success, call setAuthToken() and setCurrentUser()
    - [ ] Return AuthResponse observable
  - [ ] Implement `login(request: LoginRequest): Observable<AuthResponse>`:
    - [ ] POST to `${environment.apiUrl}/api/auth/login`
    - [ ] On success, call setAuthToken() and setCurrentUser()
    - [ ] Return AuthResponse observable
  - [ ] Implement `logout(): void`:
    - [ ] Remove 'authToken' from localStorage
    - [ ] Set currentUser$ to null
    - [ ] Navigate to '/login'
  - [ ] Implement `isAuthenticated(): boolean`:
    - [ ] Check if token exists in localStorage
    - [ ] Check if token is not expired (parse JWT, compare exp claim)
    - [ ] Return true if valid, false otherwise
  - [ ] Implement `getCurrentUser(): User | null`:
    - [ ] Return current value from currentUser$ BehaviorSubject
  - [ ] Implement `getToken(): string | null`:
    - [ ] Return token from localStorage.getItem('authToken')
  - [ ] Implement private `setAuthToken(token: string): void`:
    - [ ] Store token in localStorage with key 'authToken'
  - [ ] Implement private `setCurrentUser(authResponse: AuthResponse): void`:
    - [ ] Extract user data from authResponse
    - [ ] Emit new user to currentUser$ BehaviorSubject
  - [ ] Add token expiration check utility method `isTokenExpired(token: string): boolean`

- [ ] **Task 3: Create Auth HTTP Interceptor** (AC: 6, 11)
  - [ ] Create `src/app/core/interceptors/` directory if not exists
  - [ ] Create `auth.interceptor.ts` as functional HTTP interceptor
  - [ ] Inject AuthService
  - [ ] In intercept function:
    - [ ] Get token from AuthService.getToken()
    - [ ] If token exists and not expired, clone request and add Authorization header
    - [ ] If token expired, call AuthService.logout() and redirect to login with message
    - [ ] Return next.handle(request) or modified request
  - [ ] Export `authInterceptor` function
  - [ ] Register interceptor in `app.config.ts` via provideHttpClient(withInterceptors([authInterceptor]))

- [ ] **Task 4: Create Auth Guard** (AC: 7)
  - [ ] Create `src/app/core/guards/` directory if not exists
  - [ ] Create `auth.guard.ts` as functional route guard
  - [ ] Inject AuthService and Router
  - [ ] Implement guard function:
    - [ ] Check AuthService.isAuthenticated()
    - [ ] If authenticated, return true
    - [ ] If not authenticated, navigate to '/login' and return false
  - [ ] Export `canActivate` guard function

- [ ] **Task 5: Create Registration Component** (AC: 1, 3, 4, 12)
  - [ ] Generate component: `ng generate component features/auth/register`
  - [ ] Create reactive form with FormBuilder:
    - [ ] email: FormControl with Validators.required, Validators.email
    - [ ] password: FormControl with Validators.required, Validators.minLength(8), custom password strength validator
    - [ ] confirmPassword: FormControl with Validators.required, custom match validator
    - [ ] name: FormControl with Validators.required, Validators.minLength(2)
  - [ ] Add custom validator for password strength (uppercase, lowercase, number)
  - [ ] Add custom validator for password match (confirmPassword === password)
  - [ ] Create form template (register.component.html):
    - [ ] Add Material form fields for each input (mat-form-field, mat-input)
    - [ ] Display inline validation errors using mat-error
    - [ ] Add submit button disabled if form invalid
    - [ ] Show loading spinner during submission
  - [ ] Implement `onSubmit()` method:
    - [ ] Check form validity
    - [ ] Call AuthService.register()
    - [ ] On success, navigate to '/dashboard'
    - [ ] On error, display error message (using MatSnackBar)
  - [ ] Add responsive styling with Tailwind/Material (mobile-friendly)
  - [ ] Add link to login page ("Already have an account? Log in")

- [ ] **Task 6: Create Login Component** (AC: 2, 3, 5, 12)
  - [ ] Generate component: `ng generate component features/auth/login`
  - [ ] Create reactive form with FormBuilder:
    - [ ] email: FormControl with Validators.required, Validators.email
    - [ ] password: FormControl with Validators.required
    - [ ] rememberMe: FormControl (boolean, optional)
  - [ ] Create form template (login.component.html):
    - [ ] Add Material form fields for email and password
    - [ ] Add checkbox for "Remember Me" (mat-checkbox)
    - [ ] Display inline validation errors
    - [ ] Add submit button disabled if form invalid
    - [ ] Show loading spinner during submission
  - [ ] Implement `onSubmit()` method:
    - [ ] Check form validity
    - [ ] Call AuthService.login()
    - [ ] On success, navigate to '/dashboard'
    - [ ] On error, display error message (401 → "Invalid credentials")
  - [ ] Add responsive styling (mobile-friendly)
  - [ ] Add link to registration page ("Don't have an account? Sign up")

- [ ] **Task 7: Create Dashboard Component Stub** (AC: 4, 5, 10)
  - [ ] Generate component: `ng generate component features/dashboard`
  - [ ] Create simple template displaying "Dashboard - Coming Soon"
  - [ ] This is a placeholder for Story 1.5 (Task Management Frontend)
  - [ ] Template should verify user is authenticated and display user name

- [ ] **Task 8: Create Navigation Component** (AC: 10)
  - [ ] Generate component: `ng generate component shared/components/navigation`
  - [ ] Inject AuthService
  - [ ] Subscribe to currentUser$ observable in component
  - [ ] Create template (navigation.component.html):
    - [ ] Use Material toolbar (mat-toolbar)
    - [ ] Display app logo/name "TaskFlow"
    - [ ] Conditionally show user name and logout button when authenticated
    - [ ] Use *ngIf="currentUser$ | async as user" for conditional rendering
    - [ ] Logout button calls AuthService.logout()
  - [ ] Add responsive styling (hamburger menu on mobile if needed)
  - [ ] Include navigation component in app.component.html

- [ ] **Task 9: Configure Routing** (AC: 4, 5, 7, 9)
  - [ ] Update `app.routes.ts`:
    - [ ] Add route for '/register' → RegisterComponent
    - [ ] Add route for '/login' → LoginComponent
    - [ ] Add route for '/dashboard' → DashboardComponent with canActivate: [authGuard]
    - [ ] Add route for '' (root) → redirect to '/dashboard'
    - [ ] Add wildcard route '**' → redirect to '/login' (or 404 page)
  - [ ] Update app.component.html to include router-outlet and navigation component

- [ ] **Task 10: Add Error Handling and Session Expiry** (AC: 11)
  - [ ] In AuthInterceptor, handle 401 responses:
    - [ ] If 401 response received, call AuthService.logout()
    - [ ] Display "Session expired, please log in again" message (MatSnackBar)
    - [ ] Redirect to '/login'
  - [ ] Update AuthService to check token expiration on app initialization:
    - [ ] In constructor or APP_INITIALIZER, check if stored token is expired
    - [ ] If expired, clear token and redirect to login

- [ ] **Task 11: Install and Configure Angular Material** (AC: 12)
  - [ ] Run `ng add @angular/material`
  - [ ] Select a prebuilt theme (e.g., Indigo/Pink)
  - [ ] Import required Material modules:
    - [ ] MatFormFieldModule, MatInputModule, MatButtonModule
    - [ ] MatCheckboxModule, MatToolbarModule, MatIconModule
    - [ ] MatSnackBarModule, MatProgressSpinnerModule
  - [ ] Configure Material typography and theme if needed
  - [ ] Add Material icons CDN link to index.html if not auto-added

- [ ] **Task 12: Write Unit Tests** (AC: 8, all)
  - [ ] Create `auth.service.spec.ts`:
    - [ ] Test register() calls correct endpoint and stores token
    - [ ] Test login() calls correct endpoint and stores token
    - [ ] Test logout() clears token and navigates to login
    - [ ] Test isAuthenticated() returns true for valid token
    - [ ] Test isAuthenticated() returns false for expired token
    - [ ] Test getCurrentUser() returns user from currentUser$ subject
  - [ ] Create `auth.interceptor.spec.ts`:
    - [ ] Test interceptor adds Authorization header when token exists
    - [ ] Test interceptor does not add header when no token
    - [ ] Test interceptor handles 401 response and calls logout
  - [ ] Create `auth.guard.spec.ts`:
    - [ ] Test guard allows navigation when authenticated
    - [ ] Test guard redirects to login when not authenticated
  - [ ] Create `register.component.spec.ts`:
    - [ ] Test form validation (email format, password strength, password match)
    - [ ] Test successful registration navigates to dashboard
    - [ ] Test error handling displays error message
  - [ ] Create `login.component.spec.ts`:
    - [ ] Test form validation (required fields)
    - [ ] Test successful login navigates to dashboard
    - [ ] Test invalid credentials display error message

- [ ] **Task 13: Manual Integration Testing** (AC: all)
  - [ ] Start backend API (`dotnet run` in TaskFlow.Api)
  - [ ] Start frontend (`ng serve`)
  - [ ] Test registration flow:
    - [ ] Navigate to /register
    - [ ] Fill form with valid data, submit
    - [ ] Verify redirect to /dashboard
    - [ ] Verify token stored in localStorage
    - [ ] Verify navigation shows user name and logout button
  - [ ] Test login flow:
    - [ ] Logout, navigate to /login
    - [ ] Login with registered user credentials
    - [ ] Verify redirect to /dashboard and token storage
  - [ ] Test protected route:
    - [ ] Clear localStorage, navigate to /dashboard directly
    - [ ] Verify redirect to /login
  - [ ] Test logout:
    - [ ] Click logout button
    - [ ] Verify redirect to /login and token cleared
  - [ ] Test form validations:
    - [ ] Try invalid email, weak password, mismatched passwords
    - [ ] Verify inline error messages display
  - [ ] Test token expiration (manually set expired token in localStorage)
  - [ ] Test responsive design on mobile viewport

## Dev Notes

### Project Context

This story implements the Angular frontend authentication system that integrates with the backend API created in Story 1.2. The implementation follows Angular 20 best practices using standalone components, reactive forms, and RxJS observables for state management.

### Relevant Source Tree

**Frontend Structure (to be created):**
```
src/app/
├── core/
│   ├── guards/
│   │   └── auth.guard.ts
│   ├── interceptors/
│   │   └── auth.interceptor.ts
│   ├── models/
│   │   ├── user.model.ts
│   │   ├── auth-response.model.ts
│   │   ├── register-request.model.ts
│   │   └── login-request.model.ts
│   └── services/
│       └── auth.service.ts
├── features/
│   ├── auth/
│   │   ├── login/
│   │   │   ├── login.component.ts
│   │   │   ├── login.component.html
│   │   │   ├── login.component.scss
│   │   │   └── login.component.spec.ts
│   │   └── register/
│   │       ├── register.component.ts
│   │       ├── register.component.html
│   │       ├── register.component.scss
│   │       └── register.component.spec.ts
│   └── dashboard/
│       ├── dashboard.component.ts
│       ├── dashboard.component.html
│       ├── dashboard.component.scss
│       └── dashboard.component.spec.ts
└── shared/
    └── components/
        └── navigation/
            ├── navigation.component.ts
            ├── navigation.component.html
            ├── navigation.component.scss
            └── navigation.component.spec.ts
```

### Architecture Standards

**Component Architecture:**
- Use standalone components (no NgModules) - Angular 20 standard
- Follow container/presentational pattern where applicable
- Auth components are feature components (smart, inject services)
- Navigation component is shared/presentational
- Keep components focused - single responsibility principle

**State Management:**
- Use RxJS BehaviorSubject for current user state in AuthService
- Expose Observable (currentUser$) to components
- Use async pipe in templates to auto-unsubscribe
- Never mutate state directly - always emit new values

**API Communication:**
- All HTTP calls go through AuthService
- Use Angular HttpClient (inject via constructor)
- Base URL from environment.apiUrl
- Return Observables from service methods
- Handle errors with catchError operator

**Security Considerations:**
- JWT tokens stored in localStorage (not sessionStorage for "Remember Me" support)
- Note: localStorage is vulnerable to XSS attacks, but acceptable for MVP
- Future enhancement: Use httpOnly cookies with refresh tokens
- Always validate token expiration before using
- Clear token on logout and 401 responses

**Form Validation:**
- Use Reactive Forms with FormBuilder
- Apply validators at form control level
- Custom validators for password strength and password match
- Display inline errors with Angular Material mat-error
- Disable submit button when form invalid

**Error Handling:**
- Use MatSnackBar for user-facing error messages
- Map HTTP error codes to user-friendly messages
- 400 → "Invalid input, please check your details"
- 401 → "Invalid credentials"
- 409 → "Email already registered"
- 500 → "Server error, please try again later"

### Backend Integration

**API Endpoints (from Story 1.2):**
- POST `/api/auth/register` - Register new user
  - Body: `{ email: string, password: string, name: string }`
  - Returns: `AuthResponseDto`
- POST `/api/auth/login` - Login user
  - Body: `{ email: string, password: string }`
  - Returns: `AuthResponseDto`

**AuthResponseDto Structure:**
```typescript
{
  token: string;          // JWT bearer token
  userId: string;         // GUID
  email: string;
  name: string;
  expiresAt: string;      // ISO date string
}
```

**JWT Token Format:**
- Bearer token to be sent in Authorization header
- Contains claims: userId (NameIdentifier), email, name
- Expiration: 24 hours from issue
- Secret key must match backend configuration

### Coding Standards

**TypeScript Standards:**
- Enable strict mode (already configured in tsconfig.json)
- No `any` types - use proper typing
- Prefer `const` over `let`, never use `var`
- Use arrow functions for callbacks
- Interfaces should be PascalCase (User, AuthResponse)
- Variables should be camelCase (currentUser, authToken)

**Angular Standards:**
- Components: PascalCase class name (LoginComponent)
- Component files: kebab-case (login.component.ts)
- Services: PascalCase with Service suffix (AuthService)
- Use dependency injection for all services
- Inject services in constructor
- No direct DOM manipulation - use Angular templates

**RxJS Standards:**
- Use async pipe in templates to prevent memory leaks
- Unsubscribe from observables in ngOnDestroy if not using async pipe
- Use RxJS operators (map, catchError, tap) for data transformation
- Avoid nested subscriptions - use switchMap, mergeMap, forkJoin

**Naming Conventions:**
- Private fields: prefix with underscore (_currentUserSubject)
- Public observables: suffix with $ (currentUser$)
- Boolean variables: prefix with is/has (isAuthenticated, hasToken)
- Event handlers: prefix with on (onSubmit, onLogin)
- Methods: camelCase (login, logout, getCurrentUser)

### Testing

**Test File Locations:**
- Co-located with components/services (`.spec.ts` files)
- Example: `auth.service.ts` → `auth.service.spec.ts`

**Testing Framework:**
- Jasmine (BDD framework) + Karma (test runner)
- Default Angular testing stack

**Testing Standards:**
- Use `describe` blocks to group related tests
- Test naming: `it('should do something when condition')`
- Follow Arrange-Act-Assert pattern
- Mock HTTP calls with HttpClientTestingModule
- Mock dependencies (AuthService, Router) with jasmine spies
- Test both success and error scenarios
- Aim for 80%+ code coverage on services

**Test Execution:**
- Run tests: `ng test`
- Run tests with coverage: `ng test --code-coverage`
- Tests run in Chrome headless by default
- CI/CD runs tests automatically on PR

**Key Test Scenarios:**
1. AuthService:
   - Token storage and retrieval
   - Token expiration validation
   - User state management
   - HTTP call parameters
2. AuthInterceptor:
   - Authorization header addition
   - 401 response handling
3. AuthGuard:
   - Authenticated vs non-authenticated navigation
4. Components:
   - Form validation
   - Successful submission navigation
   - Error handling and display

### Important Notes from Previous Stories

**From Story 1.1 (Project Setup):**
- Environment files already configured:
  - `src/environments/environment.ts` - Development (apiUrl: 'http://localhost:5000')
  - `src/environments/environment.prod.ts` - Production (apiUrl: TBD in Story 1.8)
- TypeScript strict mode enabled in tsconfig.json
- Angular app serves on localhost:4200
- Backend API runs on localhost:5000 (development)

**From Story 1.2 (Auth Backend):**
- User entity includes: Id (GUID), Email, PasswordHash, Name, ProfileImageUrl, CreatedDate
- Password validation: min 8 chars, uppercase, lowercase, number
- JWT expiration: 24 hours
- Registration returns 409 Conflict for duplicate email
- Login returns 401 Unauthorized for invalid credentials
- Backend uses ASP.NET Core Identity PasswordHasher

**CORS Configuration:**
- Backend must allow origin http://localhost:4200 for development
- Verify CORS is configured in backend Program.cs (Story 1.1)
- Production CORS will be configured in Story 1.8

### Definition of Done Checklist

- [ ] All tasks and subtasks completed
- [ ] All acceptance criteria met
- [ ] Unit tests written and passing (80%+ coverage on services)
- [ ] Manual integration testing completed successfully
- [ ] Code follows Angular and TypeScript coding standards
- [ ] No console errors or warnings
- [ ] Responsive design tested on mobile viewport (Chrome DevTools)
- [ ] No hardcoded secrets or environment-specific values
- [ ] All files properly organized in source tree structure
- [ ] Authentication flow works end-to-end (register → login → protected route → logout)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Initial story creation | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent during implementation_

### Debug Log References

_To be populated by dev agent during implementation_

### Completion Notes List

_To be populated by dev agent during implementation_

### File List

_To be populated by dev agent during implementation_

## QA Results

_To be populated by QA agent after implementation review_
