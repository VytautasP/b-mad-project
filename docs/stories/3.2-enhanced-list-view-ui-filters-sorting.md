# Story 3.2: Enhanced List View UI with Filters and Sorting

## Status

Approved

## Story

**As a** user,
**I want** a powerful list view with multi-criteria filtering, column sorting, and pagination,
**so that** I can find and organize tasks efficiently as my list grows large.

## Acceptance Criteria

1. List view redesigned as data table with columns: Name, Assignees, Status, Priority, Due Date, Logged Time, Actions
2. Column headers clickable to sort ascending/descending with visual indicator (arrow icon)
3. Filter panel displayed above list with controls: Assignee (multi-select dropdown), Status (multi-select), Priority (multi-select), Type (multi-select), Due Date Range (date pickers)
4. "Apply Filters" button executes filtered query, "Clear Filters" resets to default view
5. Active filters displayed as removable chips/badges (e.g., "Status: In Progress ✕")
6. Pagination controls at bottom: Previous/Next buttons, page number indicator, page size selector (25/50/100/200)
7. Quick actions column includes: Edit (pencil icon), Delete (trash icon), Start Timer (clock icon), View Details (eye icon)
8. Hovering over row highlights it for easier scanning of dense data
9. Loading state displayed during filter/sort operations
10. Filtered results count displayed (e.g., "Showing 12 of 234 tasks")
11. Filter/sort/pagination state persists in URL query parameters (bookmarkable, shareable)
12. Mobile responsive—filters collapse into dropdown menu, table scrolls horizontally or simplifies to cards
13. Empty state displayed when filters produce no results ("No tasks match your filters")
14. Performance: UI updates within 100ms of pagination/sort clicks

## Tasks / Subtasks

- [ ] **Task 1: Update Task Service with Advanced Query** (AC: 1, 2, 3, 11)
  - [ ] Update `TaskService.getTasks()` method in `src/app/features/tasks/services/task.service.ts`:
    - [ ] Add filter parameters: assigneeId (string[]), status (TaskStatus[]), priority (TaskPriority[]), type (TaskType[]), dueDateFrom (Date), dueDateTo (Date), searchTerm (string)
    - [ ] Add sorting parameters: sortBy (string), sortOrder ('asc' | 'desc')
    - [ ] Add pagination parameters: page (number), pageSize (number)
    - [ ] Build HttpParams from filter/sort/pagination objects
    - [ ] Call backend GET /api/tasks endpoint with query parameters
    - [ ] Return Observable<PaginatedResultDto<Task>> matching backend response structure
  - [ ] Update TaskService interface definition with new method signature
  - [ ] Add TaskFilters interface: `{ assigneeId?: string[]; status?: TaskStatus[]; priority?: TaskPriority[]; ... }`
  - [ ] Add PaginatedResult interface: `{ items: Task[]; totalCount: number; page: number; pageSize: number; totalPages: number; hasNextPage: boolean; hasPreviousPage: boolean; }`

- [ ] **Task 2: Create Task Filters Component** (AC: 3, 4, 5, 13)
  - [ ] Create `src/app/features/tasks/task-list/components/task-filters/task-filters.component.ts`
  - [ ] Create `src/app/features/tasks/task-list/components/task-filters/task-filters.component.html`
  - [ ] Create `src/app/features/tasks/task-list/components/task-filters/task-filters.component.scss`
  - [ ] Use Reactive Forms (FormBuilder) to create filter form:
    - [ ] Assignee: multi-select dropdown (MatSelect with multiple attribute)
    - [ ] Status: multi-select chips (MatChipListbox)
    - [ ] Priority: multi-select chips (MatChipListbox)
    - [ ] Type: multi-select chips (MatChipListbox)
    - [ ] Due Date Range: two date pickers (MatDatepicker for from/to)
  - [ ] Add "Apply Filters" button (mat-raised-button, primary color)
  - [ ] Add "Clear Filters" button (mat-button)
  - [ ] Display active filters as chips with remove buttons using MatChip
  - [ ] Emit @Output filtersChanged event when "Apply Filters" clicked
  - [ ] Emit @Output filtersCleared event when "Clear Filters" clicked or chip removed
  - [ ] Add expandable/collapsible panel using MatExpansionPanel for mobile view
  - [ ] Load user list for Assignee dropdown from backend (or accept as @Input)

- [ ] **Task 3: Update Task Table Component with Sorting** (AC: 1, 2, 7, 8, 14)
  - [ ] Update `src/app/features/tasks/task-list/components/task-table/task-table.component.ts`:
    - [ ] Add MatSort directive to table
    - [ ] Add @Input() columns definition: 'name' | 'assignees' | 'status' | 'priority' | 'dueDate' | 'loggedTime' | 'actions'
    - [ ] Update displayedColumns: string[] = ['name', 'assignees', 'status', 'priority', 'dueDate', 'loggedTime', 'actions']
    - [ ] Add @Output() sortChanged event emitter: EventEmitter<{ sortBy: string; sortOrder: 'asc' | 'desc' }>
    - [ ] Implement matSortChange handler to emit sort parameters to parent
    - [ ] Add row hover effect in CSS (.task-row:hover)
    - [ ] Add quick action buttons to Actions column: Edit, Delete, Start Timer, View Details icons
    - [ ] Emit @Output() events for each action: taskEdit, taskDelete, timerStart, taskView
  - [ ] Update `task-table.component.html`:
    - [ ] Add mat-sort-header to sortable columns
    - [ ] Add MatIconButton for quick actions with mat-icon: edit, delete, timer, visibility
    - [ ] Add matTooltip to action icons for accessibility
  - [ ] Update `task-table.component.scss`:
    - [ ] Style row hover effect
    - [ ] Style action buttons (icon-only, compact)
    - [ ] Ensure table is responsive (horizontal scroll on small screens or simplified view)

- [ ] **Task 4: Add Pagination Component** (AC: 6, 10, 14)
  - [ ] Update `task-list.component.html` to include MatPaginator:
    - [ ] Add `<mat-paginator>` below task table
    - [ ] Set [length]="totalCount" from API response
    - [ ] Set [pageSize]="pageSize" (default 50)
    - [ ] Set [pageSizeOptions]="[25, 50, 100, 200]"
    - [ ] Set [pageIndex]="page - 1" (0-indexed for mat-paginator, 1-indexed for API)
    - [ ] Listen to (page) event and emit pagination change to parent
  - [ ] Display filtered count above table: "Showing {{items.length}} of {{totalCount}} tasks"
  - [ ] Style paginator to match application theme

- [ ] **Task 5: Update Task List Container Component** (AC: 1-14)
  - [ ] Update `src/app/features/tasks/task-list/task-list.component.ts`:
    - [ ] Add state properties: filters (TaskFilters), sortBy (string), sortOrder ('asc' | 'desc'), page (number), pageSize (number)
    - [ ] Implement onFiltersChanged(filters: TaskFilters) handler
    - [ ] Implement onSortChanged(sort: { sortBy: string; sortOrder: 'asc' | 'desc' }) handler
    - [ ] Implement onPageChanged(event: PageEvent) handler
    - [ ] Refactor loadTasks() method to use filter/sort/pagination parameters from state
    - [ ] Update URL query parameters using Router.navigate() when filters/sort/pagination change (AC 11)
    - [ ] Parse URL query parameters on component init to restore state (ActivatedRoute.queryParams)
    - [ ] Show loading spinner during API calls (loading signal or BehaviorSubject)
    - [ ] Handle empty results state (no tasks match filters)
    - [ ] Wire up quick action handlers from task-table: onTaskEdit, onTaskDelete, onTimerStart, onTaskView
  - [ ] Update `task-list.component.html`:
    - [ ] Add <app-task-filters> component with event bindings
    - [ ] Update <app-task-table> with new @Input/@Output bindings
    - [ ] Add <mat-paginator> with event binding
    - [ ] Add loading spinner: `<mat-spinner *ngIf="loading()"></mat-spinner>`
    - [ ] Add empty state: `@if (tasks.length === 0 && !loading()) { ... }`
  - [ ] Update `task-list.component.scss`: Add layout styles for filters + table + pagination

- [ ] **Task 6: Implement URL State Persistence** (AC: 11)
  - [ ] Use ActivatedRoute.queryParams to read initial state on component init
  - [ ] Parse query params: assigneeId, status (array), priority (array), type (array), dueDateFrom, dueDateTo, sortBy, sortOrder, page, pageSize
  - [ ] Use Router.navigate() with queryParams to update URL when state changes
  - [ ] Use queryParamsHandling: 'merge' to preserve other query params
  - [ ] Ensure URL reflects current filter/sort/pagination state (shareable/bookmarkable)

- [ ] **Task 7: Implement Mobile Responsiveness** (AC: 12)
  - [ ] Add CSS media queries for mobile view (max-width: 768px):
    - [ ] Collapse filter panel into MatExpansionPanel or bottom sheet
    - [ ] Switch table to card-based layout on mobile (use existing task-card component from Story 1.5)
    - [ ] Show simplified columns on tablet (hide loggedTime, combine name+description)
    - [ ] Make pagination controls stack vertically on small screens
  - [ ] Test on mobile devices/emulator for usability

- [ ] **Task 8: Add Loading and Empty States** (AC: 9, 13)
  - [ ] Show mat-progress-bar during API calls at top of table
  - [ ] Show mat-spinner in center of table area during initial load
  - [ ] Display empty state component when no tasks and no filters: "No tasks yet. Create your first task!"
  - [ ] Display filtered empty state when filters produce no results: "No tasks match your filters. Try adjusting your filters."
  - [ ] Add empty state with illustration or icon using existing EmptyStateComponent from shared

- [ ] **Task 9: Wire Up Quick Actions** (AC: 7)
  - [ ] onTaskEdit(task: Task): Open task form in MatDialog or navigate to edit route
  - [ ] onTaskDelete(task: Task): Open confirmation dialog, call TaskService.deleteTask() on confirm
  - [ ] onTimerStart(task: Task): Call TimeTrackingService to start timer for task
  - [ ] onTaskView(task: Task): Open task detail panel or navigate to task detail route
  - [ ] Show success/error notifications using MatSnackBar

- [ ] **Task 10: Write Unit Tests** (AC: 1-14)
  - [ ] Create `task-filters.component.spec.ts`:
    - [ ] Test filter form initialization
    - [ ] Test "Apply Filters" emits correct filter object
    - [ ] Test "Clear Filters" resets form and emits event
    - [ ] Test chip removal updates form and emits event
    - [ ] Test multi-select controls binding
  - [ ] Update `task-table.component.spec.ts`:
    - [ ] Test sorting event emission
    - [ ] Test quick action button clicks emit correct events
    - [ ] Test row hover styling
  - [ ] Update `task-list.component.spec.ts`:
    - [ ] Test loadTasks() calls TaskService with correct parameters
    - [ ] Test filter change updates state and reloads tasks
    - [ ] Test sort change updates state and reloads tasks
    - [ ] Test pagination change updates state and reloads tasks
    - [ ] Test URL query parameter parsing on init
    - [ ] Test URL updates when state changes
    - [ ] Test loading state displays spinner
    - [ ] Test empty state displays message
    - [ ] Test mobile responsive layout (using Angular testing utilities)

- [ ] **Task 11: Write Integration/E2E Tests** (AC: 1-14)
  - [ ] Create Playwright test: `task-list-filtering.spec.ts`
    - [ ] Test: Apply status filter, verify filtered results
    - [ ] Test: Apply multiple filters (status + priority), verify combined results
    - [ ] Test: Clear filters, verify all tasks shown
    - [ ] Test: Click column header to sort, verify sort order
    - [ ] Test: Navigate to page 2, verify pagination works
    - [ ] Test: Change page size, verify correct number of tasks displayed
    - [ ] Test: Verify URL query parameters update with filter/sort/pagination
    - [ ] Test: Copy URL, reload page, verify state restored from URL
    - [ ] Test: Click quick action buttons, verify correct actions triggered
    - [ ] Test: Mobile view, verify filters collapse and cards display

## Dev Notes

### Existing System Integration

This story builds directly on Story 3.1 (Advanced Filtering and Sorting Backend) by consuming the enhanced API endpoint. It transforms the existing task list component (from Story 1.5) into a powerful, filterable, sortable, paginated data table.

**Key Integration Points:**
- Enhances `TaskListComponent` from Story 1.5 (currently displays simple table)
- Consumes paginated API from Story 3.1 (GET /api/tasks with query parameters)
- Uses existing `TaskService` (from Story 1.5), adds filter/sort/pagination parameters
- Reuses `TaskFormComponent` (from Story 1.5) for edit action
- Integrates with `TimeTrackingService` (from Story 2.6/2.7) for timer quick action
- Uses existing authentication/authorization from Story 1.3 (JWT in HTTP interceptor)
- Follows existing routing patterns from frontend-architecture.md

### Technology Stack

- **Frontend**: Angular 20 with standalone components
- **UI Library**: Angular Material 20 (MatTable, MatSort, MatPaginator, MatSelect, MatChipListbox, MatDatepicker, MatExpansionPanel)
- **Forms**: Reactive Forms (FormBuilder, FormControl, FormGroup)
- **Routing**: Angular Router (ActivatedRoute, Router for query params)
- **State Management**: Component-level state + URL query parameters for persistence
- **Testing**: Jasmine/Karma for unit tests, Playwright for E2E tests

### Existing Patterns to Follow

**Smart/Dumb Component Pattern** (from coding-standards.md and frontend-architecture.md):
- TaskListComponent = smart container (handles data fetching, state management, routing)
- TaskTableComponent = presentational (receives tasks via @Input, emits events via @Output)
- TaskFiltersComponent = presentational (receives filter state, emits filter changes)
- Keep TaskTableComponent and TaskFiltersComponent pure (no service injection, only @Input/@Output)

**Reactive Forms Pattern** (from Story 1.5):
- Use FormBuilder to create filter form: `this.filterForm = this.fb.group({ ... })`
- Access form values: `this.filterForm.value`
- Reset form: `this.filterForm.reset()`
- Validate form: `this.filterForm.valid`

**RxJS Patterns** (from coding-standards.md):
- Use async pipe in templates to auto-unsubscribe: `<div *ngIf="tasks$ | async as tasks">`
- Avoid nested subscriptions—use switchMap/mergeMap for chained API calls
- Use takeUntil(destroy$) pattern for manual subscriptions
- Debounce filter changes if implementing real-time filtering (not required in AC, but nice-to-have)

**Routing Patterns** (from frontend-architecture.md):
- Read query params: `this.route.queryParams.pipe(take(1)).subscribe(params => ...)`
- Update query params: `this.router.navigate([], { queryParams: { page: 2, sortBy: 'dueDate' }, queryParamsHandling: 'merge' })`
- Preserve existing query params with queryParamsHandling: 'merge'

**Angular Material Patterns**:
- Use MatTable with MatSort directive for sorting
- Use MatPaginator for pagination
- Use MatSelect with `multiple` attribute for multi-select
- Use MatChipListbox for toggleable multi-select chips (Status, Priority, Type)
- Use MatDatepicker for date range pickers
- Use MatDialog for task edit/delete confirmation
- Use MatSnackBar for notifications

**Mobile Responsive Pattern**:
- Use CSS media queries: `@media (max-width: 768px) { ... }`
- Use MatExpansionPanel for collapsible filter panel on mobile
- Switch from MatTable to card-based layout on mobile (reuse task-card component)
- Test responsive behavior using browser DevTools mobile emulator

### Important Notes

**URL State Persistence (AC 11)**:
- Critical for shareable/bookmarkable URLs
- Parse query params on component init and apply to state
- Update query params whenever filter/sort/pagination changes
- Use Angular Router's queryParams and queryParamsHandling
- Example URL: `/tasks?status=InProgress&priority=High&sortBy=dueDate&sortOrder=desc&page=2&pageSize=50`

**Performance (AC 14)**:
- UI updates within 100ms: Use OnPush change detection on presentational components
- Minimize re-renders by using signals or ChangeDetectorRef.detach/reattach
- Avoid heavy computations in template bindings
- Use trackBy functions in *ngFor loops to optimize list rendering: `trackBy: trackByTaskId`

**Pagination State**:
- Backend uses 1-based page numbering (page=1 for first page)
- MatPaginator uses 0-based indexing (pageIndex=0 for first page)
- Convert between them: API page = pageIndex + 1; pageIndex = API page - 1
- Update page when filters change (reset to page 1)

**Filter State Management**:
- Store filter state in component: `filters: TaskFilters = {}`
- Apply filters on "Apply Filters" button click (not real-time to reduce API calls)
- Reset filters on "Clear Filters" button or chip removal
- Display active filters as chips with remove icons (MatChip with removable attribute)

**Multi-Select Implementation**:
- Assignee: MatSelect with `multiple` attribute, options populated from user list
- Status/Priority/Type: MatChipListbox with selectable chips (Material 3 pattern)
- Bind chip selection to form control: `[formControl]="filterForm.controls.status"`
- Handle array values in query params: convert to comma-separated string for URL, parse back to array

**Quick Actions Column**:
- Use MatIconButton for compact, icon-only actions
- Add matTooltip for accessibility: `matTooltip="Edit task"`
- Icons: edit (edit), delete (delete), timer (schedule), view (visibility)
- Emit events to parent container, let container handle logic (service calls, dialogs)

**Loading States**:
- Show mat-progress-bar at top of table during background refreshes
- Show mat-spinner in center during initial load
- Disable interaction during loading (button disabled states)

**Empty States**:
- No tasks at all: "No tasks yet. Create your first task!" with create button
- Filtered empty: "No tasks match your filters. Try adjusting your filters." with clear filters button
- Use EmptyStateComponent from shared folder for consistency

**Mobile Responsive Considerations**:
- Filters: Collapse into MatExpansionPanel or MatBottomSheet on mobile
- Table: Switch to card-based layout (reuse existing task-card component from Story 1.5)
- Pagination: Stack controls vertically, simplify labels
- Quick actions: Show as icon menu (MatMenu) instead of individual buttons

### Source Tree References

**Files to Modify**:
- `src/app/features/tasks/services/task.service.ts` (update getTasks method)
- `src/app/features/tasks/task-list/task-list.component.ts` (container logic)
- `src/app/features/tasks/task-list/task-list.component.html` (add filters + pagination)
- `src/app/features/tasks/task-list/task-list.component.scss` (layout and responsive styles)
- `src/app/features/tasks/task-list/components/task-table/task-table.component.ts` (add sorting + actions)
- `src/app/features/tasks/task-list/components/task-table/task-table.component.html` (update columns)
- `src/app/features/tasks/task-list/components/task-table/task-table.component.scss` (action buttons, hover)
- `src/app/shared/models/task.model.ts` (add TaskFilters, PaginatedResult interfaces)

**Files to Create**:
- `src/app/features/tasks/task-list/components/task-filters/task-filters.component.ts`
- `src/app/features/tasks/task-list/components/task-filters/task-filters.component.html`
- `src/app/features/tasks/task-list/components/task-filters/task-filters.component.scss`
- `src/app/features/tasks/task-list/components/task-filters/task-filters.component.spec.ts`

**Test Files to Create/Update**:
- `src/app/features/tasks/task-list/components/task-filters/task-filters.component.spec.ts` (new)
- `src/app/features/tasks/task-list/task-list.component.spec.ts` (update with new functionality)
- `src/app/features/tasks/task-list/components/task-table/task-table.component.spec.ts` (update with sorting tests)
- Playwright E2E test: `e2e/task-list-filtering.spec.ts` (new)

### Testing

#### Test File Location
- Unit tests: Same folder as component, filename: `*.component.spec.ts`
- E2E tests: `e2e/task-list-filtering.spec.ts`

#### Test Standards
- Use Jasmine + Karma for unit tests
- Use Playwright for E2E tests
- Name tests descriptively: `describe('MethodName', () => { it('should do something when condition', () => ...) })`
- Use AAA pattern: Arrange, Act, Assert
- Use Jasmine spies to mock services in unit tests
- Use TestBed.configureTestingModule for component testing
- Use async pipe and fixture.detectChanges() for component rendering tests

#### Testing Frameworks and Patterns

**Unit Tests (Jasmine + Karma):**
- Mock TaskService using Jasmine spies: `jasmine.createSpyObj('TaskService', ['getTasks'])`
- Mock ActivatedRoute for query params: `{ queryParams: of({ page: '2', sortBy: 'dueDate' }) }`
- Mock Router for navigation testing: `jasmine.createSpyObj('Router', ['navigate'])`
- Test component inputs/outputs: `component.tasks = mockTasks; fixture.detectChanges();`
- Test form interactions: `component.filterForm.setValue({ status: [TaskStatus.InProgress] }); component.onApplyFilters();`
- Use FluentAssertions-style assertions: `expect(result).toBeTruthy();`

**E2E Tests (Playwright):**
- Use Playwright selectors: `await page.locator('[data-testid="filter-status"]').click();`
- Test full user workflows: apply filter → verify results → navigate page → verify URL
- Use `await expect(page).toHaveURL(/status=InProgress/)` to verify URL state
- Take screenshots on failure: `await page.screenshot({ path: 'test-failure.png' })`
- Test mobile view using viewport: `await page.setViewportSize({ width: 375, height: 667 })`

#### Specific Testing Requirements

**Filter Testing**:
- Test each filter type individually (status, priority, type, assignee, date range)
- Test multiple filters combined (AND logic)
- Test clearing filters resets state
- Test active filter chips display correctly
- Test chip removal updates filters

**Sorting Testing**:
- Test sorting on each column (name, status, priority, dueDate, loggedTime)
- Test ascending and descending order
- Test sort indicator icon changes (arrow up/down)
- Test sorting persists in URL

**Pagination Testing**:
- Test page navigation (next, previous, specific page)
- Test page size change (25, 50, 100, 200)
- Test pagination persists in URL
- Test filtered count displays correctly

**URL Persistence Testing**:
- Test URL updates when state changes
- Test state restores from URL on page load
- Test shareable URLs (copy/paste into new browser tab)

**Mobile Responsive Testing**:
- Test filter panel collapses on mobile
- Test table switches to cards on mobile
- Test pagination controls stack on mobile
- Use Playwright viewport or Angular testing utilities for responsive testing

**Quick Actions Testing**:
- Test edit action opens task form dialog
- Test delete action opens confirmation dialog and deletes on confirm
- Test timer action starts timer
- Test view action navigates to task detail

**Performance Testing**:
- Verify UI updates within 100ms (use performance.now() in tests)
- Test with 200+ tasks to verify rendering performance
- Test pagination doesn't re-render entire list unnecessarily

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-04 | 0.1 | Initial story creation | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used
(To be populated by dev agent)

### Debug Log References
(To be populated by dev agent)

### Completion Notes
(To be populated by dev agent)

### File List
(To be populated by dev agent)

## QA Results

(To be populated by QA agent)
