# Story 3.7: Comment Thread UI

## Status

Approved

## Story

**As a** user,
**I want** to view and participate in comment threads on tasks,
**so that** I can collaborate with teammates asynchronously.

## Acceptance Criteria

1. Comment section added to task detail panel below task fields
2. Comment thread displays all comments chronologically (oldest first) with author avatar, name, timestamp
3. Edited comments show "(edited)" indicator next to timestamp
4. Comment compose box at bottom of thread with text area and "Post Comment" button
5. @mention autocomplete triggers when typing "@" followed by characters (searches users by name/email)
6. Selecting user from autocomplete inserts mention as "@Username" with special formatting (highlight, link)
7. Clicking mentioned username navigates to user profile or filters tasks to that user
8. Posted comment appears in thread immediately without full page reload
9. Edit button appears on user's own comments (pencil icon)
10. Clicking edit converts comment to editable text area with Save/Cancel buttons
11. Delete button appears on user's own comments (trash icon) with confirmation prompt
12. Deleted comments show as "[Comment deleted]" placeholder or removed entirely from thread
13. Comment count badge displayed on task list showing number of comments per task (e.g., "ğŸ’¬ 5")
14. Empty state displayed when task has no comments ("Be the first to comment")
15. Long comment threads scrollable within task detail panel
16. Mobile-friendly comment composition and reading

## Tasks / Subtasks

- [ ] **Task 1: Create Comment Model & DTOs** (AC: 2, 3, 8)
  - [ ] Create `src/app/shared/models/comment.model.ts`:
    - [ ] `CommentResponseDto` interface: `id` (string), `taskId` (string), `userId` (string), `authorName` (string), `authorProfileImageUrl` (string | null), `content` (string), `createdDate` (string), `modifiedDate` (string | null), `isEdited` (boolean), `isDeleted` (boolean), `mentionedUserIds` (string[])
    - [ ] `CommentCreateDto` interface: `content` (string), `mentionedUserIds?` (string[])
    - [ ] `CommentUpdateDto` interface: `content` (string)
  - [ ] Ensure interfaces align with backend `CommentResponseDto`, `CommentCreateDto`, `CommentUpdateDto` from Story 3.6

- [ ] **Task 2: Create Comment Service** (AC: 4, 8, 9, 10, 11, 12)
  - [ ] Create `src/app/features/collaboration/services/comment.service.ts`:
    - [ ] Inject `HttpClient` and use `environment.apiUrl`
    - [ ] Method: `getTaskComments(taskId: string): Observable<CommentResponseDto[]>` â€” GET `/api/tasks/{taskId}/comments`
    - [ ] Method: `createComment(taskId: string, dto: CommentCreateDto): Observable<CommentResponseDto>` â€” POST `/api/tasks/{taskId}/comments`
    - [ ] Method: `updateComment(commentId: string, dto: CommentUpdateDto): Observable<CommentResponseDto>` â€” PUT `/api/comments/{commentId}`
    - [ ] Method: `deleteComment(commentId: string): Observable<void>` â€” DELETE `/api/comments/{commentId}`
    - [ ] Private `handleError` method following existing service patterns (`task.service.ts`)
    - [ ] Decorate with `@Injectable({ providedIn: 'root' })`

- [ ] **Task 3: Create Comment Item Component** (AC: 2, 3, 6, 7, 9, 10, 11, 12)
  - [ ] Create `src/app/features/collaboration/comment-thread/components/comment-item/`:
    - [ ] `comment-item.component.ts` â€” Standalone presentational component
    - [ ] `comment-item.component.html` â€” Template
    - [ ] `comment-item.component.scss` â€” Styles
  - [ ] Component inputs:
    - [ ] `@Input() comment: CommentResponseDto` â€” The comment data
    - [ ] `@Input() currentUserId: string` â€” Logged-in user's ID (for own-comment actions)
  - [ ] Component outputs:
    - [ ] `@Output() edit = new EventEmitter<{ commentId: string, content: string }>()` â€” Emit when user saves edit
    - [ ] `@Output() delete = new EventEmitter<string>()` â€” Emit comment ID when user confirms delete
    - [ ] `@Output() mentionClick = new EventEmitter<string>()` â€” Emit user ID when @mention clicked
  - [ ] Display logic:
    - [ ] Author avatar (use initials fallback if `authorProfileImageUrl` is null): circular avatar with first letter of name
    - [ ] Author name (bold), relative timestamp using `RelativeTimePipe` (e.g., "2 hours ago")
    - [ ] "(edited)" indicator next to timestamp when `isEdited === true` (AC: 3)
    - [ ] Comment content text with @mentions highlighted (bold, colored, clickable)
    - [ ] Parse content for `@Username` patterns and render as clickable spans
  - [ ] Own-comment actions (visible only when `comment.userId === currentUserId`):
    - [ ] Edit button (pencil icon) â€” toggles `isEditing` state (AC: 9)
    - [ ] Delete button (trash icon) â€” opens confirmation dialog (AC: 11)
  - [ ] Edit mode (AC: 10):
    - [ ] Replace comment text with `<textarea>` pre-filled with current content
    - [ ] Save button and Cancel button below textarea
    - [ ] On Save: emit `edit` event with `{ commentId, content }`
    - [ ] On Cancel: revert to display mode
  - [ ] Deleted comment rendering (AC: 12):
    - [ ] If `comment.isDeleted === true`, display "[Comment deleted]" in italic gray text
    - [ ] Hide edit/delete actions for deleted comments
  - [ ] @mention click handler (AC: 7): emit `mentionClick` with mentioned userId

- [ ] **Task 4: Create Comment Form Component** (AC: 4, 5, 6, 8)
  - [ ] Create `src/app/features/collaboration/comment-thread/components/comment-form/`:
    - [ ] `comment-form.component.ts` â€” Standalone component
    - [ ] `comment-form.component.html` â€” Template
    - [ ] `comment-form.component.scss` â€” Styles
  - [ ] Component inputs:
    - [ ] `@Input() isSubmitting: boolean` â€” Disables form during API call
  - [ ] Component outputs:
    - [ ] `@Output() submitComment = new EventEmitter<{ content: string, mentionedUserIds: string[] }>()` â€” Emit when user posts comment
  - [ ] Comment text area:
    - [ ] Reactive form with `FormControl` for content (required, maxLength 2000)
    - [ ] Placeholder: "Write a comment..."
    - [ ] "Post Comment" button (mat-raised-button, primary color) â€” disabled when empty or submitting
    - [ ] Character count indicator (e.g., "1500/2000") when > 1500 chars
  - [ ] @mention autocomplete (AC: 5, 6):
    - [ ] Detect "@" character followed by typing in textarea
    - [ ] On "@" detection: inject `UserService`, call `searchUsers(query)` with debounce (300ms)
    - [ ] Display autocomplete dropdown overlay positioned near cursor/caret:
      - [ ] List matching users with avatar + name + email
      - [ ] Keyboard navigation (arrow keys + Enter to select)
      - [ ] Click to select user
    - [ ] On user selection: insert `@Username` into textarea at cursor position
    - [ ] Track selected mention user IDs in a local array for submission
    - [ ] Close dropdown when: user selects, presses Escape, clicks outside, or deletes "@"
  - [ ] On submit:
    - [ ] Extract `mentionedUserIds` from tracked mentions
    - [ ] Emit `submitComment` event with `{ content, mentionedUserIds }`
    - [ ] Clear textarea and mentions array after successful submit (parent handles success)

- [ ] **Task 5: Create Comment Thread Container Component** (AC: 1, 2, 8, 14, 15)
  - [ ] Create `src/app/features/collaboration/comment-thread/`:
    - [ ] `comment-thread.component.ts` â€” Standalone smart/container component
    - [ ] `comment-thread.component.html` â€” Template
    - [ ] `comment-thread.component.scss` â€” Styles
  - [ ] Component inputs:
    - [ ] `@Input() taskId: string` â€” Task whose comments to load
  - [ ] Component outputs:
    - [ ] `@Output() commentCountChange = new EventEmitter<number>()` â€” Emit count when comments loaded/changed
  - [ ] Service injection:
    - [ ] Inject `CommentService`, `AuthService`, `NotificationService`, `UserService`
  - [ ] State management:
    - [ ] `comments = signal<CommentResponseDto[]>([])` â€” Comment list
    - [ ] `isLoading = signal<boolean>(true)` â€” Loading state
    - [ ] `isSubmitting = signal<boolean>(false)` â€” Posting state
    - [ ] `currentUserId` from `AuthService.getCurrentUser()?.id`
  - [ ] Lifecycle:
    - [ ] `ngOnInit`: call `loadComments()`
    - [ ] `loadComments()`: call `commentService.getTaskComments(taskId)`, set comments signal, emit `commentCountChange`
  - [ ] Comment operations:
    - [ ] `onPostComment({ content, mentionedUserIds })`: call `commentService.createComment(taskId, { content, mentionedUserIds })`, on success prepend/append to comments array (AC: 8), show success notification, emit updated count
    - [ ] `onEditComment({ commentId, content })`: call `commentService.updateComment(commentId, { content })`, on success update comment in array, show success notification
    - [ ] `onDeleteComment(commentId)`: call `commentService.deleteComment(commentId)`, on success remove from array or update as deleted, show success notification, emit updated count
    - [ ] `onMentionClick(userId)`: navigate to task list filtered by assignee (or show user info toast)
  - [ ] Template structure:
    - [ ] Section header: "Comments" with mat-icon `comment` and comment count badge
    - [ ] Loading spinner while `isLoading()` is true
    - [ ] Empty state when `comments().length === 0`: "Be the first to comment" with mat-icon (AC: 14)
    - [ ] Scrollable comment list with `max-height` and `overflow-y: auto` (AC: 15)
    - [ ] `<app-comment-item>` for each comment, passing `currentUserId`
    - [ ] `<app-comment-form>` at bottom of thread
  - [ ] Error handling: show notification on API failures, don't remove optimistic updates

- [ ] **Task 6: Integrate Comment Thread into Task Detail Dialog** (AC: 1)
  - [ ] Modify `src/app/features/tasks/task-detail-dialog/task-detail-dialog.ts`:
    - [ ] Import `CommentThread` component
    - [ ] Add to `imports` array in `@Component` decorator
  - [ ] Modify `src/app/features/tasks/task-detail-dialog/task-detail-dialog.html`:
    - [ ] Add new section after "Time Log" section and before "Meta Info" section:
      ```
      <!-- Comments Section -->
      <section class="section-card">
        <app-comment-thread [taskId]="task().id"></app-comment-thread>
      </section>
      ```
  - [ ] Verify comment thread loads when task detail dialog opens
  - [ ] Verify comments are scoped to the correct task

- [ ] **Task 7: Add Comment Count Badge to Task List** (AC: 13)
  - [ ] Backend prerequisite check: verify if GET /api/tasks response already includes `commentCount` field
    - [ ] If not available: skip badge for now (requires backend change to add commentCount to TaskResponseDto) and document as follow-up
    - [ ] If available: proceed with badge implementation
  - [ ] Modify task table/card components in `src/app/features/tasks/task-list/components/`:
    - [ ] Add comment count badge (ğŸ’¬ icon + count) next to task name or in actions column
    - [ ] Only display badge when count > 0
    - [ ] Use `mat-icon` "comment" or "chat_bubble_outline" with count text
  - [ ] Style badge: small, subtle, consistent with existing chips/badges in the UI

- [ ] **Task 8: Create RelativeTime Pipe (if not exists)** (AC: 2)
  - [ ] Check if `src/app/shared/pipes/relative-time.pipe.ts` already exists
    - [ ] If exists: use it directly in comment-item component
    - [ ] If not: create standalone pipe:
      - [ ] Transform ISO date string to relative time: "just now", "2 minutes ago", "1 hour ago", "yesterday", "3 days ago", then fall back to absolute date for > 7 days
      - [ ] Handle null/undefined input gracefully
      - [ ] Export as standalone pipe for import in components

- [ ] **Task 9: Mobile Responsive Styles** (AC: 16)
  - [ ] Comment thread responsive design:
    - [ ] Stack elements vertically on small screens (< 600px)
    - [ ] Avatar size reduced on mobile (32px instead of 40px)
    - [ ] Full-width textarea on mobile
    - [ ] Touch-friendly action buttons (min 44px tap target)
    - [ ] Autocomplete dropdown positioned correctly on mobile keyboards
  - [ ] Test comment thread in task detail dialog at various breakpoints (320px, 375px, 768px, 1024px)

- [ ] **Task 10: Unit Tests â€” Comment Service** (AC: All)
  - [ ] Create `src/app/features/collaboration/services/comment.service.spec.ts`:
    - [ ] Test `getTaskComments` makes GET request to correct URL
    - [ ] Test `createComment` makes POST request with correct body
    - [ ] Test `updateComment` makes PUT request to correct URL with body
    - [ ] Test `deleteComment` makes DELETE request to correct URL
    - [ ] Test error handling for each method
    - [ ] Use `HttpClientTestingModule` and `HttpTestingController`

- [ ] **Task 11: Unit Tests â€” Comment Thread Component** (AC: All)
  - [ ] Create `src/app/features/collaboration/comment-thread/comment-thread.component.spec.ts`:
    - [ ] Test comments load on init
    - [ ] Test empty state displayed when no comments
    - [ ] Test comment list rendered with correct data
    - [ ] Test posting new comment adds to list
    - [ ] Test editing comment updates in list
    - [ ] Test deleting comment removes from list
    - [ ] Test loading state displayed during fetch
    - [ ] Mock `CommentService`, `AuthService`, `NotificationService`

- [ ] **Task 12: Unit Tests â€” Comment Item Component** (AC: 2, 3, 9, 10, 11, 12)
  - [ ] Create `src/app/features/collaboration/comment-thread/components/comment-item/comment-item.component.spec.ts`:
    - [ ] Test comment displays author name, content, timestamp
    - [ ] Test "(edited)" indicator shown when `isEdited` is true
    - [ ] Test edit/delete buttons only visible for own comments
    - [ ] Test edit mode toggles textarea
    - [ ] Test save edit emits event with new content
    - [ ] Test cancel edit reverts to display mode
    - [ ] Test delete emits event with comment ID
    - [ ] Test deleted comment shows "[Comment deleted]"
    - [ ] Test @mention rendering as highlighted text

- [ ] **Task 13: Unit Tests â€” Comment Form Component** (AC: 4, 5)
  - [ ] Create `src/app/features/collaboration/comment-thread/components/comment-form/comment-form.component.spec.ts`:
    - [ ] Test form validation (required content, max 2000 chars)
    - [ ] Test submit button disabled when empty
    - [ ] Test submit button disabled when `isSubmitting` is true
    - [ ] Test submit emits event with content and mentionedUserIds
    - [ ] Test textarea clears after successful submit signal
    - [ ] Test @mention autocomplete triggers on "@" input (optionalâ€”complex to test)

## Dev Notes

### Dependency on Story 3.6

Story 3.6 (Comments and Mentions Backend) must be complete before this story. The following backend API endpoints are required and were implemented in Story 3.6:

- `POST /api/tasks/{taskId}/comments` â€” Create comment (returns `CommentResponseDto`)
- `GET /api/tasks/{taskId}/comments` â€” Get all comments for a task (sorted chronologically)
- `PUT /api/comments/{commentId}` â€” Update comment (author only, returns `CommentResponseDto`)
- `DELETE /api/comments/{commentId}` â€” Soft delete (author only, returns 204)

### Backend CommentResponseDto Shape (from Story 3.6)

```json
{
  "id": "guid",
  "taskId": "guid",
  "userId": "guid",
  "authorName": "string",
  "authorProfileImageUrl": "string | null",
  "content": "string",
  "createdDate": "ISO datetime",
  "modifiedDate": "ISO datetime | null",
  "isEdited": true/false,
  "isDeleted": true/false,
  "mentionedUserIds": ["guid", ...]
}
```

### Existing Frontend Patterns to Follow

**Service Pattern** (reference: `src/app/features/tasks/services/task.service.ts`):
- Inject `HttpClient` via `inject(HttpClient)`
- Use `environment.apiUrl` for base URL
- Return `Observable<T>` from all methods
- Use `catchError(this.handleError)` for error handling
- Decorate with `@Injectable({ providedIn: 'root' })`

**Component Pattern** (reference: `src/app/features/tasks/task-detail-dialog/task-detail-dialog.ts`):
- Standalone components with explicit imports array
- Use Angular signals (`signal<T>()`) for component state
- Inject services via `inject()` function
- Use `Subject` + `takeUntil` for subscription cleanup
- Import Angular Material modules as needed (`MatButtonModule`, `MatIconModule`, etc.)

**Dialog Pattern** (reference: `task-detail-dialog.ts`):
- Task detail is a `MatDialog` component
- Uses `MAT_DIALOG_DATA` for input data
- Uses `signal<Task>()` for reactive state
- Sections rendered as `<section class="section-card">` blocks

**User Search** (reference: `src/app/core/services/user.service.ts`):
- `UserService.searchUsers(query)` â€” already exists, returns `Observable<User[]>`
- `UserService.getAllUsers()` â€” loads all users
- Use for @mention autocomplete (debounce input, call `searchUsers`)

**Notification Pattern** (reference: `src/app/core/services/notification.service.ts`):
- `NotificationService.showSuccess(message)` â€” success toast
- `NotificationService.showError(message)` â€” error toast

**Current User Access** (reference: `src/app/core/services/auth.service.ts`):
- `AuthService.getCurrentUser()` â€” returns `User | null` with `id`, `name`, `email`
- `AuthService.currentUser$` â€” observable for reactive access

### Relevant Source Tree

```
src/app/
â”œâ”€â”€ core/services/
â”‚   â”œâ”€â”€ auth.service.ts              â† getCurrentUser() for current user ID
â”‚   â”œâ”€â”€ user.service.ts              â† searchUsers() for @mention autocomplete
â”‚   â””â”€â”€ notification.service.ts      â† showSuccess/showError for toasts
â”œâ”€â”€ shared/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ comment.model.ts         â† CREATE: Comment interfaces/DTOs
â”‚   â”‚   â”œâ”€â”€ task.model.ts            â† Existing Task model (reference)
â”‚   â”‚   â””â”€â”€ user.model.ts            â† Existing User model (reference)
â”‚   â”œâ”€â”€ pipes/
â”‚   â”‚   â””â”€â”€ relative-time.pipe.ts    â† CREATE if not exists (for "2 hours ago")
â”‚   â””â”€â”€ components/
â”‚       â””â”€â”€ confirmation-dialog/     â† Reuse for delete confirmation
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ collaboration/               â† CREATE: New feature folder
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ comment.service.ts   â† CREATE: Comment API service
â”‚   â”‚   â””â”€â”€ comment-thread/
â”‚   â”‚       â”œâ”€â”€ comment-thread.component.ts/html/scss  â† CREATE: Container component
â”‚   â”‚       â””â”€â”€ components/
â”‚   â”‚           â”œâ”€â”€ comment-item/
â”‚   â”‚           â”‚   â””â”€â”€ comment-item.component.ts/html/scss  â† CREATE: Presentational
â”‚   â”‚           â””â”€â”€ comment-form/
â”‚   â”‚               â””â”€â”€ comment-form.component.ts/html/scss  â† CREATE: Form component
â”‚   â””â”€â”€ tasks/
â”‚       â””â”€â”€ task-detail-dialog/
â”‚           â”œâ”€â”€ task-detail-dialog.ts    â† MODIFY: Import & add comment thread
â”‚           â””â”€â”€ task-detail-dialog.html  â† MODIFY: Add comment section
```

### UI/UX Design Notes

- **Comment section placement**: Below "Time Log" section, before "Meta Info" section in task detail dialog
- **Avatar fallback**: Use first letter of `authorName` in a colored circle when `authorProfileImageUrl` is null (consistent with how assignee avatars are handled elsewhere)
- **Status colors**: Use Angular Material's color system â€” primary (blue) for actions, warn (red) for delete
- **@mention highlighting**: Bold + primary color text for mentioned usernames in comment content
- **Scrollable thread**: Set `max-height: 400px` on comment list container with `overflow-y: auto`
- **Confirmation dialog**: Reuse existing `ConfirmationDialogComponent` from `src/app/shared/components/confirmation-dialog/` for delete confirmation

### Testing

**Unit Test Location:** Tests co-located with components in respective directories (Angular convention)

**Testing Framework:** Jasmine + Karma (Angular default)

**Testing Standards:**
- Use `TestBed.configureTestingModule()` for component setup
- Use `HttpClientTestingModule` and `HttpTestingController` for service tests
- Mock services with `jasmine.createSpyObj` or manual mock classes
- Follow `describe('ComponentName') â†’ it('should ...')` naming
- Test both happy path and error cases
- Use `fixture.detectChanges()` to trigger change detection
- Use `fakeAsync()` + `tick()` for async operations
- Test @Input/@Output bindings for presentational components

**Test Commands:**
```
ng test                        # Run all frontend tests
ng test --include=**/comment*  # Run comment-related tests only
```

### Performance Considerations

- Debounce @mention search input by 300ms to avoid excessive API calls
- Use `OnPush` change detection strategy on presentational components (comment-item, comment-form)
- Avoid re-rendering entire thread when single comment edited â€” use `trackBy` with comment ID in `@for`
- Limit initial comment load (no pagination needed for MVP â€” most tasks will have < 50 comments)

## Change Log

| Date       | Version | Description        | Author |
|------------|---------|-------------------|--------|
| 2026-02-06 | 0.1     | Initial draft      | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)