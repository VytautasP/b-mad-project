<div class="task-list-container">
  <!-- Filters Component -->
  <app-task-filters
    [users]="users()"
    [initialFilters]="filters"
    (filtersChanged)="onFiltersChanged($event)"
    (filtersCleared)="onFiltersCleared()">
  </app-task-filters>

  <!-- Loading Bar -->
  @if (isLoading()) {
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  }

  <!-- Task Count -->
  <div class="task-count">
    Showing {{ tasks().length }} of {{ totalCount() }} tasks
  </div>

  @if (isLoading() && tasks().length === 0) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Loading tasks...</p>
    </div>
  } @else {
    <!-- Empty State -->
    @if (tasks().length === 0) {
      <div class="empty-state">
        @if (hasActiveFilters()) {
          <mat-icon>filter_list_off</mat-icon>
          <h2>No tasks match your filters</h2>
          <p>Try adjusting your filters to see more tasks</p>
          <button mat-raised-button color="primary" (click)="onFiltersCleared()">
            Clear Filters
          </button>
        } @else {
          <mat-icon>inbox</mat-icon>
          <h2>No tasks yet</h2>
          <p>Get started by creating your first task</p>
        }
      </div>
    } @else {
      <!-- Desktop view: Table with sorting -->
      <div class="desktop-view">
        <mat-table [dataSource]="tasks()" matSort (matSortChange)="onSortChange($event)" class="task-table">
          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Task Name</mat-header-cell>
            <mat-cell *matCellDef="let task">
              <div class="task-name" (click)="onViewDetails(task)" role="button" tabindex="0">
                <strong>{{ task.name }}</strong>
                @if (task.description) {
                  <small>{{ task.description }}</small>
                }
              </div>
            </mat-cell>
          </ng-container>

          <!-- Assignees Column -->
          <ng-container matColumnDef="assignees">
            <mat-header-cell *matHeaderCellDef>Assignees</mat-header-cell>
            <mat-cell *matCellDef="let task">
              <app-assignee-list 
                [assignees]="task.assignees || []"
                [maxVisible]="3"
                [showActions]="false">
              </app-assignee-list>
            </mat-cell>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Status</mat-header-cell>
            <mat-cell *matCellDef="let task">
              <div [class]="getStatusBadgeClass(task.status)">
                <mat-icon>{{ getStatusIcon(task.status) }}</mat-icon>
                <span>{{ getStatusLabel(task.status) }}</span>
              </div>
            </mat-cell>
          </ng-container>

          <!-- Priority Column -->
          <ng-container matColumnDef="priority">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Priority</mat-header-cell>
            <mat-cell *matCellDef="let task">
              <div class="priority-indicator" [ngClass]="getPriorityClass(task.priority)">
                <mat-icon>{{ getPriorityIcon(task.priority) }}</mat-icon>
                <span>{{ getPriorityLabel(task.priority) }}</span>
              </div>
            </mat-cell>
          </ng-container>

          <!-- Due Date Column -->
          <ng-container matColumnDef="dueDate">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Due Date</mat-header-cell>
            <mat-cell *matCellDef="let task">{{ formatDate(task.dueDate) }}</mat-cell>
          </ng-container>

          <!-- Time Logged Column -->
          <ng-container matColumnDef="timeLogged">
            <mat-header-cell *matHeaderCellDef mat-sort-header="totalLoggedMinutes">Time Logged</mat-header-cell>
            <mat-cell *matCellDef="let task">
              <div class="time-logged-cell" [matTooltip]="getTimeTooltip(task)">
                @if (task.childrenLoggedMinutes > 0) {
                  <mat-icon class="rollup-indicator" inline>schedule</mat-icon>
                }
                <span>{{ getTimeDisplay(task) }}</span>
              </div>
            </mat-cell>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
            <mat-cell *matCellDef="let task">
              <button mat-icon-button (click)="onViewDetails(task)" matTooltip="View details">
                <mat-icon>visibility</mat-icon>
              </button>
              @if (isTimerRunning(task.id)) {
                <mat-icon class="timer-running-icon" matTooltip="Timer Running" color="accent">timer</mat-icon>
              } @else {
                <button mat-icon-button 
                        (click)="onStartTimer(task)" 
                        matTooltip="Start Timer"
                        [disabled]="isAnotherTimerRunning(task.id)">
                  <mat-icon>schedule</mat-icon>
                </button>
              }
              <button mat-icon-button (click)="onEdit(task)" matTooltip="Edit task" color="primary">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button (click)="onDelete(task)" matTooltip="Delete task" color="warn">
                <mat-icon>delete</mat-icon>
              </button>
            </mat-cell>
          </ng-container>

          <mat-header-row *matHeaderRowDef="displayedColumns" class="task-header-row"></mat-header-row>
          <mat-row *matRowDef="let row; columns: displayedColumns;" class="task-row"></mat-row>
        </mat-table>

        <!-- Paginator -->
        <mat-paginator
          [length]="totalCount()"
          [pageSize]="pageSize"
          [pageSizeOptions]="[25, 50, 100, 200]"
          [pageIndex]="page - 1"
          (page)="onPageChange($event)"
          showFirstLastButtons>
        </mat-paginator>
      </div>

      <!-- Mobile view: Cards -->
      <div class="mobile-view">
        @for (task of tasks(); track task.id) {
          <mat-card class="task-card">
            <mat-card-header>
              <mat-card-title (click)="onViewDetails(task)" role="button">
                {{ task.name }}
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              @if (task.description) {
                <p class="task-description">{{ task.description }}</p>
              }
              <div class="task-details">
                <div class="detail-row">
                  <span class="label">Assignees:</span>
                  <app-assignee-list 
                    [assignees]="task.assignees || []"
                    [maxVisible]="2"
                    [showActions]="false">
                  </app-assignee-list>
                </div>
                <div class="detail-row">
                  <span class="label">Due Date:</span>
                  <span>{{ formatDate(task.dueDate) }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Time Logged:</span>
                  <span [matTooltip]="getTimeTooltip(task)">
                    @if (task.childrenLoggedMinutes > 0) {
                      <mat-icon inline class="rollup-indicator">schedule</mat-icon>
                    }
                    {{ getTimeDisplay(task) }}
                  </span>
                </div>
                <div class="detail-row">
                  <span class="label">Priority:</span>
                  <div class="priority-indicator" [ngClass]="getPriorityClass(task.priority)">
                    <mat-icon>{{ getPriorityIcon(task.priority) }}</mat-icon>
                    <span>{{ getPriorityLabel(task.priority) }}</span>
                  </div>
                </div>
                <div class="detail-row">
                  <span class="label">Status:</span>
                  <div [class]="getStatusBadgeClass(task.status)">
                    <mat-icon>{{ getStatusIcon(task.status) }}</mat-icon>
                    <span>{{ getStatusLabel(task.status) }}</span>
                  </div>
                </div>
              </div>
            </mat-card-content>
            <mat-card-actions>
              @if (isTimerRunning(task.id)) {
                <mat-icon class="timer-running-icon" matTooltip="Timer Running" color="accent">timer</mat-icon>
              } @else {
                <button mat-icon-button 
                        (click)="onStartTimer(task)" 
                        matTooltip="Start Timer"
                        [disabled]="isAnotherTimerRunning(task.id)">
                  <mat-icon>schedule</mat-icon>
                </button>
              }
              <button mat-icon-button (click)="onEdit(task)" matTooltip="Edit task" color="primary">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button (click)="onDelete(task)" matTooltip="Delete task" color="warn">
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        }

        <!-- Mobile Pagination -->
        <mat-paginator
          [length]="totalCount()"
          [pageSize]="pageSize"
          [pageSizeOptions]="[25, 50, 100]"
          [pageIndex]="page - 1"
          (page)="onPageChange($event)">
        </mat-paginator>
      </div>
    }
  }
</div>
