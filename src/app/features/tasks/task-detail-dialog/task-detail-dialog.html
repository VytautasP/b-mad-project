<div class="task-detail-dialog">
  <!-- Header -->
  <div mat-dialog-title class="dialog-header">
    <div class="header-left">
      <mat-icon class="header-icon">assignment</mat-icon>
      <h2>{{ task().name }}</h2>
    </div>
    <button mat-icon-button (click)="onClose()" class="close-button" matTooltip="Close">
      <mat-icon>close</mat-icon>
    </button>
  </div>
  
  <mat-dialog-content class="dialog-content">
    <!-- Task Properties -->
    <section class="task-properties">
      <div class="property-grid">
        <div class="property-item">
          <span class="property-label">Status</span>
          <mat-chip class="status-chip" [ngClass]="getStatusClass(task().status)">
            <mat-icon>{{ getStatusIcon(task().status) }}</mat-icon>
            <span>{{ getStatusLabel(task().status) }}</span>
          </mat-chip>
        </div>
        <div class="property-item">
          <span class="property-label">Priority</span>
          <mat-chip class="priority-chip">{{ getPriorityLabel(task().priority) }}</mat-chip>
        </div>
        <div class="property-item">
          <span class="property-label">Type</span>
          <span class="property-value">
            <mat-icon class="inline-icon">category</mat-icon>
            {{ getTypeLabel(task().type) }}
          </span>
        </div>
        <div class="property-item">
          <span class="property-label">Due Date</span>
          <span class="property-value">
            <mat-icon class="inline-icon">event</mat-icon>
            {{ formatDate(task().dueDate) }}
          </span>
        </div>
      </div>
      
      @if (task().description) {
        <div class="description-block">
          <span class="property-label">Description</span>
          <p class="description-text">{{ task().description }}</p>
        </div>
      }
    </section>
    
    <!-- Assignees Section -->
    <section class="section-card">
      <div class="section-header">
        <div class="section-title">
          <mat-icon>group</mat-icon>
          <h3>Assignees</h3>
        </div>
        <button mat-stroked-button 
                color="primary" 
                (click)="toggleUserPicker()"
                class="section-action-btn">
          <mat-icon>person_add</mat-icon>
          <span class="btn-label">Add</span>
        </button>
      </div>
      
      @if (isLoadingAssignees()) {
        <div class="loading-state">
          <mat-spinner diameter="28"></mat-spinner>
        </div>
      } @else {
        <div class="assignees-content">
          <app-assignee-list 
            [assignees]="assignees()"
            [maxVisible]="10"
            [showActions]="true"
            (removeAssignee)="onRemoveAssignee($event)">
          </app-assignee-list>
        </div>
        
        @if (showUserPicker()) {
          <div class="user-picker-container">
            <app-user-picker 
              [excludedUserIds]="getExcludedUserIds()"
              (userSelected)="onAddAssignee($event)">
            </app-user-picker>
          </div>
        }
      }
    </section>
    
    <!-- Time Summary Section -->
    <section class="section-card">
      <div class="section-header">
        <div class="section-title">
          <mat-icon>pie_chart</mat-icon>
          <h3>Time Summary</h3>
        </div>
      </div>
      
      @if (!hasChildrenTime() && task().totalLoggedMinutes === 0) {
        <div class="empty-section">
          <mat-icon>hourglass_empty</mat-icon>
          <span>No time logged yet</span>
        </div>
      } @else {
        <div class="time-summary-grid">
          <div class="time-stat">
            <span class="time-stat-label">Direct</span>
            <span class="time-stat-value">{{ formatDuration(task().directLoggedMinutes) }}</span>
          </div>
          @if (hasChildrenTime()) {
            <div class="time-stat">
              <span class="time-stat-label">Subtasks</span>
              <span class="time-stat-value">{{ formatDuration(task().childrenLoggedMinutes) }}</span>
            </div>
          }
          <div class="time-stat total">
            <span class="time-stat-label">Total</span>
            <span class="time-stat-value">{{ formatDuration(task().totalLoggedMinutes) }}</span>
          </div>
        </div>
      }
    </section>
    
    <!-- Time Log Section -->
    <section class="section-card">
      <div class="section-header">
        <div class="section-title">
          <mat-icon>schedule</mat-icon>
          <h3>Time Log</h3>
        </div>
        <button mat-stroked-button 
                color="primary" 
                (click)="onLogTime()"
                class="section-action-btn">
          <mat-icon>add</mat-icon>
          <span class="btn-label">Log Time</span>
        </button>
      </div>
      
      <app-time-entry-list 
        #timeEntryList
        [taskId]="task().id"
        (timeEntryDeleted)="onTimeEntryDeleted()">
      </app-time-entry-list>
    </section>
    
    <!-- Comments Section -->
    <section class="section-card">
      <app-comment-thread [taskId]="task().id" (activityChanged)="onCommentActivityChanged()"></app-comment-thread>
    </section>

    <!-- Activity Section -->
    <section class="section-card">
      <div class="section-header">
        <div class="section-title">
          <mat-icon>history</mat-icon>
          <h3>Activity</h3>
        </div>
      </div>
      <app-activity-log [taskId]="task().id" [refreshToken]="activityRefreshVersion"></app-activity-log>
    </section>
    
    <!-- Meta Info -->
    <section class="meta-section">
      <div class="meta-item">
        <mat-icon class="meta-icon">person</mat-icon>
        <span class="meta-text">Created by <strong>{{ task().createdByUserName }}</strong></span>
      </div>
      <div class="meta-item">
        <mat-icon class="meta-icon">calendar_today</mat-icon>
        <span class="meta-text">Created {{ task().createdDate | date:'mediumDate' }}</span>
      </div>
      <div class="meta-item">
        <mat-icon class="meta-icon">update</mat-icon>
        <span class="meta-text">Updated {{ task().modifiedDate | date:'mediumDate' }}</span>
      </div>
    </section>
  </mat-dialog-content>
  
  <mat-dialog-actions class="dialog-actions">
    <button mat-button (click)="onClose()" class="close-action">Close</button>
    <div class="action-spacer"></div>
    @if (isTimerRunning()) {
      <div class="timer-indicator" matTooltip="Timer is running for this task">
        <mat-icon class="timer-pulse">timer</mat-icon>
        <span>Timer Running</span>
      </div>
    } @else {
      <button mat-raised-button 
              color="primary"
              (click)="onStartTimer()" 
              [disabled]="isAnotherTimerRunning()">
        <mat-icon>play_circle</mat-icon>
        Start Timer
      </button>
    }
  </mat-dialog-actions>
</div>
