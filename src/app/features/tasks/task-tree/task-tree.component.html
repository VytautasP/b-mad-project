<div class="task-tree-container">
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading tasks...</p>
    </div>
  } @else if (dataSource.data.length === 0) {
    <div class="empty-state">
      <mat-icon class="empty-icon">inbox</mat-icon>
      <h3>No tasks yet</h3>
      <p>Create your first task to get started</p>
    </div>
  } @else {
    <div cdkDropListGroup class="drop-zone-container">
      <mat-tree [dataSource]="dataSource" [treeControl]="treeControl" class="task-tree">
        <mat-tree-node *matTreeNodeDef="let node" 
                       matTreeNodePadding>
          <div cdkDropList
               [cdkDropListData]="node"
               (cdkDropListDropped)="onDrop($event)"
               class="node-drop-zone">
            <div cdkDrag
                 [cdkDragData]="node"
                 (cdkDragStarted)="onDragStart($any($event), node)"
                 (cdkDragEnded)="onDragEnd()"
                 [class.dragging]="draggedNode && draggedNode.task.id === node.task.id"
                 class="node-drag-handle">
              <button mat-icon-button disabled aria-label="Drag handle"></button>
              <div class="tree-node-content"
                   [class.valid-drop-target]="isValidDropTarget(node) && dropTargetNode && dropTargetNode.task.id === node.task.id"
                   [class.invalid-drop-target]="!isValidDropTarget(node) && dropTargetNode && dropTargetNode.task.id === node.task.id"
                   [class.drop-target-active]="draggedNode && dropTargetNode && dropTargetNode.task.id === node.task.id">
                <mat-icon class="type-icon">{{ getTypeIcon(node.task.type) }}</mat-icon>
                <mat-icon class="status-icon" [ngClass]="getStatusClass(node.task.status)">
                  {{ getStatusIcon(node.task.status) }}
                </mat-icon>
                <span class="task-name" (click)="onTaskClick(node.task)" (keydown.enter)="onTaskClick(node.task)" (keydown.space)="onTaskClick(node.task)" role="button" tabindex="0">{{ node.task.name }}</span>
                <mat-icon class="priority-icon" [ngClass]="getPriorityClass(node.task.priority)">
                  {{ getPriorityIcon(node.task.priority) }}
                </mat-icon>
              </div>
            </div>
          </div>
        </mat-tree-node>

      <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild">
        <div cdkDropList
             [cdkDropListData]="node"
             (cdkDropListDropped)="onDrop($event)"
             class="node-drop-zone">
          <div cdkDrag
               [cdkDragData]="node"
               (cdkDragStarted)="onDragStart($any($event), node)"
               (cdkDragEnded)="onDragEnd()"
               [class.dragging]="draggedNode && draggedNode.task.id === node.task.id"
               class="node-drag-handle">
            <div class="mat-tree-node">
              <button mat-icon-button matTreeNodeToggle 
                      (click)="treeControl.isExpanded(node) ? onNodeCollapsed(node) : onNodeExpanded(node)"
                      [attr.aria-label]="'Toggle ' + node.task.name">
                <mat-icon class="mat-icon-rtl-mirror">
                  {{ treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right' }}
                </mat-icon>
              </button>
              <div class="tree-node-content"
                   [class.valid-drop-target]="isValidDropTarget(node) && dropTargetNode && dropTargetNode.task.id === node.task.id"
                   [class.invalid-drop-target]="!isValidDropTarget(node) && dropTargetNode && dropTargetNode.task.id === node.task.id"
                   [class.drop-target-active]="draggedNode && dropTargetNode && dropTargetNode.task.id === node.task.id">
                <mat-icon class="type-icon">{{ getTypeIcon(node.task.type) }}</mat-icon>
                <mat-icon class="status-icon" [ngClass]="getStatusClass(node.task.status)">
                  {{ getStatusIcon(node.task.status) }}
                </mat-icon>
                <span class="task-name" (click)="onTaskClick(node.task)" (keydown.enter)="onTaskClick(node.task)" (keydown.space)="onTaskClick(node.task)" role="button" tabindex="0">{{ node.task.name }}</span>
                <mat-icon class="priority-icon" [ngClass]="getPriorityClass(node.task.priority)">
                  {{ getPriorityIcon(node.task.priority) }}
                </mat-icon>
              </div>
            </div>
          </div>
        </div>
        <div [class.tree-invisible]="!treeControl.isExpanded(node)" role="group">
          <ng-container matTreeNodeOutlet></ng-container>
        </div>
      </mat-nested-tree-node>
    </mat-tree>
    </div>
  }
</div>
